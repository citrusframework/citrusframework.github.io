<!DOCTYPE HTML>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <title>Citrus Framework</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="generator" content="Citrus 3.3.0">
  <meta name="description" content="Citrus Framework Website"/>
  <meta name="author" content="ConSol Software GmbH"/>
  <link type="application/atom+xml" rel="alternate" href="http://0.0.0.0:4000/feed.xml" title="Citrus Integration Tests" />
  <link rel="alternate" type="application/atom+xml" title="Recent commits to Citrus master branch" href="https://github.com/citrusframework/citrus/commits/master.atom">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic,900">
  <link rel="stylesheet" href="/css/screen.css">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <!--[if lt IE 9]>
  <script src="/js/html5shiv.min.js"></script>
  <script src="/js/respond.min.js"></script>
  <![endif]-->
</head>


<body class="wrap">
  <header role="banner">
  <nav class="mobile-nav show-on-mobiles">
    <ul>
  <li>
    <img src="/img/brand-logo.png" alt="Citrus"><span class="brand hide-on-mobiles">Citrus</span>
  </li>
  <li class="">
    <a href="/">Home</a>
  </li>
  <li class="">
    <a href="/projects/">Projects</a>
  </li>
  <li class="">
    <a href="/docs/documentation/">Doc<span class="hide-on-mobiles">umentation</span><span class="show-on-mobiles">s</span></a>
  </li>
  <li class="">
    <a href="/samples/">Samples</a>
  </li>
  <li class="current">
    <a href="/news/">News<span class="hide-on-mobiles"> &amp; Blog</span></a>
  </li>
  <li class="">
    <a href="/help/">Help</a>
  </li>
  <li>
    <a href="https://github.com/citrusframework/citrus" target="_blank"><span class="hide-on-mobiles">View on </span>GitHub</a>
  </li>
</ul>

  </nav>
  <div class="grid">
    <nav class="main-nav whole hide-on-mobiles">
      <ul>
  <li>
    <img src="/img/brand-logo.png" alt="Citrus"><span class="brand hide-on-mobiles">Citrus</span>
  </li>
  <li class="">
    <a href="/">Home</a>
  </li>
  <li class="">
    <a href="/projects/">Projects</a>
  </li>
  <li class="">
    <a href="/docs/documentation/">Doc<span class="hide-on-mobiles">umentation</span><span class="show-on-mobiles">s</span></a>
  </li>
  <li class="">
    <a href="/samples/">Samples</a>
  </li>
  <li class="current">
    <a href="/news/">News<span class="hide-on-mobiles"> &amp; Blog</span></a>
  </li>
  <li class="">
    <a href="/help/">Help</a>
  </li>
  <li>
    <a href="https://github.com/citrusframework/citrus" target="_blank"><span class="hide-on-mobiles">View on </span>GitHub</a>
  </li>
</ul>

    </nav>
  </div>
</header>


    <section class="news">
    <div class="grid">

      <div class="docs-nav-mobile unit whole show-on-mobiles">
  <select onchange="if (this.value) window.location.href=this.value">
    <option value="">Navigate the blog…</option>
    <option value="/news/">News</option>
    <option value="/docs/history/">Releases</option>
    <optgroup label="Posts">
      
      <option value="/news/2021/08/30/introducing-yaks/">Cloud-native BDD testing with YAKS</option>
      
      <option value="/news/2021/08/25/new-camel-support/">Apache Camel support in Citrus 3</option>
      
      <option value="/news/2021/08/16/citrus-3.0/">YAY, Citrus 3.0 is here!</option>
      
      <option value="/news/2018/09/19/upcoming-changes/">Upcoming changes - What the future holds for Citrus</option>
      
      <option value="/news/2017/09/21/introducing-citrus-simulator/">Simulating 3rd party services with Spring Boot and Citrus</option>
      
      <option value="/news/2017/07/07/introducing-citrus-admin/">Introducing Citrus Admin Web UI</option>
      
      <option value="/news/2016/03/15/jcache-chat-citrus/">Testing WebSockets with a Citrus twist</option>
      
      <option value="/news/2015/08/19/arquillian-extension-part-2/">Arquillian &amp; Citrus in combination - Part 2</option>
      
      <option value="/news/2015/06/29/arquillian-extension-part-1/">Arquillian &amp; Citrus in combination - Part 1</option>
      
      <option value="/news/2015/06/03/camel-testing-part-3/">Apache Camel Integration Testing - Part 3</option>
      
      <option value="/news/2015/05/27/camel-testing-part-2/">Apache Camel Integration Testing - Part 2</option>
      
      <option value="/news/2014/11/21/camel-testing-part-1/">Apache Camel Integration Testing - Part 1</option>
      
      <option value="/news/2014/05/30/testing-webmethods-with-citrus-part-ii/">Testing webMethods with Citrus Part II</option>
      
      <option value="/news/2014/03/06/testing-webmethods-with-citrus-part-i/">Testing webMethods with Citrus Part I</option>
      
      <option value="/news/2011/06/22/excel-validation/">Validate Excel files in Citrus</option>
      
      <option value="/news/2011/06/17/testng-data-provider/">Use TestNG data providers in Citrus</option>
      
      <option value="/news/2010/12/14/integrate-your-own-validator/">Integrate your own validator into your Citrus project</option>
      
      <option value="/news/2010/08/13/testng-groups/">Citrus and TestNG groups</option>
      
      <option value="/news/2010/05/19/soap-mustunderstand/">Handle SOAP-ENV:mustUnderstand headers</option>
      
      <option value="/news/2010/01/18/custom-meta-info/">Customize meta information</option>
      
    </optgroup>
  </select>
</div>


      <div class="unit four-fifths">
        
  <article>
  <h2>
    Cloud-native BDD testing with YAKS
    <a href="/news/2021/08/30/introducing-yaks/" class="permalink" title="Permalink">∞</a>
  </h2>
  <span class="post-category">
    <span class="label">
      blog
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      30 Aug 2021
    </span>
    <a href="https://github.com/christophd" class="post-author">
      
      Christoph Deppisch
    </a>
  </div>
  <div class="post-content">
    <p>YAKS is a testing platform that leverages Behavior Driven Development concepts for running tests on Cloud-native infrastructure.</p>

<h1 id="what-is-yaks">What is “YAKS”?</h1>

<p>YAKS is an Open Source test automation platform to run your tests as Cloud-native resources on <a href="https://kubernetes.io/">Kubernetes</a> or <a href="https://www.openshift.com/">OpenShift</a>. 
This means the testing tool runs your tests natively on Kubernetes and is specifically designed to verify Serverless and Microservice applications. 
A typical YAKS test uses the very same infrastructure as the System under test and exchanges data/events over different 
messaging transports (e.g. Http REST, Knative eventing, Kafka, JMS and many more).</p>

<p>The tests in YAKS follow the BDD (Behavior Driven Development) concepts, so you declare <a href="https://cucumber.io/docs/gherkin/reference/">Gherkin</a> (Given-When-Then syntax) 
feature files and run those directly as Pod in your cluster.</p>

<p>YAKS leverages the Operator SDK and provides a specific operator to manage the test case resources on the cluster. 
Each time you declare a test in the form of a <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">custom resource</a> the YAKS operator automatically takes care of preparing the 
proper runtime in order to execute the test as a Kubernetes Pod. 
The runtime uses a Java virtual machine runtime with Maven and leverages <a href="https://cucumber.io/">Cucumber</a> and <a href="https://citrusframework.org">Citrus</a> to run the tests.</p>

<p>YAKS as a framework brings a set of ready-to-use <a href="https://cucumber.io/">Cucumber steps</a> so you can just start writing your feature files to verify your deployed services.</p>

<h1 id="why-would-you-want-cloud-native-testing">Why would you want Cloud-native testing?</h1>

<p>Why would you want to run tests as Cloud-native resources on the Kubernetes platform? 
Kubernetes has become a standard target platform for Serverless and Microservices architectures. 
Developing the services is different in many aspects compared to what we have done for decades.</p>

<p>Writing a Serverless or Microservices application for instance with <a href="https://camel.apache.org/projects/camel-k/">Camel K</a> is very declarative. 
As a developer you write a Camel route and run this route as an integration via the Camel K operator directly on the cluster.</p>

<p>The declarative approach as well as the nature of Serverless applications make us rely on a given runtime infrastructure, and it is quite hard to run tests outside that infrastructure. 
So it is only natural to also move the verifying tests into this very same infrastructure. 
This is why YAKS brings your tests to the cloud infrastructure for integration and end-to-end testing.</p>

<p>Let us have a look at a sample Camel K integration. 
The integration provides a Http service and transforms incoming requests to messages sent to a Kafka topic.</p>

<p><em>Camel K sample: http-to-kafka.groovy</em></p>
<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// expose a rest endpoint that routes transformed messages to Kafka</span>
<span class="n">rest</span><span class="o">().</span><span class="na">post</span><span class="o">(</span><span class="s2">"/greeting"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">route</span><span class="o">()</span>
    <span class="o">.</span><span class="na">transform</span><span class="o">()...</span> <span class="c1">// any kind of transformation</span>
    <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="s2">"kafka:greetings"</span><span class="o">)</span>
</code></pre></div></div>

<p>Once you have written the Camel route you are ready to run the Camel K integration source within the Kubernetes infrastructure. 
It is only natural to also move the verifying tests into this very same infrastructure because you can make use of the very same messaging transports, 
databases and services (internal and external) provided in that infrastructure.</p>

<p>The tests are able to simulate 3rd party services or other microservices that are part of the message processing logic. 
The BDD tests describe the given context, the events to occur and the expected outcome all in one single feature file. 
This declarative testing approach is a perfect match to the concept of operators and custom resources on Kubernetes that 
is being used in so many Cloud-native services these days.</p>

<h1 id="how-does-it-work">How does it work?</h1>

<p>YAKS provides a Kubernetes operator and a set of CRDs (custom resources) that we need to install in the cluster. 
The best way to install YAKS is to use the <a href="https://operatorhub.io/operator/yaks">OperatorHub</a> or the yaks CLI tools that you can download from the <a href="https://github.com/citrusframework/yaks/releases">GitHub release pages</a>.</p>

<p>With the yaks-client binary simply run this install command:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>yaks <span class="nb">install</span>
</code></pre></div></div>

<p>This command prepares your Kubernetes cluster for running tests with YAKS. 
It will take care of installing the YAKS custom resource definitions, setting up role permissions and creating the YAKS operator in a global operator namespace.</p>

<p><em>Important:</em> You need to be a cluster admin to install custom resource definitions. 
The operation needs to be done only once for the entire cluster.</p>

<p>Now that the YAKS operator is up and running you can just start writing a Gherkin BDD feature file and run the test. 
YAKS brings a set of ready-to-use <a href="https://cucumber.io/">Cucumber steps</a> that you can use in the feature files.</p>

<p><em>File: http-to-kafka.feature</em></p>
<div class="language-gherkin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">Feature</span><span class="p">:</span> Http to Kafka

  <span class="kn">Background</span><span class="p">:</span>
    <span class="err">Given URL</span><span class="p">:</span> <span class="err">http</span><span class="p">:</span><span class="err">//greeting-service-demo.svc</span>
    <span class="nf">Given </span>Kafka connection
    <span class="p">|</span> <span class="nv">url</span>   <span class="p">|</span> <span class="nv">kafka-bootstrap.server.svc:9092</span> <span class="p">|</span>
    <span class="p">|</span> <span class="n">topic</span> <span class="p">|</span> <span class="n">greetings</span>                               <span class="p">|</span>
    
  <span class="kn">Scenario</span><span class="p">:</span> Post greeting event
    <span class="err">Given HTTP request body</span><span class="p">:</span> <span class="err">Hello</span> <span class="err">YAKS!</span>
    <span class="nf">When </span>send POST /greeting
    <span class="nf">Then </span>receive HTTP 201 CREATED
    <span class="err">And verify Kafka message with body</span><span class="p">:</span> <span class="err">Hello</span> <span class="err">YAKS!</span>
</code></pre></div></div>

<p>The feature above verifies the Camel K integration to send greeting events to a Kafka topic. 
The test calls the Camel K integration with a Http POST request. 
The request invokes the service and verifies the <em>Http 201 CREATED</em> response code. 
Also, the test verifies the Kafka message on the <em>greeting topic</em> and compares the message content to an expected template.</p>

<p>The whole test uses the ready-to-use YAKS steps for handling Http and Kafka communication. 
So the tester does not have to implement this messaging transport logic.</p>

<p>You can run the test with:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>yaks run http-to-kafka.feature
</code></pre></div></div>

<p>This creates a new test custom resource with the given BDD feature file. 
The YAKS operator automatically executes the test as a Pod on the cluster. 
You can review the test log output and see if the test passes.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>yaks run greeting-http-to-kafka.feature
    
<span class="o">[</span>...] 

<span class="o">[</span>INFO]
<span class="o">[</span>INFO] CITRUS TEST RESULTS
<span class="o">[</span>INFO]
<span class="o">[</span>INFO]  http-to-kafka.feature:6 .................. SUCCESS
<span class="o">[</span>INFO] 
<span class="o">[</span>INFO] TOTAL:	1
<span class="o">[</span>INFO] FAILED:	0 <span class="o">(</span>0.0%<span class="o">)</span>
<span class="o">[</span>INFO] SUCCESS:	1 <span class="o">(</span>100.0%<span class="o">)</span>
<span class="o">[</span>INFO] 
<span class="o">[</span>INFO] <span class="nt">------------------------------------------------------------------------</span>
<span class="o">[</span>INFO] Generated <span class="nb">test </span>report: target/citrus-reports/citrus-test-results.html

1 Scenarios <span class="o">(</span>1 passed<span class="o">)</span>
2 Steps <span class="o">(</span>2 passed<span class="o">)</span>
0m1.711s

<span class="o">[</span>INFO] Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 3.274 s - <span class="k">in </span>org.citrusframework.yaks.YaksTest
<span class="o">[</span>INFO] 
<span class="o">[</span>INFO] Results:
<span class="o">[</span>INFO] 
<span class="o">[</span>INFO] Tests run: 1, Failures: 0, Errors: 0, Skipped: 0
<span class="o">[</span>INFO] 
<span class="o">[</span>INFO] <span class="nt">------------------------------------------------------------------------</span>
<span class="o">[</span>INFO] BUILD SUCCESS
<span class="o">[</span>INFO] <span class="nt">------------------------------------------------------------------------</span>
<span class="o">[</span>INFO] Total <span class="nb">time</span>: 6.453 s
<span class="o">[</span>INFO] Finished at: 2020-03-06T15:30:53Z
<span class="o">[</span>INFO] <span class="nt">------------------------------------------------------------------------</span>
Test result: Passed
</code></pre></div></div>

<p>You can also review the Pod test outcome with:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get tests
</code></pre></div></div>

<p>This is an example output you should get:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME             PHASE
http-to-kafka    Passed
</code></pre></div></div>

<p>So, what happens behind the scenes when running this test on Kubernetes?</p>

<p><img src="/img/assets/yaks-architecture.png" alt="yaks-architecture.png"></p>

<p>The <strong>yaks</strong> tool synchronizes your test code with a Kubernetes custom resource of Kind Test. 
The resource is named <code class="highlighter-rouge">http-to-kafka</code> (after the file name) in the current namespace. 
So every time you run the test the custom resource is updated and executed.</p>

<p>The YAKS operator is the component that makes all this possible by configuring all Kubernetes resources needed for running your tests. 
The test runtime uses Cucumber and Citrus to read the feature files and run the tests in a Java virtual machine.</p>

<p>Now let’s have a look at the predefined YAKS step implementations that you can use out of the box.</p>

<h1 id="yaks-test-steps">YAKS test steps</h1>

<p>YAKS provides several ready-to-use <a href="https://cucumber.io/">Cucumber steps</a> that you can just use in your feature files. 
These steps should help you to verify applications that exchange data over various messaging transports. 
Have a look at the predefined steps we have so far:</p>

<table>
  <thead>
    <tr>
      <th>Module</th>
      <th style="text-align: center">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>yaks-standard</td>
      <td style="text-align: center">Basic steps (e.g. for logging messages to the console, test delays, settings)</td>
    </tr>
    <tr>
      <td>yaks-http</td>
      <td style="text-align: center">Call Http REST endpoints as a client and verify the response content. Provide a Http service that receives/verifies requests and simulates response messages.</td>
    </tr>
    <tr>
      <td>yaks-openapi</td>
      <td style="text-align: center">Import OpenAPI specifications and use defined operations and test data to call Http REST endpoints</td>
    </tr>
    <tr>
      <td>yaks-jdbc</td>
      <td style="text-align: center">Connect to a database for updating data or verifying SQL query result sets</td>
    </tr>
    <tr>
      <td>yaks-camel</td>
      <td style="text-align: center">Create, start and stop <a href="https://camel.apache.org/">Apache Camel</a> routes as part of the test. This opens access to all <strong>300+</strong> Camel components for testing!</td>
    </tr>
    <tr>
      <td>yaks-camel-k</td>
      <td style="text-align: center">Create and verify Camel K integrations as part of the test.</td>
    </tr>
    <tr>
      <td>yaks-kafka</td>
      <td style="text-align: center">Publish/consume events on Kafka streams</td>
    </tr>
    <tr>
      <td>yaks-knative</td>
      <td style="text-align: center">Connect with Knative eventing and leverage triggers, channels, subscriptions to exchange cloud events.</td>
    </tr>
    <tr>
      <td>yaks-kubernetes</td>
      <td style="text-align: center">Apply resources on the Kubernetes cluster and provide services with exposed ports service simulation.</td>
    </tr>
    <tr>
      <td>yaks-jms</td>
      <td style="text-align: center">Publish/consume messages on a JMS broker.</td>
    </tr>
    <tr>
      <td>yaks-selenium</td>
      <td style="text-align: center">Run UI tests with a Selenium remote browser simulating user interaction on a web frontend.</td>
    </tr>
  </tbody>
</table>

<p>The list of ready-to-use steps is constantly growing, and you can also write your own steps and use them in a YAKS test! 
Have a look at the <a href="https://github.com/citrusframework/yaks/tree/master/examples">examples</a> to see all those steps in action.</p>

<p>The steps provided in YAKS are implemented using the integration test framework <a href="https://citrusframework.org/">Citrus</a>. 
This means that you can use features like functions, validation matchers and test variables in your test.</p>

<h1 id="demo">Demo</h1>

<p>The following demo video shows an example of what you can do with YAKS. 
It has the YAKS operator already installed and invokes a system under test via Http verifying the response content. 
It continues to more complex scenarios where the test uses a Swagger OpenAPI specification for generating requests and test data.</p>

<p><a href="https://www.youtube.com/embed/fR-UgzvZkuA">https://www.youtube.com/embed/fR-UgzvZkuA</a></p>

<h1 id="whats-next">What’s next</h1>

<p>This is just the start of a new testing platform for BDD testing in Cloud-native environments! 
We are happy to receive feedback, ideas and of course contributions. 
Please add your thoughts on the GitHub repository by opening <a href="https://github.com/citrusframework/yaks/issues">new issues</a> 
or even share your appreciation with a <a href="https://github.com/citrusframework/yaks">star</a> on GitHub.</p>

  </div>
</article>


  <article>
  <h2>
    Apache Camel support in Citrus 3
    <a href="/news/2021/08/25/new-camel-support/" class="permalink" title="Permalink">∞</a>
  </h2>
  <span class="post-category">
    <span class="label">
      blog
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      25 Aug 2021
    </span>
    <a href="https://github.com/christophd" class="post-author">
      
      Christoph Deppisch
    </a>
  </div>
  <div class="post-content">
    <p>Citrus 3 provides enhanced support for <a href="https://camel.apache.org">Apache Camel</a> with new features and improvements.
This enables great opportunities and leverages the full enterprise integration power of Apache Camel in Citrus.</p>

<p>Before this post explains the enhancements in Citrus 3 regarding Camel let us have a brief look at what has always been in the box.</p>

<h1 id="recap-the-camel-support-in-citrus">Recap the Camel support in Citrus</h1>

<p>Camel has been integrated with the Citrus framework for years. 
You can read about it in the official Citrus <a href="https://citrusframework.org/citrus/reference/3.0.0/html/index.html#apache-camel">user guide</a>.</p>

<p>With Camel included in the box Citrus users are able to use the 300+ Camel components in order to connect with various 
message transports and technologies.</p>

<p>Citrus is able to interact with Camel in following areas</p>

<ul>
  <li><a href="https://github.com/citrusframework/citrus/blob/main/src/manual/endpoint-camel.adoc#camel-route-actions">Create/start/stop Camel routes</a></li>
  <li><a href="https://github.com/citrusframework/citrus/blob/main/src/manual/endpoint-camel.adoc#camel-endpoint">Send/receive data to/from Camel routes</a></li>
  <li><a href="https://github.com/citrusframework/citrus/blob/main/src/manual/endpoint-component.adoc">Use Camel endpoint URI to produce messages via Camel endpoint components</a></li>
  <li><a href="https://github.com/citrusframework/citrus/blob/main/src/manual/endpoint-camel.adoc#camel-controlbus-actions">Access the Camel control bus</a></li>
  <li><a href="https://github.com/citrusframework/citrus/blob/main/src/manual/endpoint-camel.adoc#camel-exception-handling">Verify Camel exception handling</a></li>
</ul>

<p>Usually Camel routes live in a Camel context defined in the Citrus project.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">CamelContext</span> <span class="nf">camelContext</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">CamelContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultCamelContext</span><span class="o">();</span>

    <span class="n">context</span><span class="o">.</span><span class="na">addRoutes</span><span class="o">(</span><span class="k">new</span> <span class="n">RouteBuilder</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
            <span class="n">from</span><span class="o">(</span><span class="s">"direct:hello"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">routeId</span><span class="o">(</span><span class="s">"helloRoute"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="s">"log:com.consol.citrus.camel?level=INFO"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="s">"seda:greetings"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">});</span>

    <span class="k">return</span> <span class="n">context</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The context defines a Camel route listening on the endpoint uri <code class="highlighter-rouge">direct:hello</code>.
Incoming messages will be logged to the console using a <code class="highlighter-rouge">log</code> Camel component.
After that the message is forwarded to a <code class="highlighter-rouge">seda</code> Camel component which is a simple queue in memory.</p>

<p>The Citrus endpoint can interact with this sample route definition sending messages to the <code class="highlighter-rouge">direct:hello</code> endpoint.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">send</span><span class="o">(</span><span class="s">"camel:direct:hello"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">message</span><span class="o">()</span>
    <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"Hello from Citrus!"</span><span class="o">);</span>
</code></pre></div></div>

<p>The Camel endpoint uri can refer to any Camel endpoint component.
See the list of available <a href="https://camel.apache.org/components/latest/index.html">Camel components</a> in order to connect 
your route with message transports and technologies.</p>

<p>As an alternative to sending messages directly to a Camel endpoint uri you can create a Citrus endpoint that interacts with a Camel route. 
The endpoint can be shared in multiple tests and defines several properties such as the endpoint uri that will be called.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">CamelEndpoint</span> <span class="nf">helloCamelEndpoint</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">CamelEndpoint</span><span class="o">()</span>
            <span class="o">.</span><span class="na">endpointUri</span><span class="o">(</span><span class="s">"direct:hello"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">send</span><span class="o">(</span><span class="n">helloCamelEndpoint</span><span class="o">)</span>
    <span class="o">.</span><span class="na">message</span><span class="o">()</span>
    <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"Hello from Citrus!"</span><span class="o">);</span>
</code></pre></div></div>

<p>Of course, you can also consume messages from a Camel route using the endpoint pattern.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">receive</span><span class="o">(</span><span class="s">"camel:seda:greetings"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">message</span><span class="o">()</span>
    <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
    <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"Hello from Citrus!"</span><span class="o">);</span>
</code></pre></div></div>

<p>The Camel support in Citrus has been enhanced with Citrus 3. 
Read the following sections to find out about awesome new features and improvements.</p>

<h1 id="whats-new-in-citrus-3">What’s new in Citrus 3?</h1>

<h2 id="endpoint-dsl-support">Endpoint DSL support</h2>

<p>Since Camel 3 you can use a Java fluent API to deal with Camel endpoint URIs. 
You can use the Camel endpoint DSL in the Citrus send/receive actions now, too.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">send</span><span class="o">(</span><span class="n">camel</span><span class="o">().</span><span class="na">endpoint</span><span class="o">(</span><span class="n">direct</span><span class="o">(</span><span class="s">"hello"</span><span class="o">)::</span><span class="n">getUri</span><span class="o">))</span>
    <span class="o">.</span><span class="na">message</span><span class="o">()</span>
    <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"Hello from Citrus!"</span><span class="o">);</span>

<span class="n">receive</span><span class="o">(</span><span class="n">camel</span><span class="o">().</span><span class="na">endpoint</span><span class="o">(</span><span class="n">seda</span><span class="o">(</span><span class="s">"greetings"</span><span class="o">)::</span><span class="n">getUri</span><span class="o">)</span><span class="s">")
    .message()
    .type(MessageType.PLAINTEXT)
    .body("</span><span class="n">Hello</span> <span class="n">from</span> <span class="n">Citrus</span><span class="o">!</span><span class="err">"</span><span class="o">);</span>
</code></pre></div></div>

<p>The send and receive actions above use the Camel endpoint DSL to construct the proper endpoint URI.
The <code class="highlighter-rouge">camel().endpoint(seda("test")::getUri)</code> builds the endpoint uri <code class="highlighter-rouge">seda:test</code>.
The endpoint DSL provides all settings and properties that you can set for a Camel endpoint component.</p>

<h2 id="camel-processor-support">Camel processor support</h2>

<p>Camel implements the concept of processors as enterprise integration pattern.
A processor is able to add custom logic to a Camel route.
Each processor is able to access the Camel exchange that is being processed in the current route.
The processor is able to change the message content (body, headers) as well as the exchange information.</p>

<p>The send/receive operations in Citrus also implement the processor concept.
With the Citrus Camel support you can now use the very same Camel processor also in a Citrus test action.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.consol.citrus.camel.message.CamelMessageProcessor</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CamelMessageProcessorIT</span> <span class="kd">extends</span> <span class="n">TestNGCitrusSpringSupport</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">CamelContext</span> <span class="n">camelContext</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="nd">@CitrusTest</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldProcessMessages</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">CamelMessageProcessor</span><span class="o">.</span><span class="na">Builder</span> <span class="n">toUppercase</span> <span class="o">=</span> <span class="n">camel</span><span class="o">(</span><span class="n">camelContext</span><span class="o">)</span>
                <span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="n">exchange</span> <span class="o">-&gt;</span> <span class="n">exchange</span>
                        <span class="o">.</span><span class="na">getMessage</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">setBody</span><span class="o">(</span><span class="n">exchange</span><span class="o">.</span><span class="na">getMessage</span><span class="o">().</span><span class="na">getBody</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">toUpperCase</span><span class="o">()));</span>

        <span class="err">$</span><span class="o">(</span><span class="n">send</span><span class="o">(</span><span class="n">camel</span><span class="o">().</span><span class="na">endpoint</span><span class="o">(</span><span class="n">seda</span><span class="o">(</span><span class="s">"test"</span><span class="o">)::</span><span class="n">getUri</span><span class="o">))</span>
                <span class="o">.</span><span class="na">message</span><span class="o">()</span>
                <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"Citrus rocks!"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="n">toUppercase</span><span class="o">)</span>
        <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The example above uses a Camel processor to change the exchange and the message content before the message is sent to the endpoint.
This way you can apply custom changes to the message as part of the test action.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CamelMessageProcessorIT</span> <span class="kd">extends</span> <span class="n">TestNGCitrusSpringSupport</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">CamelContext</span> <span class="n">camelContext</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="nd">@CitrusTest</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldProcessMessages</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">CamelMessageProcessor</span><span class="o">.</span><span class="na">Builder</span> <span class="n">toUppercase</span> <span class="o">=</span> <span class="n">camel</span><span class="o">(</span><span class="n">camelContext</span><span class="o">)</span>
                <span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="n">exchange</span> <span class="o">-&gt;</span> <span class="n">exchange</span>
                        <span class="o">.</span><span class="na">getMessage</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">setBody</span><span class="o">(</span><span class="n">exchange</span><span class="o">.</span><span class="na">getMessage</span><span class="o">().</span><span class="na">getBody</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">toUpperCase</span><span class="o">()));</span>
        
        <span class="err">$</span><span class="o">(</span><span class="n">send</span><span class="o">(</span><span class="n">camel</span><span class="o">().</span><span class="na">endpoint</span><span class="o">(</span><span class="n">seda</span><span class="o">(</span><span class="s">"test"</span><span class="o">)::</span><span class="n">getUri</span><span class="o">))</span>
                <span class="o">.</span><span class="na">message</span><span class="o">()</span>
                <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"Citrus rocks!"</span><span class="o">));</span>

        <span class="err">$</span><span class="o">(</span><span class="n">receive</span><span class="o">(</span><span class="n">camel</span><span class="o">().</span><span class="na">endpoint</span><span class="o">(</span><span class="n">seda</span><span class="o">(</span><span class="s">"test"</span><span class="o">)::</span><span class="n">getUri</span><span class="o">))</span>
                <span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="n">toUppercase</span><span class="o">)</span>
                <span class="o">.</span><span class="na">message</span><span class="o">()</span>
                <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
                <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"CITRUS ROCKS!"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The Camel processors are very powerful.
In particular, you can apply transformations of multiple kind.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CamelTransformIT</span> <span class="kd">extends</span> <span class="n">TestNGCitrusSpringSupport</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">CamelContext</span> <span class="n">camelContext</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="nd">@CitrusTest</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldTransformMessageReceived</span><span class="o">()</span> <span class="o">{</span>
        <span class="err">$</span><span class="o">(</span><span class="n">send</span><span class="o">(</span><span class="n">camel</span><span class="o">().</span><span class="na">endpoint</span><span class="o">(</span><span class="n">seda</span><span class="o">(</span><span class="s">"hello"</span><span class="o">)::</span><span class="n">getUri</span><span class="o">))</span>
                <span class="o">.</span><span class="na">message</span><span class="o">()</span>
                <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"{\"message\": \"Citrus rocks!\"}"</span><span class="o">)</span>
        <span class="o">);</span>

        <span class="err">$</span><span class="o">(</span><span class="n">receive</span><span class="o">(</span><span class="n">camel</span><span class="o">().</span><span class="na">endpoint</span><span class="o">(</span><span class="n">seda</span><span class="o">(</span><span class="s">"hello"</span><span class="o">)::</span><span class="n">getUri</span><span class="o">))</span>
                <span class="o">.</span><span class="na">transform</span><span class="o">(</span>
                    <span class="n">camel</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">camelContext</span><span class="o">(</span><span class="n">camelContext</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">transform</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">jsonpath</span><span class="o">(</span><span class="s">"$.message"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">message</span><span class="o">()</span>
                <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
                <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"Citrus rocks!"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The transform pattern is able to change the message content before a message is received/sent in Citrus.
The example above applies a JsonPath expression as part of the message processing.
The JsonPath expression evaluates <code class="highlighter-rouge">$.message</code> on the Json payload and saves the result as new message body content.
The following message validation expects the plaintext value <code class="highlighter-rouge">Citrus rocks!</code>.</p>

<p>The message processor is also able to apply a complete route logic as part of the test action.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CamelRouteProcessorIT</span> <span class="kd">extends</span> <span class="n">TestNGCitrusSpringSupport</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">CamelContext</span> <span class="n">camelContext</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="nd">@CitrusTest</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldProcessRoute</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">CamelRouteProcessor</span><span class="o">.</span><span class="na">Builder</span> <span class="n">beforeReceive</span> <span class="o">=</span> <span class="n">camel</span><span class="o">(</span><span class="n">camelContext</span><span class="o">).</span><span class="na">route</span><span class="o">(</span><span class="n">route</span> <span class="o">-&gt;</span>
                <span class="n">route</span><span class="o">.</span><span class="na">choice</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="n">jsonpath</span><span class="o">(</span><span class="s">"$.greeting[?(@.language == 'EN')]"</span><span class="o">))</span>
                        <span class="o">.</span><span class="na">setBody</span><span class="o">(</span><span class="n">constant</span><span class="o">(</span><span class="s">"Hello!"</span><span class="o">))</span>
                    <span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="n">jsonpath</span><span class="o">(</span><span class="s">"$.greeting[?(@.language == 'DE')]"</span><span class="o">))</span>
                        <span class="o">.</span><span class="na">setBody</span><span class="o">(</span><span class="n">constant</span><span class="o">(</span><span class="s">"Hallo!"</span><span class="o">))</span>
                    <span class="o">.</span><span class="na">otherwise</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">setBody</span><span class="o">(</span><span class="n">constant</span><span class="o">(</span><span class="s">"Hi!"</span><span class="o">)));</span>

        <span class="err">$</span><span class="o">(</span><span class="n">send</span><span class="o">(</span><span class="n">camel</span><span class="o">().</span><span class="na">endpoint</span><span class="o">(</span><span class="n">seda</span><span class="o">(</span><span class="s">"greetings"</span><span class="o">)::</span><span class="n">getUri</span><span class="o">))</span>
                <span class="o">.</span><span class="na">message</span><span class="o">()</span>
                <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"{"</span> <span class="o">+</span>
                        <span class="s">"\"greeting\": {"</span> <span class="o">+</span>
                            <span class="s">"\"language\": \"EN\""</span> <span class="o">+</span>
                        <span class="s">"}"</span> <span class="o">+</span>
                      <span class="s">"}"</span><span class="o">)</span>
        <span class="o">);</span>

        <span class="err">$</span><span class="o">(</span><span class="n">receive</span><span class="o">(</span><span class="s">"camel:"</span> <span class="o">+</span> <span class="n">camel</span><span class="o">().</span><span class="na">endpoints</span><span class="o">().</span><span class="na">seda</span><span class="o">(</span><span class="s">"greetings"</span><span class="o">).</span><span class="na">getUri</span><span class="o">())</span>
                <span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="n">beforeReceive</span><span class="o">)</span>
                <span class="o">.</span><span class="na">message</span><span class="o">()</span>
                <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
                <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"Hello!"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>With the complete route logic you have the full power of Camel ready to be used in your send/receive test action.
This enables many capabilities as Camel implements the enterprise integration patterns such as split, choice, enrich and many more.</p>

<h2 id="camel-data-format-support">Camel data format support</h2>

<p>Camel uses the concept of data format to transform message content in form of marshal/unmarshal operations.
You can use the data formats supported in Camel in Citrus, too.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CamelDataFormatIT</span> <span class="kd">extends</span> <span class="n">TestNGCitrusSpringSupport</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">CamelContext</span> <span class="n">camelContext</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="nd">@CitrusTest</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldApplyDataFormat</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">when</span><span class="o">(</span><span class="n">send</span><span class="o">(</span><span class="n">camel</span><span class="o">().</span><span class="na">endpoint</span><span class="o">(</span><span class="n">seda</span><span class="o">(</span><span class="s">"data"</span><span class="o">)::</span><span class="n">getUri</span><span class="o">))</span>
                <span class="o">.</span><span class="na">message</span><span class="o">()</span>
                <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"Citrus rocks!"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">camel</span><span class="o">(</span><span class="n">camelContext</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">marshal</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">base64</span><span class="o">())</span>
        <span class="o">);</span>

        <span class="n">then</span><span class="o">(</span><span class="n">receive</span><span class="o">(</span><span class="s">"camel:"</span> <span class="o">+</span> <span class="n">camel</span><span class="o">().</span><span class="na">endpoints</span><span class="o">().</span><span class="na">seda</span><span class="o">(</span><span class="s">"data"</span><span class="o">).</span><span class="na">getUri</span><span class="o">())</span>
                <span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">camel</span><span class="o">(</span><span class="n">camelContext</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">unmarshal</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">base64</span><span class="o">())</span>
                <span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">camel</span><span class="o">(</span><span class="n">camelContext</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">convertBodyTo</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>
                <span class="o">.</span><span class="na">message</span><span class="o">()</span>
                <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
                <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"Citrus rocks!"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The example above uses the <code class="highlighter-rouge">base64</code> data format provided in Camel to marshal/unmarshal the message content to/from a base64 encoded String.
Camel provides support for many data formats as you can see in the <a href="https://camel.apache.org/components/latest/dataformats/index.html">documentation on data formats</a>.</p>

<h2 id="wrap-up">Wrap up!</h2>

<p>That completes the new features in Citrus 3 regarding Apache Camel.</p>

<p>Please give it a try, provide some feedback and tell us what you think about Camel and Citrus!</p>

  </div>
</article>


  <article>
  <h2>
    YAY, Citrus 3.0 is here!
    <a href="/news/2021/08/16/citrus-3.0/" class="permalink" title="Permalink">∞</a>
  </h2>
  <span class="post-category">
    <span class="label">
      blog
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      16 Aug 2021
    </span>
    <a href="https://github.com/christophd" class="post-author">
      
      Christoph Deppisch
    </a>
  </div>
  <div class="post-content">
    <p>YAY, Citrus 3.0 is here! A few weeks ago we have released a new major release for the Citrus integration testing framework! 
This is a huge step in the Citrus project! It has been over two years since the last release 2.8.0 and the journey towards 
3.0 has been a tremendous challenge. Citrus is back and stronger than ever before!</p>

<p>This summary is here to share our strategy, ideas and all major changes that are part of Citrus 3.0!</p>

<h1 id="objectives">Objectives</h1>

<p>Citrus 3.0 is a major release, and we want to take that as an opportunity to follow up with some improvements and refactoring that we are eager to do for quite some time. 
That being said we try to comply with everybody’s need to migrate from older versions. 
People coming from Citrus 2.x should have a look at the <a href="https://github.com/citrusframework/citrus/wiki/Citrus-2.x-migration-guide">2.x migration guide</a>. 
In addition to that we take extra care to keep breaking changes on a low-level.</p>

<p>Here are the main objectives we have in Citrus 3.0</p>

<ul>
  <li><a href="#modularize-citrus">Modularize Citrus</a></li>
  <li><a href="#java-dsl">Improved Java DSL</a></li>
  <li><a href="#make-spring-optional">Make Spring optional</a></li>
  <li>
<a href="#update-dependencies">Update dependencies</a> to new major versions (Cucumber, Apache Camel, Spring Framework, …)</li>
</ul>

<h2 id="modularize-citrus">Modularize Citrus</h2>

<p>The <code class="highlighter-rouge">citrus-core</code> module is the heart of the framework and contains all capabilities that Citrus has to offer. 
So if you include <code class="highlighter-rouge">citrus-core</code> as a dependency in your project you will load a lot of artifacts as transitive dependencies (e.g. from Maven central). 
Loading that huge amount of libraries is not a good thing especially when you do not need all features provided by Citrus (e.g. Groovy script support, Xhtml, XML validation and so on).</p>

<p>With <code class="highlighter-rouge">citrus-core</code> it is all or nothing. So we are keen to modularize the core module into several smaller pieces. 
The user can then choose which of the Citrus modules and features to include into the project or even overwrite and substitute certain pieces with own implementations.</p>

<h3 id="module-categories-and-structure">Module categories and structure</h3>

<p>In Citrus 3.0 we end up with following module categories:</p>

<ul>
  <li>
    <p><a href="https://github.com/citrusframework/citrus/tree/master/core">Core modules</a></p>

    <p>API and base implementations of core Citrus features. There will be a separate <code class="highlighter-rouge">citrus-base</code> and <code class="highlighter-rouge">citrus-spring</code> module where latter encapsulates the Spring Framework support in Citrus (more about that in <a href="#make-spring-optional">make Spring optional</a>).</p>

    <table>
      <thead>
        <tr>
          <th>Module</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>citrus-api</td>
          <td>Interfaces, enums, constants</td>
        </tr>
        <tr>
          <td>citrus-base</td>
          <td>Default implementation of <code class="highlighter-rouge">citrus-api</code>
</td>
        </tr>
        <tr>
          <td>citrus-spring</td>
          <td>Adds Spring Framework support to <code class="highlighter-rouge">citrus-base</code> (Bean definition parsers, Application context configuration, Autowiring in factory beans</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p><a href="https://github.com/citrusframework/citrus/tree/master/runtime">Runtime modules</a></p>

    <p>Test execution modules such as JUnit, TestNG and Cucumber representing different ways to run Citrus tests.</p>

    <table>
      <thead>
        <tr>
          <th>Module</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>citrus-cucumber</td>
          <td>Run Citrus tests as Cucumber BDD feature files</td>
        </tr>
        <tr>
          <td>citrus-testng</td>
          <td>Run tests via TestNG unit test framework</td>
        </tr>
        <tr>
          <td>citrus-junit</td>
          <td>Run tests via JUnit4 unit test framework</td>
        </tr>
        <tr>
          <td>citrus-junit5</td>
          <td>Run tests via JUnit5 unit test framework</td>
        </tr>
        <tr>
          <td>citrus-main</td>
          <td>Run tests via Java main CLI</td>
        </tr>
        <tr>
          <td>citrus-groovy</td>
          <td>Run Citrus tests as Groovy scripts (to be continued …)</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p><a href="https://github.com/citrusframework/citrus/tree/master/endpoints">Endpoint modules</a></p>

    <p>Endpoints connect Citrus to a message transport like Apache Kafka, JMS, Http REST, Ftp, Mail and many more. Each endpoint may provide producer/consumer or client/server components to exchange message content over the respective transport.</p>

    <table>
      <thead>
        <tr>
          <th>Module</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>citrus-camel</td>
          <td>Interact with Apache Camel context, routes and control bus</td>
        </tr>
        <tr>
          <td>citrus-ftp</td>
          <td>Connect to and simulate FTP/SFTP servers</td>
        </tr>
        <tr>
          <td>citrus-http</td>
          <td>Http REST support</td>
        </tr>
        <tr>
          <td>citrus-jdbc</td>
          <td>Simulate JDBC drivers, connections and transactions</td>
        </tr>
        <tr>
          <td>citrus-jms</td>
          <td>Publish/consume messages on a JMS message broker</td>
        </tr>
        <tr>
          <td>citrus-kafka</td>
          <td>Exchange data via Kafka messaging</td>
        </tr>
        <tr>
          <td>citrus-jmx</td>
          <td>Call MBean operations and simulate MBeans</td>
        </tr>
        <tr>
          <td>citrus-mail</td>
          <td>Client and server side SMTP mail support</td>
        </tr>
        <tr>
          <td>citrus-rmi</td>
          <td>Call RMI via JNDI registry lookup and simulate RMI services</td>
        </tr>
        <tr>
          <td>citrus-ssh</td>
          <td>Connect to servers via SSH and simulate SSH servers</td>
        </tr>
        <tr>
          <td>citrus-vertx</td>
          <td>Exchange messages on the Vert.x event bus</td>
        </tr>
        <tr>
          <td>citrus-websocket</td>
          <td>Websocket support</td>
        </tr>
        <tr>
          <td>citrus-ws</td>
          <td>SOAP WebServices support including SOAP envelope handling, WSDL, WS-Security, …</td>
        </tr>
        <tr>
          <td>citrus-zookeeper</td>
          <td>Connect with Zookeeper servers</td>
        </tr>
        <tr>
          <td>citrus-spring-integration</td>
          <td>Exchange messages on Spring Integration message channels</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p><a href="https://github.com/citrusframework/citrus/tree/master/validation">Validation modules</a></p>

    <p>When Citrus receives messages the test case is eager to verify the message content. Validation modules implement message validators and mechanisms to validate different data formats such as Json, XML, plaintext, binary content and so on. Some validation modules also add support for verification tools such as Groovy script validation, Hamcrest and AssertJ.</p>

    <table>
      <thead>
        <tr>
          <th>Module</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>citrus-validation-xml</td>
          <td>XML, Xpath and Xhtml message validation</td>
        </tr>
        <tr>
          <td>citrus-validation-json</td>
          <td>Json and JsonPath message validation</td>
        </tr>
        <tr>
          <td>citrus-validation-text</td>
          <td>Plain text message validation</td>
        </tr>
        <tr>
          <td>citrus-validation-binary</td>
          <td>Validate binary message content using input streams or <code class="highlighter-rouge">base64</code> encoding</td>
        </tr>
        <tr>
          <td>citrus-validation-groovy</td>
          <td>Adds Groovy script validation for XML, Json, SQL result set</td>
        </tr>
        <tr>
          <td>citrus-validation-hamcrest</td>
          <td>Hamcrest matcher support like <code class="highlighter-rouge">assertThat(oneOf(is(foo), is(foobar)))</code>
</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p><a href="https://github.com/citrusframework/citrus/tree/master/connectors">Connector modules</a></p>

    <p>Connectors are similar to endpoints yet these components connect Citrus to a foreign technology or framework rather than implementing a message transport. Connectors typically provide a client side only implementation that enable Citrus to interact with a service or framework (e.g. Docker, Kubernetes, Selenium web driver).</p>

    <table>
      <thead>
        <tr>
          <th>Module</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>citrus-sql</td>
          <td>Connect with a relational database</td>
        </tr>
        <tr>
          <td>citrus-docker</td>
          <td>Connect with Docker deamon to manage images and containers</td>
        </tr>
        <tr>
          <td>citrus-selenium</td>
          <td>Connect with web driver to run web-based UI tests</td>
        </tr>
        <tr>
          <td>citrus-kubernetes</td>
          <td>Connect to Kubernetes cluster managing PODs services and other resources</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p><a href="https://github.com/citrusframework/citrus/tree/master/tools">Tools</a></p>

    <p>Tooling is important and the modules in this category provide little helpers and plugins for different use cases where the usage of Citrus needs to be simplified (e.g. Maven plugins, test generators, etc.)</p>

    <table>
      <thead>
        <tr>
          <th>Module</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>citrus-restdocs</td>
          <td>Auto generate request/response documentation for Http REST and SOAP communication</td>
        </tr>
        <tr>
          <td>citrus-maven-plugin</td>
          <td>Maven plugins to create tests</td>
        </tr>
        <tr>
          <td>citrus-archetypes</td>
          <td>Maven archetypes for project code generation</td>
        </tr>
        <tr>
          <td>citrus-test-generator</td>
          <td>Create and auto generate test cases (e.g. from Swagger OpenAPI specifications)</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p><a href="https://github.com/citrusframework/citrus/tree/master/catalog">Catalog modules</a></p>

    <p>A catalog in Citrus combines several other modules into a set of modules that usually get used together. The <code class="highlighter-rouge">citrus-core</code> module for instance combines all available validation modules, runtimes and the Citrus Spring support into a single artifact. So the user just needs to add <code class="highlighter-rouge">citrus-core</code> to the project and can use everything Citrus has to offer (exactly like Citrus 2.x is doing).</p>

    <table>
      <thead>
        <tr>
          <th>Module</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>citrus-bom</td>
          <td>Bill of material holding all modules for imports</td>
        </tr>
        <tr>
          <td>citrus-core</td>
          <td>Default Citrus capabilities (validation, runtime, Spring support) combined into one single module (exactly the same what you have had with previous versions)</td>
        </tr>
        <tr>
          <td>citrus-endpoint-catalog</td>
          <td>Combine all endpoints to a single source for endpoint builders</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p><a href="https://github.com/citrusframework/citrus/tree/master/vintage">Vintage modules</a></p>

    <p>We are about to take a major step in Citrus and this implies some backward incompatibilities that <em>“vintage”</em> modules try to solve for users that still need to stick with an older version of Citrus for some reason. With these <em>“vintage”</em> modules you can still run older test cases with the new Citrus 3.x code base.</p>

    <table>
      <thead>
        <tr>
          <th>Module</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>citrus-java-dsl</td>
          <td>Old Java DSL implementation (designer vs. runner) to be used for Citrus 2.x Java DSL tests</td>
        </tr>
        <tr>
          <td>citrus-arquillian</td>
          <td>Arquillian runtime for Citrus</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p><a href="https://github.com/citrusframework/citrus/tree/master/utils">Utility modules</a></p>

    <p>Module in the utility category provide tooling for internal usage only. For instance this is a shared test library that is used in unit testing by several other modules. The modules are only used when building the Citrus modules. Utility modules usually are not included in a release so they won’t be pushed to Maven central.</p>

    <table>
      <thead>
        <tr>
          <th>Module</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>citrus-test-support</td>
          <td>Internal helper library added as test scoped dependency for unit testing in other modules. Holds shared unit testing helpers.</td>
        </tr>
      </tbody>
    </table>
  </li>
</ul>

<h3 id="how-to-use-the-new-module-structure">How to use the new module structure</h3>

<p>Users that do not want to change much in their project regarding the dependency setup just continue to add <code class="highlighter-rouge">citrus-core</code> dependency.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.consol.citrus<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>citrus-core<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.1.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>This will get you the same capabilities as in Citrus 2.x with all validation modules, runtime and Spring support enabled. The <code class="highlighter-rouge">citrus-core</code> is a catalog module combining several other modules that get automatically added to your project.</p>

<p>The downside of this approach is that you get a lot of features and transitive dependencies that you might not need in your project. Fortunately you can exclude some features from <code class="highlighter-rouge">citrus-core</code> with the new module structure in 3.x.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.consol.citrus<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>citrus-core<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.1.0<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;exclusions&gt;</span>
    <span class="nt">&lt;exclusion&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>com.consol.citrus<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>citrus-validation-groovy<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/exclusion&gt;</span>
    <span class="nt">&lt;exclusion&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>com.consol.citrus<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>citrus-testng<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/exclusion&gt;</span>
  <span class="nt">&lt;/exclusions&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>The example above excludes the Groovy validation capabilities and the TestNG runtime from the project. 
The features will not be added to your project and fewer artifacts get downloaded.</p>

<p>Of course there is a lot more to exclude and you might end up having a more complicated configuration for all those exclusions. 
For people trying to operate with just what they need in their project the pull approach might be the way to go. Here you add just <code class="highlighter-rouge">citrus-base</code> as dependency.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.consol.citrus<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>citrus-base<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.1.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>If you want to use Spring Framework support you may also add:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.consol.citrus<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>citrus-spring<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.1.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>With the new modular setup in Citrus not every feature is enabled by default. 
As you write and execute tests in your project you might then run into errors because you are using a Citrus feature 
that has not yet been added to your project. Something like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FAILURE: Caused by: NoSuchValidationMatcherException: Can not find validation matcher "assertThat" in library citrusValidationMatcherLibrary ()
	at com/consol/citrus/jms/integration/JmsTopicDurableSubscriberIT(iterate:26-48)
</code></pre></div></div>

<p>The error indicates that you need to add the Hamcrest validation matcher feature to the project. 
You can do so by adding the respective module dependency in your project:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.consol.citrus<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>citrus-validation-hamcrest<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.1.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>The awesomeness about it is that you can add your favorite matcher implementation as a dependency 
(we still need to add AssertJ support in Citrus, so we would love a contribution doing that!).</p>

<h3 id="what-happened-to-citrus--model-modules">What happened to citrus-*-model modules?</h3>

<p>Each module in former Citrus versions has had a little brother that generated model classes from XSD schema files.
The XSD schemas are used for custom Spring bean definition parsing and were located in the <code class="highlighter-rouge">citrus-*-model</code> modules (e.g. citrus-config.xsd).
The initial idea behind that separate model module was to separate model classes from implementations in order to use that model in a user interface called <code class="highlighter-rouge">citrus-admin</code>.
With Citrus 3.x we included the XSD schemas into the implementation modules so we do not have to maintain all the <code class="highlighter-rouge">citrus-*-model</code> modules separately (also one less artifact to load, <em>excellent</em>).</p>

<h2 id="java-dsl">Java DSL</h2>

<p>Citrus provides a Java domain specific language to write integration tests with a fluent API. 
The API makes use of the fluent builder pattern to specify test actions.</p>

<p>In Citrus 2.x all Java DSL related test action builders were located in a separate module called <code class="highlighter-rouge">citrus-java-dsl</code>. 
For better maintainability and modularization reasons the test action builders have moved into the individual modules 
where the test action implementation is located. 
In fact the Java DSL builders are now inner classes of the respective test action.</p>

<p>In former releases users had to choose between the two different approaches to write Java DSL tests with this fluent API:</p>

<ul>
  <li><a href="https://citrusframework.org/citrus/reference/2.8.0/html/index.html#java-dsl-test-designer">Test Designer</a></li>
  <li>
<a href="https://citrusframework.org/citrus/reference/2.8.0/html/index.html#java-dsl-test-runner">Test Runner</a>.</li>
</ul>

<p>Just like many things in life both approaches have had individual advantages and downsides. 
We have accepted the challenge to combine both approaches designer and runner into a single approach that combines the 
advantages and minimizes downsides.</p>

<p>In Citrus 3.x we end up using a simplified Java DSL that uses the look and feel of the former designer API but executes 
each step immediately to keep debugging options and the capability to add custom code between steps.</p>

<p>The separation between designer and runner has been removed completely. So there is only one single source of truth the 
<code class="highlighter-rouge">TestCaseRunner</code> and the fluent Java API for writing tests in Citrus. 
This simplifies the implementation in other modules (Cucumber, TestNG, JUnit) a lot.</p>

<p>This is how a new Java DSL test looks like in Citrus 3.x:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloServiceIT</span> <span class="kd">extends</span> <span class="n">TestNGCitrusSpringSupport</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">HttpClient</span> <span class="n">httpClient</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">KafkaEndpoint</span> <span class="n">orderEvents</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="nd">@CitrusTest</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">given</span><span class="o">(</span><span class="n">variable</span><span class="o">(</span><span class="s">"orderId"</span><span class="o">,</span> <span class="mi">1000</span><span class="o">));</span>

        <span class="n">when</span><span class="o">(</span><span class="n">http</span><span class="o">().</span><span class="na">client</span><span class="o">(</span><span class="n">httpClient</span><span class="o">)</span>
                <span class="o">.</span><span class="na">send</span><span class="o">()</span>
                <span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="s">"/orders"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">contentType</span><span class="o">(</span><span class="n">APPLICATION_FORM_URLENCODED</span><span class="o">)</span>
                <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"order=${orderId}&amp;name=foo"</span><span class="o">));</span>

        <span class="n">then</span><span class="o">(</span><span class="n">receive</span><span class="o">(</span><span class="n">orderEvents</span><span class="o">)</span>
                <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"Order ${orderId} has been placed"</span><span class="o">));</span>

        <span class="n">and</span><span class="o">(</span><span class="n">http</span><span class="o">().</span><span class="na">client</span><span class="o">(</span><span class="n">httpClient</span><span class="o">)</span>
                <span class="o">.</span><span class="na">receive</span><span class="o">()</span>
                <span class="o">.</span><span class="na">response</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The test extends <code class="highlighter-rouge">TestNGCitrusSpringSupport</code>. 
This gives you the annotation support for <code class="highlighter-rouge">@CitrusTest</code> so the test is added to the Citrus test reporting. 
The base class also gives you the test action execution methods <code class="highlighter-rouge">given()</code>, <code class="highlighter-rouge">when()</code>, <code class="highlighter-rouge">then()</code> and <code class="highlighter-rouge">and()</code>. 
This relates to the BDD Gherkin language and is widely known to a lot of people out there. 
If you do not want to use this BDD approach in your test you can also use the basic <code class="highlighter-rouge">run()</code> method or its shortcut version <code class="highlighter-rouge">$()</code>instead.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span><span class="o">(</span><span class="n">http</span><span class="o">().</span><span class="na">client</span><span class="o">(</span><span class="n">httpClient</span><span class="o">)</span>
        <span class="o">.</span><span class="na">send</span><span class="o">()</span>
        <span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="s">"/orders"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">contentType</span><span class="o">(</span><span class="n">APPLICATION_FORM_URLENCODED</span><span class="o">)</span>
        <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"order=${orderId}&amp;name=foo"</span><span class="o">));</span>
</code></pre></div></div>

<p>Former Citrus versions provided many base classes which confused users. 
The classes <code class="highlighter-rouge">TestNGCitrusSupport</code>/<code class="highlighter-rouge">JUnit4CitrusSupport</code> are now the single base class for all tests including XML and Java DSL tests.</p>

<p>The JUnit 5 support provides a <code class="highlighter-rouge">@CitrusSupport</code> extension annotation.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@CitrusSpringSupport</span>
<span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="n">classes</span> <span class="o">=</span> <span class="o">{</span><span class="n">CitrusSpringConfig</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloServiceIT</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">HttpClient</span> <span class="n">httpClient</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">KafkaEndpoint</span> <span class="n">orderEvents</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="nd">@CitrusTest</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">(</span><span class="nd">@CitrusResource</span> <span class="n">GherkinTestActionRunner</span> <span class="err">$</span><span class="o">)</span> <span class="o">{</span>
        <span class="err">$</span><span class="o">.</span><span class="na">given</span><span class="o">(</span><span class="n">variable</span><span class="o">(</span><span class="s">"orderId"</span><span class="o">,</span> <span class="mi">1000</span><span class="o">));</span>

        <span class="err">$</span><span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="n">http</span><span class="o">().</span><span class="na">client</span><span class="o">(</span><span class="n">httpClient</span><span class="o">)</span>
                <span class="o">.</span><span class="na">send</span><span class="o">()</span>
                <span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="s">"/orders"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">contentType</span><span class="o">(</span><span class="n">APPLICATION_FORM_URLENCODED</span><span class="o">)</span>
                <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"order=${orderId}&amp;name=foo"</span><span class="o">));</span>

        <span class="err">$</span><span class="o">.</span><span class="na">then</span><span class="o">(</span><span class="n">receive</span><span class="o">(</span><span class="n">orderEvents</span><span class="o">)</span>
                <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"Order ${orderId} has been placed"</span><span class="o">));</span>

        <span class="err">$</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">http</span><span class="o">().</span><span class="na">client</span><span class="o">(</span><span class="n">httpClient</span><span class="o">)</span>
                <span class="o">.</span><span class="na">receive</span><span class="o">()</span>
                <span class="o">.</span><span class="na">response</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="make-spring-optional">Make Spring optional</h2>

<p>The Spring framework is a wide spread and well appreciated framework for Java applications.
The framework provides an awesome set of projects, libraries and tools.
The dependency injection and IoC concepts introduced with Spring are groundbreaking.</p>

<p>Some people prefer to choose other approaches though to work with dependency injection. 
Others do struggle with mastering Citrus and Spring as new frameworks at the same time. 
Both frameworks Spring and Citrus are very powerful and newbies sometimes feel overwhelmed with having to deal with so 
much new stuff at the same time.</p>

<p>In former releases Citrus has been very tied to Spring and in some cases this has been a showstopper to work with Citrus for mentioned reasons.</p>

<p>In Citrus 3.x we make Spring optional in <code class="highlighter-rouge">core</code> modules so people can choose to enable/disable Spring support. 
In particular this affects the way Citrus components are started and linked to each other via the Spring application context.</p>

<h3 id="citrus-and-spring">Citrus and Spring</h3>

<p>When Spring is enabled for Citrus all components are loaded with a Spring application context. 
This enables autowiring and bean definition parsing. 
Latter bean definition parsing for custom components is mandatory when using XML based configuration and XML test cases in Citrus.</p>

<p>Users enable the Spring support in Citrus by adding the following module:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.consol.citrus<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>citrus-spring<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.1.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>When using <code class="highlighter-rouge">citrus-core</code> dependency this Spring support is enabled by default in order to adjust with what has been configured in previous Citrus versions.</p>

<h3 id="citrus-standalone">Citrus standalone</h3>

<p>In case you exclude the <code class="highlighter-rouge">citrus-spring</code> module for Citrus you will load the same components and features but only without Spring framework support. 
Keep in mind only the XML based configuration and XML test cases continue to require Spring.</p>

<p>In non-Spring mode custom components can be directly configured in the Citrus context then.
Also Citrus uses a resource common path lookup mechanism to identify common components that get loaded automatically. 
So you simply add components such as <code class="highlighter-rouge">citrus-validation-json</code> to your project classpath and the Json validation capabilities are loaded automatically.</p>

<p>The resource path lookup is a mechanism to identify components in Citrus that should be loaded automatically when the Citrus application is started. 
You only need to add components to the classpath (e.g. by adding a Maven dependency) and the resource gets loaded automatically. 
This mechanism is used to decouple modules and to provide a non-Spring mode for Citrus.</p>

<p>Feel free to choose which approach fits best for your needs. Citrus running with or without Spring.</p>

<h2 id="update-dependencies">Update dependencies</h2>

<p>It has been quite some time since the last major Citrus release. 
So this is a point where we catch up with all the other libraries and dependencies that evolved over time. 
In particular this is Apache Camel, Spring and Cucumber that all evolved with major versions in the past.</p>

<p>The following might be the most important updates:</p>

<ul>
  <li>Java 11</li>
  <li>Spring framework 5.3</li>
  <li>Apache Camel 3.9</li>
  <li>TestNG 7.1</li>
  <li>JUnit 5.7</li>
  <li>Jetty 9.4</li>
  <li>Kafka 2.8</li>
  <li>Selenium 3.141</li>
  <li>Log4J2 2.14</li>
  <li>Cucumber 6.10</li>
</ul>

<h2 id="whats-next">What’s next!?</h2>

<p>So 3.0 is the first version of the Citrus 3.x release train. And we are not done yet! 
We continue to work on our goals to simplifying the ways of writing integration tests so Citrus is ready for the future challenges of software testing.</p>

<p>We love to get feedback so please give it a try and tell us what you think about Citrus 3.0. 
Now is the time to raise your voice to improve the framework!</p>

  </div>
</article>


  <article>
  <h2>
    Upcoming changes - What the future holds for Citrus
    <a href="/news/2018/09/19/upcoming-changes/" class="permalink" title="Permalink">∞</a>
  </h2>
  <span class="post-category">
    <span class="label">
      blog
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      19 Sep 2018
    </span>
    <a href="https://github.com/christophd" class="post-author">
      
      Christoph Deppisch
    </a>
  </div>
  <div class="post-content">
    <p>More than ten years ago I started out on a journey to implement a Java testing framework that provides automated integration tests for message-based enterprise applications with support for multiple messaging transports and data formats.</p>

<p>The result is called <em><a href="https://github.com/citrusframework/citrus">Citrus</a></em> which is an Open Source project used by many development and testing teams all over the world. Ever since then I have spent lots of energy to further developing the Citrus framework and spreading the word for fully automated integration tests. 
It has been a very enjoyable and adventurous journey that will change somewhat in the near future. I am about to leave the company <a href="https://www.consol.de/">ConSol</a> and move to distant shores along the Java Open Source community. ConSol has always been and continues to be a great sponsor and supporter of the Citrus framework.</p>

<p>As part of this move I will handover the lead developer role of Citrus to my colleague <a href="https://twitter.com/SvenHettwer">@SvenHettwer</a>. Sven is a perfect match for this position as I have spent the past twelve months working very closely with him, providing lots of insights and in-depth knowledge, on the Citrus framework. 
Project maintenance and professional consulting will be continued as before by ConSol and its test automation specialists.</p>

<p>As for me, I will be taking on a new opportunity (to be announced soon). Having said that I will try to continue to be part of the Citrus Open Source community. As my passion for automated integration testing is still very strong I will be thrilled to be joining forces along the path.</p>

<p>I am very proud of what Citrus and the community behind it have accomplished over the past decade and I am very excited to see what the future holds. I am absolutely positive that Citrus will continue to master the challenges in test automation for the software development community.
I can not wait to see that the framework continues to evolve with the goal to helping people write well tested software.</p>

<p>Christoph Deppisch (<a href="https://twitter.com/freaky_styley">@freaky_styley</a>)</p>

<p>Developer &amp; Founder, Citrus</p>


  </div>
</article>


  <article>
  <h2>
    Simulating 3rd party services with Spring Boot and Citrus
    <a href="/news/2017/09/21/introducing-citrus-simulator/" class="permalink" title="Permalink">∞</a>
  </h2>
  <span class="post-category">
    <span class="label">
      blog
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      21 Sep 2017
    </span>
    <a href="https://github.com/christophd" class="post-author">
      
      Christoph Deppisch
    </a>
  </div>
  <div class="post-content">
    <p>When developing software that exchanges data with other components or services you may be confronted with the proper simulation of those foreign services during integration testing. This is because you need to connect with a foreign service 
that is simply not available on your local machine or in a test environment.</p>

<p>For unit testing purpose you can use mocks that help out to simulate proper responses. There will be times where your software is deployed to a test environment 
in order to perform some acceptance tests with your stack holders before going to a final release. Usually this is also done with the customer exploring the software through manual testing. In these situations traditional service mocking is not 
a good option and you need a real simulator instance that receives requests and responds with proper test data.</p>

<p>This is exactly what the Citrus simulator project provides for you. Standalone simulation and complex request/response processing with solid validation capabilities. The Citrus simulator provides a very easy and reliable definition of inbound and outbound messages for different scenarios. 
Good news is that this is not only for Http REST interfaces but also for SOAP WebService, JMS, RMI, mail messaging and many more. So you can use the simulator whenever you need to integrate with another service that is simply not available on your local machine or in your test environment.</p>

<p>The <a href="https://github.com/citrusframework/citrus-simulator">citrus-simulator</a> project is a side project of the test framework <a href="https://citrusframework.org">Citrus</a>. The simulator uses Citrus to define server APIs and the logic to respond with predefined messages according to
defined scenarios.</p>

<p>In general the simulator is nothing but a normal <a href="https://projects.spring.io/spring-boot/">Spring Boot</a> web application that you can start on your local machine. The simulator waits for incoming requests and each request executes a predefined scenario that will create a response message for the client. 
Which scenario to execute is identified based on a mapping key that is extracted from the incoming request.</p>

<p>Let’s have a simple example project to demonstrate the simulator concepts.</p>

<h2 id="user-login-sample">User login sample</h2>

<p>Let’s say you are in charge of developing an application that connects with a user login service for proper authentication. Your service comes as a Microservice web application and is ready for deployment in the acceptance test environment.</p>

<p>Unfortunately the user authentication service is not ready yet and is not deployed in that test environment. Without the user 
login service your application is not able to work properly as each user interaction needs to be authenticated with foreign service calls first. 
This means the foreign user login service needs to be simulated so users can explore your application in that test environment.</p>

<p><img src="/img/citrus-simulator/test-deployment.png" alt="test-deployment.png"></p>

<h3 id="spring-boot-simulator">Spring Boot simulator</h3>

<p>We start to simulate that user login service by creating a new Spring Boot project. Of course you can use any build system you like when building the simulator application. Most popular tools would be <a href="http://gradle.org/">Gradle</a> or <a href="https://maven.apache.org/">Maven</a>. 
Here we show how to setup everything using Gradle.</p>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">buildscript</span> <span class="o">{</span>
    <span class="n">repositories</span> <span class="o">{</span>
        <span class="n">mavenCentral</span><span class="o">()</span>
    <span class="o">}</span>
    <span class="n">dependencies</span> <span class="o">{</span>
        <span class="n">classpath</span><span class="o">(</span><span class="s2">"org.springframework.boot:spring-boot-gradle-plugin:1.5.6.RELEASE"</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">'java'</span>
<span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">'eclipse'</span>
<span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">'idea'</span>
<span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">'org.springframework.boot'</span>

<span class="n">jar</span> <span class="o">{</span>
    <span class="n">group</span> <span class="o">=</span> <span class="s2">"com.consol.citrus.simulator"</span>
    <span class="n">baseName</span> <span class="o">=</span> <span class="s1">'user-login-simulator'</span>
    <span class="n">version</span> <span class="o">=</span>  <span class="s1">'1.0.0'</span>
<span class="o">}</span>

<span class="n">repositories</span> <span class="o">{</span>
    <span class="n">mavenCentral</span><span class="o">()</span>
<span class="o">}</span>

<span class="n">sourceCompatibility</span> <span class="o">=</span> <span class="mf">1.8</span>
<span class="n">targetCompatibility</span> <span class="o">=</span> <span class="mf">1.8</span>

<span class="n">dependencies</span> <span class="o">{</span>
    <span class="n">compile</span><span class="o">(</span><span class="s2">"org.springframework.boot:spring-boot-starter"</span><span class="o">)</span>
    <span class="n">compile</span><span class="o">(</span><span class="s2">"org.springframework.boot:spring-boot-starter-web"</span><span class="o">)</span>
    <span class="n">compile</span><span class="o">(</span><span class="s2">"com.consol.citrus:citrus-simulator-starter:1.0.0"</span><span class="o">)</span>
    <span class="n">compile</span><span class="o">(</span><span class="s2">"com.consol.citrus:citrus-simulator-ui:1.0.0"</span><span class="o">)</span>
    <span class="n">testCompile</span><span class="o">(</span><span class="s2">"junit:junit"</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The build script defines a typical Spring Boot project with its dependencies and plugin configuration. In addition to that we add the <em>citrus-simulator-starter</em> dependency. The <em>citrus-simulator-ui</em> dependency is optional
and provides a detailed Angular2 user interface that you can open with your browser once the simulator is up and running.</p>

<p>Let’s add the Spring Boot main class for the application <code class="highlighter-rouge">com.consol.citrus.simulator.Simulator.java</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">consol</span><span class="o">.</span><span class="na">citrus</span><span class="o">.</span><span class="na">simulator</span><span class="o">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Simulator</span> <span class="kd">extends</span> <span class="n">SimulatorRestAdapter</span><span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">Simulator</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">urlMapping</span><span class="o">(</span><span class="n">SimulatorRestConfigurationProperties</span> <span class="n">simulatorRestConfiguration</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"/services/rest/v1/**"</span><span class="o">;</span>
    <span class="o">}</span>
        
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">EndpointAdapter</span> <span class="nf">fallbackEndpointAdapter</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">StaticEndpointAdapter</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="n">Message</span> <span class="nf">handleMessageInternal</span><span class="o">(</span><span class="n">Message</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nf">HttpMessage</span><span class="o">().</span><span class="na">status</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The main class is a typical Spring Boot application that uses <code class="highlighter-rouge">@SpringBootApplication</code> annotation with auto configuration of needed components. As we have added the <em>citrus-simulator-starter</em> dependency to the project we also get auto 
configuration of all simulator related beans and components. The application can use a <code class="highlighter-rouge">SimulatorRestAdapter</code> extension in order to overwrite some simulator components such as the default <code class="highlighter-rouge">fallbackEndpointAdapter</code>. This adapter defines a 
default <code class="highlighter-rouge">Http 500</code> internal server error response when something went wrong on the simulator request processing. Also we give the url mapping that defines how clients connect with the user login REST API later on using the base 
URL <code class="highlighter-rouge">http://localhost:8080/services/rest/v1/**</code>.</p>

<p>Now we can add a first a default scenario that responds to incoming requests.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">consol</span><span class="o">.</span><span class="na">citrus</span><span class="o">.</span><span class="na">simulator</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.consol.citrus.http.message.HttpMessage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.consol.citrus.simulator.scenario.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.HttpStatus</span><span class="o">;</span>

<span class="nd">@Scenario</span><span class="o">(</span><span class="s">"DEFAULT_SCENARIO"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultScenario</span> <span class="kd">extends</span> <span class="n">AbstractSimulatorScenario</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">ScenarioDesigner</span> <span class="n">designer</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">designer</span><span class="o">.</span><span class="na">send</span><span class="o">()</span>
                <span class="o">.</span><span class="na">message</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpMessage</span><span class="o">(</span><span class="s">"No scenario found for this request"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">NOT_FOUND</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The scenario uses the annotation <code class="highlighter-rouge">@Scenario("DEFAULT_SCENARIO")</code> and extends <code class="highlighter-rouge">AbstractSimulatorScenario</code>. In the <code class="highlighter-rouge">run</code> method we can use the Citrus Java DSL designer to create some response generating logic.
This default scenario is activated when no other scenario is matching the incoming request. So we send back a <code class="highlighter-rouge">Http 404 NOT FOUND</code> as we obviously did not match a scenario. Now let’s build and start the simulator application.</p>

<h3 id="build-and-run">Build and run</h3>

<p>You can build and run the simulator application from command line using the Gradle binaries.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./gradlew build bootRun
</code></pre></div></div>

<p>You will see the application starting up. Usually you will see some console log output. The web server should start within seconds. Once the application is up and running
you can open your browser and point to <a href="http://localhost:8080">http://localhost:8080</a>. You will see the simulator user interface.</p>

<p><img src="/img/citrus-simulator/dashboard.png" alt="dashboard.png"></p>

<p>You can access the simulated REST services on <a href="http://localhost:8080/services/rest/">http://localhost:8080/services/rest/</a>. Up to now we only have the default scenario so we constantly get <code class="highlighter-rouge">Http 404 NOT FOUND</code> responses. 
Let’s add some scenarios representing the user login service.</p>

<h3 id="user-login-rest-api">User login REST API</h3>

<p>The user login service defines following REST API:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"swagger"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2.0"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"info"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"This is a user login service"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.0"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"User Login Service"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="s2">"host"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user-login-service"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"basePath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"schemes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"http"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="s2">"paths"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"/user"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"post"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"operationId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"createUser"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"produces"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"application/xml"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"application/json"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="s2">"in"</span><span class="p">:</span><span class="w"> </span><span class="s2">"body"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"body"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Created user object"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"required"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
            </span><span class="s2">"schema"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="s2">"$ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#/definitions/User"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"responses"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"default"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"successful operation"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"/user/login"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"get"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"operationId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"loginUser"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"produces"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"application/xml"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"application/json"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"username"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"in"</span><span class="p">:</span><span class="w"> </span><span class="s2">"query"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The user name for login"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"required"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
            </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"password"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"in"</span><span class="p">:</span><span class="w"> </span><span class="s2">"query"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The password for login in clear text"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"required"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
            </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"responses"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"200"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"successful operation"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"schema"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="s2">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="s2">"X-Rate-Limit"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"format"</span><span class="p">:</span><span class="w"> </span><span class="s2">"int32"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"calls per hour allowed by the user"</span><span class="w">
              </span><span class="p">},</span><span class="w">
              </span><span class="s2">"X-Expires-After"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"format"</span><span class="p">:</span><span class="w"> </span><span class="s2">"date-time"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"date in UTC when token expires"</span><span class="w">
              </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="s2">"400"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Invalid username/password supplied"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"/user/logout"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"get"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"operationId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"logoutUser"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"produces"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"application/xml"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"application/json"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"responses"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"default"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"successful operation"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"/user/{username}"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"get"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"operationId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"getUserByName"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"produces"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"application/xml"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"application/json"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"username"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"in"</span><span class="p">:</span><span class="w"> </span><span class="s2">"path"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The name that needs to be fetched. Use user1 for testing. "</span><span class="p">,</span><span class="w">
            </span><span class="s2">"required"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
            </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"responses"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"200"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"successful operation"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"schema"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="s2">"$ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#/definitions/User"</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="s2">"400"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Invalid username supplied"</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="s2">"404"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"User not found"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="s2">"definitions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"User"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"format"</span><span class="p">:</span><span class="w"> </span><span class="s2">"int64"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"username"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"password"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="s2">"xml"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"User"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>There are 4 operations defined:</p>

<ul>
  <li>Http POST user/</li>
  <li>Http GET user/login</li>
  <li>Http GET user/logout</li>
  <li>Http GET user/{username}</li>
</ul>

<p>Let’s create basic scenarios for these operations in the simulator.</p>

<h3 id="user-login-scenarios">User login scenarios</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Scenario</span><span class="o">(</span><span class="s">"CREATE_USER"</span><span class="o">)</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/services/rest/v1/user"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CreateUserScenario</span> <span class="kd">extends</span> <span class="n">AbstractSimulatorScenario</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">ScenarioDesigner</span> <span class="n">scenario</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">scenario</span>
            <span class="o">.</span><span class="na">http</span><span class="o">()</span>
            <span class="o">.</span><span class="na">receive</span><span class="o">()</span>
            <span class="o">.</span><span class="na">post</span><span class="o">()</span>
            <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="k">new</span> <span class="n">ClassPathResource</span><span class="o">(</span><span class="s">"templates/user-control.json"</span><span class="o">));</span>

        <span class="n">scenario</span>
            <span class="o">.</span><span class="na">http</span><span class="o">()</span>
            <span class="o">.</span><span class="na">send</span><span class="o">()</span>
            <span class="o">.</span><span class="na">response</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The scenario for <code class="highlighter-rouge">Http POST</code> requests on request path <code class="highlighter-rouge">/v1/user</code> uses the Spring <code class="highlighter-rouge">@RequestMapping</code> annotation. The simulator scenario mapper will automatically
route incoming requests to this scenario based on that information.</p>

<p>The scenario itself receives the incoming request using the Citrus Java DSL. The receive operation validates the <code class="highlighter-rouge">Http POST</code> request method and gives an expected control Json message body as external file resource. The
<code class="highlighter-rouge">user-control.json</code> defines the expected user object on this operation:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"@isNumber()@"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"@notEmpty()@"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"password"</span><span class="p">:</span><span class="w"> </span><span class="s2">"@notEmpty()@"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The control user object verifies that the elements <code class="highlighter-rouge">id</code>, <code class="highlighter-rouge">username</code> and <code class="highlighter-rouge">password</code> are present. In addition to that we can use Citrus validation matchers in order to validate the element values. The scenario produces a proper response 
only in case the incoming request matches the expected control Json object. The simulator scenario is able to use the full Citrus validation power for comparing message data in Json, XML and plaintext message format. JsonPath and XPath expression evaluation and validation
is also possible here.</p>

<p>Now let’s define a proper response message for the scenario. We send back a <code class="highlighter-rouge">Http 200 OK</code> response. This is how the scenario is able to control the response generation with Citrus.</p>

<p>We continue with the remaining scenarios for all other operations defined in the REST API:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Scenario</span><span class="o">(</span><span class="s">"GET_USER"</span><span class="o">)</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/services/rest/v1/user/{username}"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GetUserScenario</span> <span class="kd">extends</span> <span class="n">AbstractSimulatorScenario</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">ScenarioDesigner</span> <span class="n">scenario</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">scenario</span>
            <span class="o">.</span><span class="na">http</span><span class="o">()</span>
            <span class="o">.</span><span class="na">receive</span><span class="o">()</span>
            <span class="o">.</span><span class="na">get</span><span class="o">();</span>

        <span class="n">scenario</span>
            <span class="o">.</span><span class="na">http</span><span class="o">()</span>
            <span class="o">.</span><span class="na">send</span><span class="o">()</span>
            <span class="o">.</span><span class="na">response</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span>
            <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="k">new</span> <span class="n">ClassPathResource</span><span class="o">(</span><span class="s">"random-user.json"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The get user operation needs to send back a proper user object in Json fomrat. We can load an external file resource as message payload for that.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"citrus:randomNumber(10)"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"citrus:randomEnumValue('amy', 'penny', 'sheldon', 'leonard', 'rajesh', 'howard', 'bernadette')"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"password"</span><span class="p">:</span><span class="w"> </span><span class="s2">"citrus:randomString(10)"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The usage of Citrus functions makes it easy to create a random user object that meets the REST API object definitions. Let’s add the remaining login and logout scenarios.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Scenario</span><span class="o">(</span><span class="s">"USER_LOGIN"</span><span class="o">)</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/services/rest/v1/user/login"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserLoginScenario</span> <span class="kd">extends</span> <span class="n">AbstractSimulatorScenario</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">ScenarioDesigner</span> <span class="n">scenario</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">scenario</span>
            <span class="o">.</span><span class="na">http</span><span class="o">()</span>
            <span class="o">.</span><span class="na">receive</span><span class="o">()</span>
            <span class="o">.</span><span class="na">get</span><span class="o">()</span>
            <span class="o">.</span><span class="na">queryParam</span><span class="o">(</span><span class="s">"@assertThat(allOf(containsString(username=),containsString(password=))@"</span><span class="o">);</span>

        <span class="n">scenario</span>
            <span class="o">.</span><span class="na">http</span><span class="o">()</span>
            <span class="o">.</span><span class="na">send</span><span class="o">()</span>
            <span class="o">.</span><span class="na">response</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span>
            <span class="o">.</span><span class="na">contentType</span><span class="o">(</span><span class="s">"text/plain"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">"X-Rate-Limit"</span><span class="o">,</span> <span class="s">"10"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">"X-Expires-After"</span><span class="o">,</span> <span class="s">"citrus:currentDate(YYYY-MM-DD'T'hh:mm:ss, +1h)"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">"citrus:randomString(40)"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The login operation verifies the presence of Http query parameter <code class="highlighter-rouge">username</code> and <code class="highlighter-rouge">password</code>. As response the scenario defines some header information <code class="highlighter-rouge">X-Rate-Limit</code> and <code class="highlighter-rouge">X-Expires-After</code> where latter is the
expire date time one hour from now calculated with the Citrus function <code class="highlighter-rouge">citrus:currentDate(YYYY-MM-DD'T'hh:mm:ss, +1h)</code>. As payload we send back a 40 character random token as plaintext string.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Scenario</span><span class="o">(</span><span class="s">"USER_LOGOUT"</span><span class="o">)</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/services/rest/v1/user/logout"</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserLogoutScenario</span> <span class="kd">extends</span> <span class="n">AbstractSimulatorScenario</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">ScenarioDesigner</span> <span class="n">scenario</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">scenario</span>
            <span class="o">.</span><span class="na">http</span><span class="o">()</span>
            <span class="o">.</span><span class="na">receive</span><span class="o">()</span>
            <span class="o">.</span><span class="na">get</span><span class="o">();</span>

        <span class="n">scenario</span>
            <span class="o">.</span><span class="na">http</span><span class="o">()</span>
            <span class="o">.</span><span class="na">send</span><span class="o">()</span>
            <span class="o">.</span><span class="na">response</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Last not least the logout operation that completes the REST API for the user login service. Now the simulator is able to respond to all operations that are defined in the REST API. Clients are now able to call the 
operations via Http REST. The simulator will verify the incoming request data and create proper response messages.</p>

<p>You can test the simulator by pointing your browser to the following URLs:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://localhost:8080/services/rest/v1/user/test
http://localhost:8080/services/rest/v1/user/login?username=christoph&amp;password=secr3t
http://localhost:8080/services/rest/v1/user/logout
</code></pre></div></div>

<p>You should always get proper <code class="highlighter-rouge">Http 200 OK</code> response messages. The login request should get a new login token in the response every time. In case we send some invalid request we should get <code class="highlighter-rouge">Http 500</code> responses and for 
unsupported request paths we should get a <code class="highlighter-rouge">Http 404</code> response. Try that with following test URLs.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://localhost:8080/services/rest/v1/unsupported
http://localhost:8080/services/rest/v1/user/login
http://localhost:8080/services/rest/v1/user/login?username=pwd_missing
</code></pre></div></div>

<p>With the above test requests we triggered some activities on the simulator. Let’s review those activities in the web based user interface.</p>

<h3 id="simulator-user-interface">Simulator user interface</h3>

<p>The simulator provides a web based Angular2 user interface so users can review the status and all activities on the simulator. We have already seen the dashboard that gives an overview of the simulator status:</p>

<p><img src="/img/citrus-simulator/dashboard.png" alt="dashboard.png"></p>

<p>In addition to that you can view detailed information available scenarios and their execution activity.</p>

<p><img src="/img/citrus-simulator/scenario_list.png" alt="scenario_list.png"></p>

<p><img src="/img/citrus-simulator/scenario_activity.png" alt="scenario_activity.png"></p>

<h2 id="auto-generate-scenarios">Auto generate scenarios</h2>

<p>Up to now we have added simulator scenarios manually. We could have also used auto generated scenarios based on the given Swagger Open API specification of the REST API. Just add a <code class="highlighter-rouge">HttpScenarioGenerator</code> bean
to the application:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">consol</span><span class="o">.</span><span class="na">citrus</span><span class="o">.</span><span class="na">simulator</span><span class="o">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Simulator</span> <span class="kd">extends</span> <span class="n">SimulatorRestAdapter</span><span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">Simulator</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">urlMapping</span><span class="o">(</span><span class="n">SimulatorRestConfigurationProperties</span> <span class="n">simulatorRestConfiguration</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"/services/rest/v1/**"</span><span class="o">;</span>
    <span class="o">}</span>
        
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">EndpointAdapter</span> <span class="nf">fallbackEndpointAdapter</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">StaticEndpointAdapter</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="n">Message</span> <span class="nf">handleMessageInternal</span><span class="o">(</span><span class="n">Message</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nf">HttpMessage</span><span class="o">().</span><span class="na">status</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>
    
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">HttpScenarioGenerator</span> <span class="nf">scenarioGenerator</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">HttpScenarioGenerator</span> <span class="n">generator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpScenarioGenerator</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">ClassPathResource</span><span class="o">(</span><span class="s">"swagger/user-login-api.json"</span><span class="o">));</span>
        
        <span class="n">generator</span><span class="o">.</span><span class="na">setContextPath</span><span class="o">(</span><span class="s">"/services/rest"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">generator</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">HttpScenarioGenerator</code> reads the Open API specification file at runtime and generates scenarios for each operation. The generated scenarios do also
verify the request data according to the rules defined in the specification. The response messages hold dynamic data objects generated from the API schema definitions.</p>

<h2 id="whats-next">What’s next?!</h2>

<p>The Citrus simulator project brings everything to manage standalone simulation of interfaces that you need to connect to during software development. The sample above showed REST API simulation. Same logic is possible with SOAP web services, 
JMS and many other messaging transports. The integration with Citrus framework capabilities enables us to create even very complex scenarios with intermediate message handling and consecutive message calls as well as
content based routing.</p>

<p>You can find the complete sample sources on <a href="https://github.com/citrusframework/citrus-simulator-demo">github (https://github.com/citrusframework/citrus-simulator-demo)</a>. Also please explore all other 
simulator <a href="https://github.com/citrusframework/citrus-simulator/tree/master/simulator-samples">sample projects</a> and find out how the simulator works best for you and your requirements.</p>

<p>Of course any feedback is very welcome!</p>


  </div>
</article>


  <article>
  <h2>
    Introducing Citrus Admin Web UI
    <a href="/news/2017/07/07/introducing-citrus-admin/" class="permalink" title="Permalink">∞</a>
  </h2>
  <span class="post-category">
    <span class="label">
      blog
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      07 Jul 2017
    </span>
    <a href="https://github.com/christophd" class="post-author">
      
      Christoph Deppisch
    </a>
  </div>
  <div class="post-content">
    <p>It has been a while since the last release in the <a href="http://citrusframework.github.io/citrus/">Citrus</a> universe. It took us some time to get the new Citrus release <a href="/news/2017/07/07/release-2-7-2/">2.7.2</a> ready for you. 
Of course we were not being lazy in that time. Besides the new Citrus 2.7.2 release we are proud to announce a new player in the Citrus team. The <em>Citrus administration UI</em> is a 
web-based user interface that helps you to manage your Citrus projects and test cases.</p>

<p>Often users complained about the complexity of having to learn all about Citrus and the Spring framework in particular as Citrus uses Spring for configuration and dependency injection. 
Especially non-developers had problems to master the learning curve for Citrus and Spring when starting to use the framework. Also people asked for a way to have a user interface for managing
components and tests.</p>

<p>We heard you and introduced a new administration user interface for Citrus! There is a detailed <a href="http://citrusframework.github.io/citrus-admin/">Citrus Admin documentation</a> (which is still ongoing). 
However I would like to outline the main features of that web UI here in a short post for you.</p>

<h2 id="download">Download</h2>

<p>You can start the web UI on your local machine with an executable web archive available at</p>

<p>https://labs.consol.de/maven/repository/com/consol/citrus/citrus-admin-web</p>

<p>Download the web archive to a local directory:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -o citrus-admin.war https://labs.consol.de/maven/repository/com/consol/citrus/citrus-admin-web/1.0.1/citrus-admin-web-1.0.1-executable.war
</code></pre></div></div>

<p>Once loaded you can start the admin UI as Spring boot web application from command line like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java -jar citrus-admin.war
</code></pre></div></div>

<p>You will see the application starting up. The web server should start within seconds. Once the application is up and running you can open your browser and point to <a href="">http://localhost:8080</a>.</p>

<p>The administration web UI is able to open any Citrus project on your local machine. When opened you can display the project information such as the latest test results. In addition to that you are able 
to view the Citrus components configured in the in the Spring application context. The web UI is also able to navigate to all test cases in your project. You can open the tests and execute them.</p>

<p><img src="/img/citrus-admin/project-dashboard.png" alt="project-dashboard.png"></p>

<h2 id="edit-configuration-components">Edit configuration components</h2>

<p>One of the major goals in the web UI is to give new users an easier way to get started with the Citrus Spring configuration. All configuration components get loaded from the Spring application context. 
You can view and edit those components such as Citrus endpoints via HTML forms:</p>

<p><img src="/img/citrus-admin/config-endpoints.png" alt="config-endpoints.png"></p>

<p>In case you add new components or save changes to configuration items the administration web UI directly changes the Spring configuration files on your local machine in that particular project. Of course you can
open the Spring configuration files in another editor (e.g. your favorite Java IDE) and review the changes made. In addition to that all configuration changes made from external editors are directly visible to the admin UI.</p>

<h2 id="test-management">Test management</h2>

<p>You can see all available Citrus test cases in the opened project. The list of tests contains XML and Java DSL tests.</p>

<p><img src="/img/citrus-admin/test-list.png" alt="test-list.png"></p>

<p>When opening a particular test case the UI will display the test details to you. This includes all test actions, source code, log output and the latest test results.</p>

<p><img src="/img/citrus-admin/test-info.png" alt="test-info.png">
<img src="/img/citrus-admin/test-sources.png" alt="test-sources.png"></p>

<p>If you execute the test you will see the log output of that process and you will get a detailed access to all messages exchanged in that test run.</p>

<p><img src="/img/citrus-admin/test-execute.png" alt="test-execute.png"></p>

<p>As you can see the test log output is forwarded to your browser. Also the test progress and result (success or failure) is tracked by the administration UI. 
In the messages table you are able to review all messages (inbound/outbound) that were part of the test run.</p>

<p><img src="/img/citrus-admin/test-messages.png" alt="test-messages.png"></p>

<h2 id="reporting">Reporting</h2>

<p>The administration UI is able to read the test results in your project. Typically these are JUnit or TestNG reports that are generated from each test run. If present the UI will read and display detailed
test results of the latest test run.</p>

<p><img src="/img/citrus-admin/test-report.png" alt="test-report.png"></p>

<p>When a test case is failing for some reason exception and failure information will be provided.</p>

<p><img src="/img/citrus-admin/test-results.png" alt="test-results.png"></p>

<p>The administration UI aims to give you an additional tooling for Citrus integration testing. The administration web UI is not there to eliminate your favorite IDE (IntelliJ, Eclipse or whatever)! The UI is a helping 
instrument for getting in touch with Citrus and its concepts and works side by side with your local Java IDE as well as other text editors of your choice.</p>

<p>Also the UI is helpful when executing the Citrus integration tests in different stages (test, acceptance, explorative) of your release process. There is not always a full capable development environment available for 
executing integration tests. You can run the Citrus administrative UI as Docker container or Kubernetes pod in order to make the tests portable to your containerized test environment.</p>

<h2 id="docker-image">Docker image</h2>

<p>The administration UI is available as <a href="https://www.docker.com/">Docker</a> image (<code class="highlighter-rouge">consol/citrus-admin:latest</code>). You can pull the image and link it to your local Citrus project:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -d -p 8080:8080 -v $PWD:/maven -e CITRUS_ADMIN_PROJECT_HOME=/maven consol/citrus-admin:latest
</code></pre></div></div>

<p>The command above loads the Docker image and runs a new Citrus web UI container. The container is provided with a volume mount that makes the current directory accessible from within the container.
This current directory is then used as project home so the admin UI will automatically open the Citrus project from that directory. Once the container is running
you can point your local browser to <a href="">http://localhost:8080</a> in order to access the web UI.</p>

<p>The <code class="highlighter-rouge">CITRUS_ADMIN_PROJECT_HOME</code> environment setting is optional and is used to automatically open a project on container startup. You can leave out this setting in order to select a project folder
in your mounted working directory when starting the web UI.</p>

<p>In case you do not have a Citrus project ready yet, the admin UI can also create a new project for you. It is possible to run a Maven archetype on container startup that creates a complete new project for you.
You can set the Maven archetype coordinates (<em>groupId</em>, <em>artifactId</em>, <em>version</em>) as environment variables when running the container.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -d -p 8080:8080 -v $PWD:/maven -e CITRUS_ADMIN_MAVEN_ARCHETYPE_COORDINATES=com.consol.citrus.archetypes:citrus-quickstart:2.7.5 consol/citrus-admin:latest
</code></pre></div></div>

<p>The UI will load the Maven archetype and create the project sources when the container is started. The new project gets its Maven coordinates from another environment setting:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-e CITRUS_ADMIN_MAVEN_PROJECT_COORDINATES=com.consol.citrus:citrus-sample:1.0.0
</code></pre></div></div>

<p>Another way to load a new project on container startup is to specify a git repository URL. The Citrus admin Docker container will then load the project sources from that git repository on startup:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -d -p 8080:8080 -v $PWD:/maven -e CITRUS_ADMIN_PROJECT_REPOSITORY=https://github.com/account/citrus-project.git consol/citrus-admin:latest
</code></pre></div></div>

<p>The command above will load the project sources from git with URL <code class="highlighter-rouge">https://github.com/account/citrus-project.git</code> and open that project afterwards. The git repository of course should hold the Citrus project sources. In case
the Citrus project is located in a sub module in that git repository you can load that sub module by specifying additional environment properties:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-e CITRUS_ADMIN_PROJECT_REPOSITORY_MODULE=/integration/citrus-test -e CITRUS_ADMIN_PROJECT_REPOSITORY_BRANCH=bugfix
</code></pre></div></div>

<p>With these options we are able to start the Docker image as container with special customizations via environment settings.</p>

<h2 id="use-docker-maven-plugin">Use Docker Maven plugin</h2>

<p>The Citrus admin Docker image also works fine with the Fabric8 <a href="http://github.com/fabric8io/docker-maven-plugin">docker-maven-plugin</a>. So you can add the following image configuration to your Citrus Maven project:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml">  <span class="nt">&lt;plugin&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>io.fabric8<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>docker-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>0.21.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;configuration&gt;</span>
      <span class="nt">&lt;verbose&gt;</span>true<span class="nt">&lt;/verbose&gt;</span>
      <span class="nt">&lt;images&gt;</span>
        <span class="nt">&lt;image&gt;</span>
          <span class="nt">&lt;alias&gt;</span>citrus-tests<span class="nt">&lt;/alias&gt;</span>
          <span class="nt">&lt;name&gt;</span>sample-app/citrus-tests:3.3.0<span class="nt">&lt;/name&gt;</span>
          <span class="nt">&lt;build&gt;</span>
            <span class="nt">&lt;from&gt;</span>consol/citrus-admin:1.0.1<span class="nt">&lt;/from&gt;</span>
            <span class="nt">&lt;assembly&gt;</span>
              <span class="nt">&lt;descriptorRef&gt;</span>project<span class="nt">&lt;/descriptorRef&gt;</span>
            <span class="nt">&lt;/assembly&gt;</span>
          <span class="nt">&lt;/build&gt;</span>
          <span class="nt">&lt;run&gt;</span>
            <span class="nt">&lt;namingStrategy&gt;</span>alias<span class="nt">&lt;/namingStrategy&gt;</span>
            <span class="nt">&lt;env&gt;</span>
              <span class="nt">&lt;CITRUS_ADMIN_PROJECT_HOME&gt;</span>/maven<span class="nt">&lt;/CITRUS_ADMIN_PROJECT_HOME&gt;</span>
            <span class="nt">&lt;/env&gt;</span>
            <span class="nt">&lt;ports&gt;</span>
              <span class="nt">&lt;port&gt;</span>8080:8080<span class="nt">&lt;/port&gt;</span>
            <span class="nt">&lt;/ports&gt;</span>
            <span class="nt">&lt;wait&gt;</span>
              <span class="nt">&lt;http&gt;</span>
                <span class="nt">&lt;url&gt;</span>http://localhost:8080<span class="nt">&lt;/url&gt;</span>
                <span class="nt">&lt;method&gt;</span>GET<span class="nt">&lt;/method&gt;</span>
                <span class="nt">&lt;status&gt;</span>200<span class="nt">&lt;/status&gt;</span>
              <span class="nt">&lt;/http&gt;</span>
              <span class="nt">&lt;time&gt;</span>60000<span class="nt">&lt;/time&gt;</span>
              <span class="nt">&lt;shutdown&gt;</span>500<span class="nt">&lt;/shutdown&gt;</span>
            <span class="nt">&lt;/wait&gt;</span>
            <span class="nt">&lt;log&gt;</span>
              <span class="nt">&lt;enabled&gt;</span>true<span class="nt">&lt;/enabled&gt;</span>
              <span class="nt">&lt;color&gt;</span>green<span class="nt">&lt;/color&gt;</span>
            <span class="nt">&lt;/log&gt;</span>
          <span class="nt">&lt;/run&gt;</span>
        <span class="nt">&lt;/image&gt;</span>
      <span class="nt">&lt;/images&gt;</span>
    <span class="nt">&lt;/configuration&gt;</span>
  <span class="nt">&lt;/plugin&gt;</span>    </code></pre></figure>

<p>With that configuration you can just call:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvn docker:build
mvn docker:start
</code></pre></div></div>

<p>This loads and builds the Docker image and starts a new Docker container with running Citrus Admin UI pointing to that very same Maven project.</p>

<p>Stopping the container is as easy as calling:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvn docker:stop
</code></pre></div></div>

<p>This is a very comfortable way to build and ship a Citrus admin UI container with your project. You can deploy the tests to any Docker environment or even use
the container in Kubernetes as pod.</p>

<h2 id="whats-next">What’s next!?</h2>

<p>Now it is your turn! Open your Citrus project with that web UI and tell us how you like it! There are many different approaches to using Citrus in a development project. 
We tried to cover all aspects and we are sure that the web UI is able to read most of the Citrus project out there. In case there is a time when the web UI is not able to 
read your project for some reason please tell us. When there is something wrong or simply not working out for you just open an issue on github.</p>

<p>We are keen to answer your questions and discuss any doubts and we are looking forward to receive your feedback!</p>


  </div>
</article>


  <article>
  <h2>
    Testing WebSockets with a Citrus twist
    <a href="/news/2016/03/15/jcache-chat-citrus/" class="permalink" title="Permalink">∞</a>
  </h2>
  <span class="post-category">
    <span class="label">
      blog
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      15 Mar 2016
    </span>
    <a href="https://github.com/martinmaher" class="post-author">
      
      Martin Maher
    </a>
  </div>
  <div class="post-content">
    <p>In a previous <a href="https://labs.consol.de/cache/java/2016/03/12/caching-with-jcache.html">article</a> we went through how to build a chat room web application that used REST and STOMP for communicating between the client and server. 
In this article I use the very same application and show how to write automated integration tests using the open source Citrus integration test framework.</p>

<p>If you haven’t read the first article don’t worry. A quick summary of all the important bits will be shown shortly below. But before I get to that lets talk a little bit about automated integration testing and citrus.</p>

<p>One of the biggest challenges when testing any application is being able to simulate all endpoints.</p>

<!--more-->

<p>If you take an online web shop for example it typically interacts with numerous backend services (product catalogue, credit check, shipping, billing, etc.) during the course of processing the order. 
When writing an automated integration test that tests the placement of an order you’ll have to simulate each of these services. Some services may expose a REST/HTTP interface whereas others may expose a SOAP/JMS interface. 
In some scenarios the online web shop will be acting as a client, consuming the backend services. In other cases it will be acting as a server, processing customer requests.</p>

<p>The point is that testing such a scenario can be very complex. A simple application today with one or two interfaces may quickly grow into a complex application with 10s or even 100s of interfaces later on. 
When you look at integration test tools then don’t loose sight of this. Sure some tools are great at simulating REST interfaces. Others are great at simulating SOAP. 
However for me the most important criteria is to find a test tool that combines these and many other messaging protocols. The tool should be flexible and extensible. And this is where citrus comes into the equation.</p>

<p>Before I dive into integration testing, let’s do a quick recap on the chat room application.</p>

<h1 id="chat-room">Chat Room</h1>

<p>The basic architecture of the chat room application is presented below:</p>

<div align="center">
<img src="https://labs.consol.de/assets/2016-03-15-jcache-chat-citrus/02_Architecture.png" width="500">
</div>

<p>We have a client-server architecture, using web sockets and REST for communicating between the client and the server. The system under test is the blue box above and I’m going to write some tests that simulate the two green arrows.</p>

<p>The application’s entity model is very modest, using just the two entities shown below:</p>

<div align="center">
<img src="https://labs.consol.de/assets/2016-03-15-jcache-chat-citrus/03_DomainModel.png" width="500">
</div>

<p>A room contains a list of messages and the name of the user that created the room. A message contains some text and the name of the user that sent the message. That’s basically it.</p>

<p>The following REST operations can be sent from the client to the server:</p>

<ul>
  <li>Join or leave the chat application</li>
  <li>Get the list of logged in users</li>
  <li>Get the list of rooms</li>
  <li>Create or remove a room</li>
  <li>Send a message to a room</li>
</ul>

<p>The server can push the following notifications to connected clients using STOMP over WebSocket:</p>

<ul>
  <li>Notify room created or removed</li>
  <li>Notify chat message sent</li>
  <li>Notify user logged-in or logged-out</li>
</ul>

<h1 id="starting-the-application">Starting the application</h1>

<p>The source code for the application is available on <a href="https://github.com/martinmaher/jcache-chat">github</a>.</p>

<p>To run the application you need to have Java 8+ and Maven 3.3.3+ installed and configured on your system.</p>

<p>The application comes shipped with the H2 database that you need to start firing up the application:</p>

<ul>
  <li>Open up a shell</li>
  <li>Change to the H2 directory under <em>../support/h2_v1.3.176/</em>
</li>
  <li>Run the H2 start-up script (either h2.bat or h2.sh).</li>
</ul>

<p>Now you can start the application. This can be done either from the command line or from inside your favourite IDE.</p>

<p>From the command line type:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">shell
<span class="nv">$ </span>mvn clean <span class="nb">install </span>spring-boot:run</code></pre></figure>

<p>This will start up one instance on port 8090.</p>

<p>Alternatively you can start the application from inside your IDE by running the following main class:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">de.consol.chat.ChatApplication</code></pre></figure>

<p>Now go ahead and check that the application is running by opening the application in your browser:</p>

<p><a href="http://localhost:8090/">http://localhost:8090/</a></p>

<h1 id="testing-the-application">Testing the application</h1>

<p>All the source code I’ll be displaying below is available here: <a href="https://github.com/martinmaher/jcache-chat-citrus">https://github.com/martinmaher/jcache-chat-citrus</a>. 
I will show you how to build the project from scratch so you can either clone the above repository or just follow the instructions below, whatever you prefer.</p>

<p>The first thing I need to do is to create an empty maven project for storing and executing our tests. The quickest way of doing this is to execute the maven archtetype goal, 
which will create a citrus project with a basic pom file and some sample integration tests. This can be done as follows:</p>

<ul>
  <li>Create a new directory for the project.</li>
  <li>Change to this directory</li>
  <li>Execute: mvn archetype:generate -DarchetypeCatalog=https://citrusframework.org</li>
  <li>When prompted select archetype ‘1’</li>
  <li>For the groupId, artifactId and package enter whatever you like. I entered
    <ul>
      <li>groupId: de.consol</li>
      <li>artifactId: chat-citrus</li>
      <li>package: de.consol.chat.citrus</li>
    </ul>
  </li>
</ul>

<p>Assuming all goes well you’ll find the following files in the project:</p>

<ul>
  <li>pom.xml – contains the maven project configuration</li>
  <li>src/test/resources/citrus-context.xml – contains the citrus configuration</li>
  <li>src/test/resources/citrus.properties – contains global properties used by citrus</li>
  <li>src/test/resources/log4j.xml – contains the log configuration used by citrus</li>
</ul>

<p>There may be some other files like SampleJavaIT and SampleXmlIT that can be removed if you like, since I wont be using here.</p>

<h2 id="simulating-the-rest-requests">Simulating the REST requests</h2>

<p>To keep things simple I’ll start by simulating the REST requests sent by the client. To begin with lets take the requests where a user joins the chat room.</p>

<p>The request I want to simulate is:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">POST /users/&lt;USERNAME&gt; HTTP/1.1
Accept: text/plain, application/json, application/<span class="k">*</span>+json, <span class="k">*</span>/<span class="k">*</span>
Content-Type: application/json<span class="p">;</span><span class="nv">charset</span><span class="o">=</span>UTF-8</code></pre></figure>

<p>and if all goes well I should get the response:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">HTTP/1.1 200 OK</code></pre></figure>

<p>The first thing I need to do is to create a new java class for executing my test. I extend the <em>TestNGCitrusTestDesigner</em> class, which allows me to use Citrus’s Java DSL and add I’ll add a variable for storing a random name, which will be used for the user name when joining the chat room.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test_01_RestIT</span> <span class="kd">extends</span> <span class="n">TestNGCitrusTestDesigner</span> <span class="o">{</span>
    <span class="nd">@CitrusTest</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testJoiningAndLeaving</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">variable</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span> <span class="s">"citrus:randomString(10, UPPERCASE)"</span><span class="o">);</span>

        <span class="n">echo</span><span class="o">(</span><span class="s">"Joining with user: ${username}"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>If you like you can run this test and it should output “Joining with user ..” to the console.</p>

<p>Next I add the test actions to join the chat room.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="o">[...]</span>

<span class="n">echo</span><span class="o">(</span><span class="s">"Joining with user: ${username}"</span><span class="o">);</span>
<span class="n">send</span><span class="o">(</span><span class="s">"chatRestClient"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">""</span><span class="o">)</span>
        <span class="o">.</span><span class="na">http</span><span class="o">()</span>
        <span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="n">HttpMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
        <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">"/users/${username}"</span><span class="o">);</span>
<span class="n">receive</span><span class="o">(</span><span class="s">"chatRestClient"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">JSON</span><span class="o">)</span>
        <span class="o">.</span><span class="na">http</span><span class="o">()</span>
        <span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span></code></pre></figure>

<p>The first test action sends the request to the HTTP server. The action basically says:</p>

<ul>
  <li>send(“chatRestClient”) -&gt; send using the <em>chatRestClient</em>
</li>
  <li>payload(“”) -&gt; an empty payload</li>
  <li>http() -&gt; using the HTTP protocol</li>
  <li>method(HttpMethod.POST) -&gt; using HTTP’s <em>POST</em> method</li>
  <li>path(“/users/${username}”) -&gt; to URI to send the HTTP request to</li>
</ul>

<p>The syntax <code class="highlighter-rouge">${variable-name}</code> is a variable placeholder used in citrus that gets resolved to the value of the variable at runtime. In the example above I use it for adding the variable <em>username</em> to the URI.</p>

<p>The second action is used for verifying that the server processes the request successfully. It expects a HTTP 200 code to be returned from the server.</p>

<p>You may be wondering how citrus knows which host and port to send the request to. It doesn’t, well not yet. I still have to configure this. This strange string <em>chatRestClient</em> is instructing citrus to find an endpoint using this name in the citrus configuration and use this endpoint for sending and receiving requests.</p>

<p>So I’m going to add this endpoint to the citrus-context.xml file now.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;citrus-http:client</span> <span class="na">id=</span><span class="s">"chatRestClient"</span>
                    <span class="na">request-url=</span><span class="s">"http://localhost:8090/"</span>
                    <span class="na">request-method=</span><span class="s">"POST"</span>
                    <span class="na">content-type=</span><span class="s">"application/json"</span>
                    <span class="na">timeout=</span><span class="s">"60000"</span><span class="nt">/&gt;</span></code></pre></figure>

<p>I have added a new HTTP client endpoint <em>chatRestClient</em> that sends requests to the base url <em>http://localhost:8090/</em>. By default the request method <em>POST</em> will be used with the content-type <em>application/json</em>, but both of these can be overloaded in the test. After sending a request citrus will wait 60 seconds for a reply from the server before timing out. And that’s it.</p>

<p>Now go ahead and run this test. If you have the application opened up in your browser then you will notice a new user joins the chat room when the test executes.</p>

<p>To complete the test I’m going to add the test actions for leaving the chat.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="o">[...]</span>

<span class="n">echo</span><span class="o">(</span><span class="s">"Leaving chat: ${username}"</span><span class="o">);</span>
<span class="n">send</span><span class="o">(</span><span class="s">"chatRestClient"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">""</span><span class="o">)</span>
        <span class="o">.</span><span class="na">http</span><span class="o">()</span>
        <span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="n">HttpMethod</span><span class="o">.</span><span class="na">DELETE</span><span class="o">)</span>
        <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">"/users/${username}"</span><span class="o">);</span>
<span class="n">receive</span><span class="o">(</span><span class="s">"chatRestClient"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">JSON</span><span class="o">)</span>
        <span class="o">.</span><span class="na">http</span><span class="o">()</span>
        <span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span></code></pre></figure>

<p>You will notice a lot of similarities to the join test actions. The only difference is that the HTTP method <em>DELETE</em> is used this time instead of <em>POST</em>.</p>

<p>You can run this test again if  you like and depending on how sharp your eyes are you may notice in your browser that a user joins and almost immediately leaves the chat room.</p>

<p>That’s it for the REST requests for the moment. Now I’m going to move onto WebSockets.</p>

<h2 id="simulating-the-stomp-notifications">Simulating the STOMP notifications</h2>

<p>Before I get into simulating STOMP notifications, I think its important to understand what STOMP is and how it’s used here.</p>

<p>STOMP is a <strong>S</strong> imple <strong>T</strong> ext <strong>O</strong> rientated <strong>M</strong> essaging <strong>P</strong> rotocol. It uses a frame-based protocol, shown below, for communicating between multiple hosts.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">COMMAND
header1:value1
header2:value2

Body^@</code></pre></figure>

<p>Each frame contains a single COMMAND, zero or more HEADERS, a BODY and the null character (^@) to terminate the frame.</p>

<p>In the chat room application the server sends all notifications to connected clients using this protocol. It does this using the WebSocket API since it enables bidirectional communication between the web server and clients. Each time an event occurs, like a user joining the chat room, this event data is then pushed to the clients from the server.</p>

<p>In STOMP there are different types of COMMANDs that can be sent:</p>

<ul>
  <li>
<em>CONNECT</em>: this is sent by a client to the server when it connects</li>
  <li>
<em>CONNECTED</em>: this is an acknowledgement sent by the server to a client on successful connection</li>
  <li>SUBSCRIBE_: this is sent by a client to the server to indicate that it is interested in certain types of messages. The client sends a destination header to indicate which messages it is interested in.</li>
  <li>MESSAGE_: this is sent by the server to the client when a destination, that the client has subscribed to, sends a message.</li>
  <li>DISCONNECT_: this is sent by the client to the server when its disconnecting.</li>
</ul>

<p>This is by no means an exhaustive list of commands but covers all commands used in the chat room application.</p>

<p>To put all that into perspective, this is basically what happens when the user <em>Joe Blogs</em> joins the chat room application:</p>

<ol>
  <li>The client opens a WebSocket connection to the server</li>
  <li>The client sends a <em>CONNECT</em> frame to the server</li>
</ol>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">CONNECT
accept-version:1.1
heart-beat:0,0</code></pre></figure>

<ol>
  <li>The sever sends a <em>CONNECTED</em> frame acknowledgement back to the client</li>
</ol>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">CONNECTED
version:1.1
heart-beat:0,0</code></pre></figure>

<ol>
  <li>The client sends a <em>SUBSCRIBE</em> frame to the server, indicating that it is interested in messages on the destination <em>/topic/users/joined</em>
</li>
</ol>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">SUBSCRIBE
<span class="nb">id</span>:sub-0
destination:/topic/users/joined</code></pre></figure>

<ol>
  <li>The user <em>Joe Blogs</em> joins the chat room (using the HTTP/REST interface)</li>
  <li>The server sends a <em>MESSAGE</em> frame to the client on the destination <em>/topic/users/joined</em> indicating that a user joined.</li>
</ol>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">MESSAGE
destination:/topic/users/joined
content-type:application/json<span class="p">;</span><span class="nv">charset</span><span class="o">=</span>UTF-8
subscription:sub-0
message-id:1-18
content-length:11

<span class="s2">"Joe Blogs"</span></code></pre></figure>

<p>So I’m going to try and pack all of this into a single test. I start by creating a new Java class <em>Test_02_StompIT</em>.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test_02_StompIT</span> <span class="kd">extends</span> <span class="n">TestNGCitrusTestDesigner</span> <span class="o">{</span>
    <span class="nd">@CitrusTest</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testJoining</span> <span class="o">()</span> <span class="o">{</span>
        <span class="n">variable</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span> <span class="s">"citrus:randomString(10, UPPERCASE)"</span><span class="o">);</span>

        <span class="n">echo</span><span class="o">(</span><span class="s">"Joining with user: ${username}"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Then I add the test actions for connecting to the STOMP server.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">send</span><span class="o">(</span><span class="err">“</span><span class="n">chatWebSocketClient</span><span class="err">”</span><span class="o">)</span>
            <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">"CONNECT\n"</span> <span class="o">+</span>
                    <span class="s">"accept-version:1.1\n"</span> <span class="o">+</span>
                    <span class="s">"heart-beat:0,0\n"</span> <span class="o">+</span>
                    <span class="s">"\n"</span> <span class="o">+</span> <span class="o">(</span><span class="kt">char</span><span class="o">)</span><span class="mi">0</span>
            <span class="o">);</span>

<span class="n">receive</span><span class="o">(</span><span class="err">“</span><span class="n">chatWebSocketClient</span><span class="err">”</span><span class="o">)</span>
                <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
                <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">"CONNECTED\n"</span> <span class="o">+</span>
                        <span class="s">"version:1.1\n"</span> <span class="o">+</span>
                        <span class="s">"heart-beat:0,0\n"</span> <span class="o">+</span>
                        <span class="s">"\n"</span> <span class="o">+</span> <span class="o">(</span><span class="kt">char</span><span class="o">)</span><span class="mi">0</span>
                <span class="o">);</span></code></pre></figure>

<p>So what is going on here?</p>

<p>The first test action is using the endpoint <em>chatWebSocketClient</em> to send the STOMP <em>CONNECT</em> frame to the server. The payload I just covered above only this time control characters like carriage return and the null character have been added.</p>

<p>The second test action is verifying the client was successfully connected. It compares the received payload from the server against the expected payload, which is specified in the test action. Only when both payloads match exactly will the action be successful.</p>

<p>Before I can execute my test I have to configure the <em>chatWebSocketClient</em> endpoint. Again this is done in the citrus-context.xml file by adding the following lines:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;citrus-websocket:client</span> <span class="na">id=</span><span class="s">"chatWebSocketClient"</span>
                         <span class="na">url=</span><span class="s">"ws://localhost:8090/chatEndpoint/websocket"</span>
                         <span class="na">timeout=</span><span class="s">"5000"</span><span class="nt">/&gt;</span></code></pre></figure>

<p>There’s nothing special here. I just added a websocket client endpoint that connects to the server on the url <em>ws://localhost:8090/chatEndpoint/websocket</em>.</p>

<p>Now you are good to go and you can run the test. If all goes well you should see a lot of console output with <em>SUCCESS</em> somewhere near the bottom.</p>

<p>Ok, so the test doesn’t really do a whole lot just yet. So I’m going to add the next test actions to subscribe to the destination <em>/topic/users/joined</em>, join the chat room and then finally verify that a STOMP <em>MESSAGE</em> frame is sent to indicate a user has joined.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">echo</span><span class="o">(</span><span class="s">"Subscribe to destination: /topic/users/joined"</span><span class="o">);</span>
<span class="n">send</span><span class="o">(</span><span class="s">"chatWebSocketClient"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">"SUBSCRIBE\n"</span> <span class="o">+</span>
                <span class="s">"id:sub-0\n"</span> <span class="o">+</span>
                <span class="s">"destination:/topic/users/joined\n"</span> <span class="o">+</span>
                <span class="s">"\n"</span> <span class="o">+</span> <span class="o">(</span><span class="kt">char</span><span class="o">)</span> <span class="mi">0</span>
        <span class="o">);</span>

<span class="n">echo</span><span class="o">(</span><span class="s">"Joining with user: ${username}"</span><span class="o">);</span>
<span class="n">send</span><span class="o">(</span><span class="s">"chatRestClient"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">""</span><span class="o">)</span>
        <span class="o">.</span><span class="na">http</span><span class="o">()</span>
        <span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="n">HttpMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
        <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">"/users/${username}"</span><span class="o">);</span>
<span class="n">receive</span><span class="o">(</span><span class="s">"chatRestClient"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">JSON</span><span class="o">)</span>
        <span class="o">.</span><span class="na">http</span><span class="o">()</span>
        <span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>

<span class="n">echo</span><span class="o">(</span><span class="s">"Verify user-joined notification is received"</span><span class="o">);</span>
<span class="n">receive</span><span class="o">(</span><span class="s">"chatWebSocketClient"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
        <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">"MESSAGE\n"</span> <span class="o">+</span>
                <span class="s">"destination:/topic/users/joined\n"</span> <span class="o">+</span>
                <span class="s">"content-type:application/json;charset=UTF-8\n"</span> <span class="o">+</span>
                <span class="s">"subscription:sub-0\n"</span> <span class="o">+</span>
                <span class="s">"message-id:6-21\n"</span> <span class="o">+</span>
                <span class="s">"content-length:12\n"</span> <span class="o">+</span>
                <span class="s">"\n"</span> <span class="o">+</span>
                <span class="s">"\"${username}\""</span> <span class="o">+</span> <span class="o">(</span><span class="kt">char</span><span class="o">)</span> <span class="mi">0</span>
        <span class="o">);</span></code></pre></figure>

<p>If you look carefully at the last test action, the MESSAGE frame, you will notice the <em>message-id</em> header. The server sets the value of this header dynamically so the exact payload comparison done here is bound to fail, unless of course you are incredibly lucky. So how do I get around this problem?</p>

<p>Thanks to citrus there are many ways to solve this problem:</p>

<ul>
  <li>Remove the payload verification from the test action - This just ignores the problem for the time being but doesn’t fix it.</li>
  <li>Do a partial payload verification – It’s possible to just search for certain strings in the payload, ignoring the rest.</li>
  <li>Unmarshall the payload, converting it into a java object and verify the individual attributes – This is slightly more complicated but offers by far the most flexibility.</li>
</ul>

<p>For the moment I’m going to go with partial payload verification. When using the Citrus Java DSL you can easily do this with a ValidationCallback as shown below:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">echo</span><span class="o">(</span><span class="s">"Verify user-joined notification is received"</span><span class="o">);</span>
<span class="n">receive</span><span class="o">(</span><span class="s">"chatWebSocketClient"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
        <span class="o">.</span><span class="na">validationCallback</span><span class="o">(</span><span class="k">new</span> <span class="n">AbstractValidationCallback</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">validate</span><span class="o">(</span><span class="n">String</span> <span class="n">payload</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">headers</span><span class="o">,</span> <span class="n">TestContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">payload</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"MESSAGE\n"</span><span class="o">));</span>
                <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">payload</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"destination:/topic/users/joined\n"</span><span class="o">));</span>
                <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">payload</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"subscription:sub-0\n"</span><span class="o">));</span>
                <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">payload</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getVariable</span><span class="o">(</span><span class="s">"username"</span><span class="o">)));</span>
            <span class="o">}</span>
        <span class="o">});</span></code></pre></figure>

<p>Great. Go ahead and run the test. This time it should run successfully.</p>

<h2 id="cleaning-up-the-test">Cleaning up the test</h2>

<p>So far I’ve covered a user joining the chat room. I still have to verify that rooms can be created, removed, messages can be sent, notifications for the above are received, etc. But before I do this lets take a step back and look at our test so far.</p>

<p>It’s not bad, but it could be cleaned it somewhat. There are too many concatenated strings, too many carriage returns and other funny characters. It’s too hard to read. It would be great if I could use a fluid API for generating the STOMP frames. And since I’m planning on verifying and extracting data from the received payloads it would be equally cool if this could be somehow unmarshalled. Well guess what, you can do this with citrus. This is what I was talking about earlier when I mentioned how important it is to pick an integration test tool that is flexible. It’s not that citrus supports STOMP out of the box, because it doesn’t, at least not yet. However through its flexible API it enables a tester to add support for features or behaviour that is currently not supported. And this is what I’m going to show you now when I clean up or refactor this test.</p>

<p>I’ll leave the other test class in place and create a new test class <em>Test_03_StompIT</em>, copying over the contents of the original.</p>

<p>I’ll begin by creating a new StompFrame class, which is just a container for holding a STOMP frame in a structured way.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StompFrame</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">command</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashMap</span><span class="o">&lt;&gt;();</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">body</span><span class="o">;</span>

    <span class="c1">// getters/setters….</span>

<span class="o">}</span></code></pre></figure>

<p>Then I add a StompFrameBuilder class that uses the builder pattern for creating STOMP frames.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StompFrameBuilder</span> <span class="o">{</span>
    <span class="n">StompFrame</span> <span class="n">stompFrame</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StompFrame</span><span class="o">();</span>

    <span class="kd">public</span> <span class="n">StompFrameBuilder</span> <span class="nf">withCommand</span><span class="o">(</span><span class="n">String</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">stompFrame</span><span class="o">.</span><span class="na">setCommand</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">StompFrameBuilder</span> <span class="nf">withHeader</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">stompFrame</span><span class="o">.</span><span class="na">addHeader</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">StompFrameBuilder</span> <span class="nf">withBody</span><span class="o">(</span><span class="n">String</span> <span class="n">body</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">stompFrame</span><span class="o">.</span><span class="na">setBody</span><span class="o">(</span><span class="n">body</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">StompFrame</span> <span class="nf">build</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">stompFrame</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>And finally I’ll add a static method to the StompFrame class to convert a STOMP frame into the expected wire format.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">toWireFormat</span><span class="o">(</span><span class="n">StompFrame</span> <span class="n">stompFrame</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">StringBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>

    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">stompFrame</span><span class="o">.</span><span class="na">getCommand</span><span class="o">());</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>

    <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">header</span> <span class="o">:</span> <span class="n">stompFrame</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">().</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">header</span><span class="o">.</span><span class="na">getKey</span><span class="o">());</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">":"</span><span class="o">);</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">header</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">if</span><span class="o">(</span><span class="n">stompFrame</span><span class="o">.</span><span class="na">hasBody</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">stompFrame</span><span class="o">.</span><span class="na">getBody</span><span class="o">());</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">((</span><span class="kt">char</span><span class="o">)</span><span class="mi">0</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
<span class="o">}</span></code></pre></figure>

<p>After some refactoring I end up with the following test class:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test_03_StompIT</span> <span class="kd">extends</span> <span class="n">TestNGCitrusTestDesigner</span> <span class="o">{</span>

    <span class="nd">@CitrusTest</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testJoiningAndLeaving</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">variable</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span> <span class="s">"citrus:randomString(10, UPPERCASE)"</span><span class="o">);</span>

        <span class="n">echo</span><span class="o">(</span><span class="s">"Connecting to server with STOMP"</span><span class="o">);</span>
        <span class="n">send</span><span class="o">(</span><span class="s">"chatWebSocketClient"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="n">StompFrame</span><span class="o">.</span><span class="na">toWireFormat</span><span class="o">(</span><span class="k">new</span> <span class="n">StompFrameBuilder</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">withCommand</span><span class="o">(</span><span class="s">"CONNECT"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">withHeader</span><span class="o">(</span><span class="s">"accept-version"</span><span class="o">,</span> <span class="s">"1.1"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">withHeader</span><span class="o">(</span><span class="s">"heart-beat"</span><span class="o">,</span> <span class="s">"0,0"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">build</span><span class="o">()));</span>

        <span class="n">echo</span><span class="o">(</span><span class="s">"Verify connection is successful"</span><span class="o">);</span>
        <span class="n">receive</span><span class="o">(</span><span class="s">"chatWebSocketClient"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
                <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="n">StompFrame</span><span class="o">.</span><span class="na">toWireFormat</span><span class="o">(</span><span class="k">new</span> <span class="n">StompFrameBuilder</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">withCommand</span><span class="o">(</span><span class="s">"CONNECTED"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">withHeader</span><span class="o">(</span><span class="s">"version"</span><span class="o">,</span> <span class="s">"1.1"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">withHeader</span><span class="o">(</span><span class="s">"heart-beat"</span><span class="o">,</span> <span class="s">"0,0"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">build</span><span class="o">()));</span>

        <span class="n">echo</span><span class="o">(</span><span class="s">"Subscribe to destination: /topic/users/joined"</span><span class="o">);</span>
        <span class="n">send</span><span class="o">(</span><span class="s">"chatWebSocketClient"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="n">StompFrame</span><span class="o">.</span><span class="na">toWireFormat</span><span class="o">(</span><span class="k">new</span> <span class="n">StompFrameBuilder</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">withCommand</span><span class="o">(</span><span class="s">"SUBSCRIBE"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">withHeader</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="s">"sub-0"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">withHeader</span><span class="o">(</span><span class="s">"destination"</span><span class="o">,</span> <span class="s">"/topic/users/joined"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">build</span><span class="o">()));</span>

        <span class="n">echo</span><span class="o">(</span><span class="s">"Joining with user: ${username}"</span><span class="o">);</span>
        <span class="n">send</span><span class="o">(</span><span class="s">"chatRestClient"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">""</span><span class="o">)</span>
                <span class="o">.</span><span class="na">http</span><span class="o">()</span>
                <span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="n">HttpMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
                <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">"/users/${username}"</span><span class="o">);</span>
        <span class="n">receive</span><span class="o">(</span><span class="s">"chatRestClient"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">JSON</span><span class="o">)</span>
                <span class="o">.</span><span class="na">http</span><span class="o">()</span>
                <span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>

        <span class="n">echo</span><span class="o">(</span><span class="s">"Verify user-joined notification is received"</span><span class="o">);</span>
        <span class="n">receive</span><span class="o">(</span><span class="s">"chatWebSocketClient"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
                <span class="o">.</span><span class="na">validationCallback</span><span class="o">(</span><span class="k">new</span> <span class="n">AbstractValidationCallback</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">validate</span><span class="o">(</span><span class="n">String</span> <span class="n">payload</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">headers</span><span class="o">,</span> <span class="n">TestContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">payload</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"MESSAGE\n"</span><span class="o">));</span>
                        <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">payload</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"destination:/topic/users/joined\n"</span><span class="o">));</span>
                        <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">payload</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"subscription:sub-0\n"</span><span class="o">));</span>
                        <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">payload</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getVariable</span><span class="o">(</span><span class="s">"username"</span><span class="o">)));</span>
                    <span class="o">}</span>
                <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>I’m not quite there yet but at least it’s slightly easier on the eye. I’m still validating the MESSAGE frame using partial string comparisons, so I’m going to clean that up as well now.</p>

<p>To do that I first need to add a second static method to the StompFrame class to convert the wire format into a StompFrame.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="n">StompFrame</span> <span class="nf">fromWireFormat</span><span class="o">(</span><span class="n">String</span> <span class="n">payload</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">StompFrame</span> <span class="n">stompFrame</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StompFrame</span><span class="o">();</span>

    <span class="kt">int</span> <span class="n">separateAt</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">"\n\n"</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">header</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">separateAt</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">body</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">separateAt</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>

    <span class="n">StringTokenizer</span> <span class="n">stringTokenizer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringTokenizer</span><span class="o">(</span><span class="n">header</span><span class="o">,</span> <span class="s">"\n"</span><span class="o">);</span>

    <span class="c1">// set command</span>
    <span class="n">stompFrame</span><span class="o">.</span><span class="na">setCommand</span><span class="o">(</span><span class="n">stringTokenizer</span><span class="o">.</span><span class="na">nextToken</span><span class="o">());</span>

    <span class="c1">// add headers</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">stringTokenizer</span><span class="o">.</span><span class="na">hasMoreTokens</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">stringTokenizer</span><span class="o">.</span><span class="na">nextToken</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">token</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">token</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">Character</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="sc">':'</span><span class="o">)))</span> <span class="o">{</span>
            <span class="n">String</span><span class="o">[]</span> <span class="n">keyValue</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">":"</span><span class="o">);</span>
            <span class="n">stompFrame</span><span class="o">.</span><span class="na">addHeader</span><span class="o">(</span><span class="n">keyValue</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="n">keyValue</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// add body</span>
    <span class="n">stompFrame</span><span class="o">.</span><span class="na">setBody</span><span class="o">(</span><span class="n">stripNullCharacter</span><span class="o">(</span><span class="n">body</span><span class="o">));</span>

    <span class="k">return</span> <span class="n">stompFrame</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>Now I can finally refactor the validation callback:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">echo</span><span class="o">(</span><span class="s">"Verify user-joined notification is received"</span><span class="o">);</span>
<span class="n">receive</span><span class="o">(</span><span class="s">"chatWebSocketClient"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
        <span class="o">.</span><span class="na">validationCallback</span><span class="o">(</span><span class="k">new</span> <span class="n">AbstractValidationCallback</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">validate</span><span class="o">(</span><span class="n">String</span> <span class="n">payload</span><span class="o">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">headers</span><span class="o">,</span> <span class="n">TestContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">StompFrame</span> <span class="n">stompFrame</span> <span class="o">=</span> <span class="n">StompFrame</span><span class="o">.</span><span class="na">fromWireFormat</span><span class="o">(</span><span class="n">payload</span><span class="o">);</span>
                <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">stompFrame</span><span class="o">.</span><span class="na">getCommand</span><span class="o">(),</span> <span class="s">"MESSAGE"</span><span class="o">);</span>
                <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">stompFrame</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"destination"</span><span class="o">),</span> <span class="s">"/topic/users/joined"</span><span class="o">);</span>
                <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">stompFrame</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"subscription"</span><span class="o">),</span> <span class="s">"sub-0"</span><span class="o">);</span>
                <span class="n">String</span> <span class="n">expectedUsername</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"\"%s\""</span><span class="o">,</span> <span class="n">context</span><span class="o">.</span><span class="na">getVariable</span><span class="o">(</span><span class="s">"username"</span><span class="o">));</span>
                <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">stompFrame</span><span class="o">.</span><span class="na">getBody</span><span class="o">(),</span> <span class="n">expectedUsername</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span></code></pre></figure>

<p>I’m done.</p>

<h1 id="wrap-up">Wrap-up</h1>

<p>I added one final test class <em>Test_04_CompleteIT</em> which simulates all REST and STOMP communication in one single test including</p>

<ul>
  <li>subscribing to all STOMP topics,</li>
  <li>joining the chat,</li>
  <li>creating a room,</li>
  <li>sending a message,</li>
  <li>deleting a room</li>
  <li>and finally leaving the chat</li>
</ul>

<p>You can find it in my git repository along with all the other tests.</p>

<p>I hope I have inspired you in this blog to at least consider Citrus when you’re thinking about integration tests in the next or even current project. Although I concentrated mainly on testing a web application here, you can use Citrus for just about all integration test scenarios you can imagine. It’s used a lot in middleware applications, which is one of the reasons the test framework was developed to begin with, but it’s not limited to middleware as is hopefully demonstrated above.</p>

  </div>
</article>


  <article>
  <h2>
    Arquillian &amp; Citrus in combination - Part 2
    <a href="/news/2015/08/19/arquillian-extension-part-2/" class="permalink" title="Permalink">∞</a>
  </h2>
  <span class="post-category">
    <span class="label">
      blog
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      19 Aug 2015
    </span>
    <a href="https://github.com/christophd" class="post-author">
      
      Christoph Deppisch
    </a>
  </div>
  <div class="post-content">
    <p>Some time has passed since <a href="/news/2015/06/29/arquillian-extension-part-1">part one</a> of this blog post series and we have made some improvements on the Citrus Arquillian extension.
So we can look forward to this post as we move on with a more complex test scenario where we include some Citrus mail server within our test. In part one we have already combined both frameworks <a href="http://arquillian.org/" title="Arquillian" target="_blank">Arquillian</a>
and <a href="http://www.citrusframework.org" title="Citrus framework" target="_blank">Citrus</a> with a basic example.</p>

<p>Let me recap first what we have so far. Citrus is part of the Arquillian test execution and we are able to call our employee REST JEE service which is deployed in an embedded Wildfly application server.
Arquillian takes care on the test deployment and provides resources such as the endpoint URL to call. In our first test we called the employee service adding new employees and getting the complete list of all employees via REST.</p>

<p>Now we want to extend the employee service so that each new employee gets a welcome email message. Therefore we extend the employee JEE EJB with a mail session bean that is able to send email messages.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Singleton</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmployeeRepository</span> <span class="o">{</span>

   <span class="kd">private</span> <span class="kd">final</span> <span class="n">Employees</span> <span class="n">employees</span><span class="o">;</span>

   <span class="nd">@EJB</span>
   <span class="kd">private</span> <span class="n">MailSessionBean</span> <span class="n">mailSessionBean</span><span class="o">;</span>

   <span class="kd">public</span> <span class="nf">EmployeeRepository</span><span class="o">()</span> <span class="o">{</span>
       <span class="n">employees</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Employees</span><span class="o">();</span>
   <span class="o">}</span>

   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addEmployee</span><span class="o">(</span><span class="n">Employee</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
       <span class="n">employees</span><span class="o">.</span><span class="na">getEmployees</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>

       <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getEmail</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">e</span><span class="o">.</span><span class="na">getEmail</span><span class="o">().</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">mailSessionBean</span><span class="o">.</span><span class="na">sendMail</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getEmail</span><span class="o">(),</span> <span class="s">"Welcome new employee"</span><span class="o">,</span>
           <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"We welcome you '%s' to our company - now get to work!"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getName</span><span class="o">()));</span>
       <span class="o">}</span>
   <span class="o">}</span>

   <span class="kd">public</span> <span class="n">Employees</span> <span class="nf">getEmployees</span><span class="o">()</span> <span class="o">{</span>
       <span class="k">return</span> <span class="n">employees</span><span class="o">;</span>
   <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>The employee service calls a mail session bean implementation when the email field is set on the new employee. The mail message is sent to the employee mail address as recipient and is a basic text message with subject and text body part.
Lets have a closer look at the mail session bean implementation that uses Java mail API for creating sending out the mail mime message.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Singleton</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MailSessionBean</span> <span class="o">{</span>

    <span class="cm">/** Logger */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">MailSessionBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">2222</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">host</span> <span class="o">=</span> <span class="s">"localhost"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">from</span> <span class="o">=</span> <span class="s">"employee-registry@example.com"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="s">"employee-registry@example.com"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="s">"secretpw"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendMail</span><span class="o">(</span><span class="n">String</span> <span class="n">to</span><span class="o">,</span> <span class="n">String</span> <span class="n">subject</span><span class="o">,</span> <span class="n">String</span> <span class="n">body</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
        <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"mail.smtp.host"</span><span class="o">,</span> <span class="n">host</span><span class="o">);</span>
        <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"mail.smtp.port"</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
        <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"mail.smtp.auth"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>

        <span class="n">Authenticator</span> <span class="n">authenticator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Authenticator</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">private</span> <span class="n">PasswordAuthentication</span> <span class="n">pa</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PasswordAuthentication</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">PasswordAuthentication</span> <span class="nf">getPasswordAuthentication</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">pa</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">};</span>

        <span class="n">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">props</span><span class="o">,</span> <span class="n">authenticator</span><span class="o">);</span>
        <span class="n">session</span><span class="o">.</span><span class="na">setDebug</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">MimeMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MimeMessage</span><span class="o">(</span><span class="n">session</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">message</span><span class="o">.</span><span class="na">setFrom</span><span class="o">(</span><span class="k">new</span> <span class="n">InternetAddress</span><span class="o">(</span><span class="n">from</span><span class="o">));</span>
            <span class="n">InternetAddress</span><span class="o">[]</span> <span class="n">address</span> <span class="o">=</span> <span class="o">{</span><span class="k">new</span> <span class="n">InternetAddress</span><span class="o">(</span><span class="n">to</span><span class="o">)};</span>
            <span class="n">message</span><span class="o">.</span><span class="na">setRecipients</span><span class="o">(</span><span class="n">Message</span><span class="o">.</span><span class="na">RecipientType</span><span class="o">.</span><span class="na">TO</span><span class="o">,</span> <span class="n">address</span><span class="o">);</span>
            <span class="n">message</span><span class="o">.</span><span class="na">setSubject</span><span class="o">(</span><span class="n">subject</span><span class="o">);</span>
            <span class="n">message</span><span class="o">.</span><span class="na">setSentDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
            <span class="n">message</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">body</span><span class="o">);</span>
            <span class="n">Transport</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">MessagingException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Failed to send welcome mail!"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Now in our test scenario we need a valid SMTP mail server on host <strong>localhost</strong> and port <strong>2222</strong>. Fortunately Citrus is able to provide such a mail server so we add the <strong>citrus-mail</strong> Maven module to our test project.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.consol.citrus<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>citrus-mail<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>2.3<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></figure>

<p>Now we are ready to add the mail server as a Citrus component. Citrus is working with Spring so we need to add the mail server to the Spring application context. We add a new property to the Arquillian descriptor so the Citrus extension will
load our new configuration:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;extension</span> <span class="na">qualifier=</span><span class="s">"citrus"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"citrusVersion"</span><span class="nt">&gt;</span>2.3<span class="nt">&lt;/property&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"autoPackage"</span><span class="nt">&gt;</span>true<span class="nt">&lt;/property&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"suiteName"</span><span class="nt">&gt;</span>citrus-arquillian-suite<span class="nt">&lt;/property&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"configurationClass"</span><span class="nt">&gt;</span>com.consol.citrus.samples.javaee.config.CitrusConfig<span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/extension&gt;</span></code></pre></figure>

<p>The configuration class is a Spring Java configuration class in our project that adds the new mail server as Spring bean to the application context.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CitrusConfig</span> <span class="kd">extends</span> <span class="n">CitrusBaseConfig</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">MailServer</span> <span class="n">mailServer</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">MailServer</span> <span class="nf">mailServer</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mailServer</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mailServer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MailServer</span><span class="o">();</span>
            <span class="n">mailServer</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">2222</span><span class="o">);</span>
            <span class="n">mailServer</span><span class="o">.</span><span class="na">setAutoStart</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">mailServer</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>The configuration class must extend the Citrus base configuration class. This basic class adds all needed Spring beans for Citrus such as message validators, functions, validation matchers and so on. Important is our new mail server that uses the port
<strong>2222</strong> and automatically starts with the Citrus application context. This is everything we need to do in order to add the mail server component to the Citrus runtime. We can add other Citrus endpoint components such as JMS endpoints, SOAP WebService servers
and Camel endpoints here the same way. For now we are finished with the configuration and we can reference the mail server in our test case.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@RunWith</span><span class="o">(</span><span class="n">Arquillian</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@RunAsClient</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmployeeMailTest</span> <span class="o">{</span>

    <span class="nd">@CitrusFramework</span>
    <span class="kd">private</span> <span class="n">Citrus</span> <span class="n">citrusFramework</span><span class="o">;</span>

    <span class="nd">@ArquillianResource</span>
    <span class="kd">private</span> <span class="n">URL</span> <span class="n">baseUri</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">serviceUri</span><span class="o">;</span>

    <span class="nd">@CitrusEndpoint</span>
    <span class="kd">private</span> <span class="n">MailServer</span> <span class="n">mailServer</span><span class="o">;</span>

    <span class="nd">@Deployment</span><span class="o">(</span><span class="n">testable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">WebArchive</span> <span class="nf">createDeployment</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ShrinkWrap</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">WebArchive</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">addClasses</span><span class="o">(</span>
                <span class="n">RegistryApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">MailSessionBean</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">EmployeeResource</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                <span class="n">Employees</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">EmployeeRepository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Before</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">serviceUri</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="n">baseUri</span><span class="o">,</span> <span class="s">"registry/employee"</span><span class="o">).</span><span class="na">toExternalForm</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="nd">@CitrusTest</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testPostWithWelcomeEmail</span><span class="o">(</span><span class="nd">@CitrusResource</span> <span class="n">TestDesigner</span> <span class="n">citrus</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">citrus</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">serviceUri</span><span class="o">)</span>
            <span class="o">.</span><span class="na">fork</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
            <span class="o">.</span><span class="na">message</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpMessage</span><span class="o">(</span><span class="s">"name=Rajesh&amp;age=20&amp;email=rajesh@example.com"</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="n">HttpMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">contentType</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_FORM_URLENCODED</span><span class="o">));</span>

        <span class="n">citrus</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="n">mailServer</span><span class="o">)</span>
            <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">"&lt;mail-message xmlns=\"http://www.citrusframework.org/schema/mail/message\"&gt;"</span> <span class="o">+</span>
              <span class="s">"&lt;from&gt;employee-registry@example.com&lt;/from&gt;"</span> <span class="o">+</span>
              <span class="s">"&lt;to&gt;rajesh@example.com&lt;/to&gt;"</span> <span class="o">+</span>
              <span class="s">"&lt;cc&gt;&lt;/cc&gt;"</span> <span class="o">+</span>
              <span class="s">"&lt;bcc&gt;&lt;/bcc&gt;"</span> <span class="o">+</span>
              <span class="s">"&lt;subject&gt;Welcome new employee&lt;/subject&gt;"</span> <span class="o">+</span>
              <span class="s">"&lt;body&gt;"</span> <span class="o">+</span>
                <span class="s">"&lt;contentType&gt;text/plain; charset=us-ascii&lt;/contentType&gt;"</span> <span class="o">+</span>
                <span class="s">"&lt;content&gt;We welcome you 'Rajesh' to our company - now get to work!&lt;/content&gt;"</span> <span class="o">+</span>
              <span class="s">"&lt;/body&gt;"</span> <span class="o">+</span>
            <span class="s">"&lt;/mail-message&gt;"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="n">CitrusMailMessageHeaders</span><span class="o">.</span><span class="na">MAIL_SUBJECT</span><span class="o">,</span> <span class="s">"Welcome new employee"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="n">CitrusMailMessageHeaders</span><span class="o">.</span><span class="na">MAIL_FROM</span><span class="o">,</span> <span class="s">"employee-registry@example.com"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="n">CitrusMailMessageHeaders</span><span class="o">.</span><span class="na">MAIL_TO</span><span class="o">,</span> <span class="s">"rajesh@example.com"</span><span class="o">);</span>

        <span class="n">citrus</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="n">serviceUri</span><span class="o">)</span>
            <span class="o">.</span><span class="na">message</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpMessage</span><span class="o">()</span>
                <span class="o">.</span><span class="na">statusCode</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">NO_CONTENT</span><span class="o">));</span>

        <span class="n">citrus</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">serviceUri</span><span class="o">)</span>
            <span class="o">.</span><span class="na">fork</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
            <span class="o">.</span><span class="na">message</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpMessage</span><span class="o">()</span>
                <span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="n">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
                <span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_XML</span><span class="o">));</span>

        <span class="n">citrus</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="n">serviceUri</span><span class="o">)</span>
            <span class="o">.</span><span class="na">message</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpMessage</span><span class="o">(</span><span class="s">"&lt;employees&gt;"</span> <span class="o">+</span>
                    <span class="s">"&lt;employee&gt;"</span> <span class="o">+</span>
                        <span class="s">"&lt;age&gt;20&lt;/age&gt;"</span> <span class="o">+</span>
                        <span class="s">"&lt;name&gt;Rajesh&lt;/name&gt;"</span> <span class="o">+</span>
                        <span class="s">"&lt;email&gt;rajesh@example.com&lt;/email&gt;"</span> <span class="o">+</span>
                    <span class="s">"&lt;/employee&gt;"</span> <span class="o">+</span>
                <span class="s">"&lt;/employees&gt;"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">statusCode</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">));</span>

        <span class="n">citrusFramework</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">citrus</span><span class="o">.</span><span class="na">getTestCase</span><span class="o">());</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre></figure>

<p>The Arquillian test case is basically the same as before in our first part example. The test now uses a <strong><a href="https://github.com/CitrusEndpoint" class="user-mention">@CitrusEndpoint</a></strong> annotated mail server component. The Arquillian Citrus extension will automatically inject the
mail server Spring bean that we have added to the Citrus configuration before. In case multiple components of the same type are available in the configuration you can use the <strong><a href="https://github.com/CitrusEndpoint" class="user-mention">@CitrusEndpoint</a></strong> annotation with a Spring bean name
like <strong><a href="https://github.com/CitrusEndpoint" class="user-mention">@CitrusEndpoint</a>(name=”myMailServer”)</strong>. We receive the mail message right after the test has called the service interface with the new employee <strong>Rajesh</strong> and a valid email field <strong>rajesh@example.com</strong>. The mail server Citrus component
is ready to be used in a <strong>receive</strong> test action. Citrus waits for the mail message to arrive and performs message validation with an expected mail message. Citrus automatically converts the mail mime message to a XML message representation.
We can expect the mail message content much better using the XML syntax as we can use the powerful XML validation with XPath, ignore and validation matcher support.</p>

<p>In addition to that Citrus adds some special header values for explicit validation in the <strong>receive</strong> action. That completes the mail server test case. Citrus automatically start a SMTP server that receives the mail message. The mail is not sent to
a real recipient we just want to validate the mail message content in our test. The mail server did automatically accept the authentication in default mode. We could also switch to advanced mode where we can also validate the authentication steps. For now we keep
it simple and are happy to receive the mail message. Please note that we can mix the receive actions of different interfaces in Citrus very easy. Citrus acts both as client and server on our REST and mail interfaces in the test.</p>

<p>This should close the book for this post. You can review the example code on <a href="https://github.com/citrusframework/citrus-samples/tree/master/javaee" title="Sample code" target="_blank">christophd@github</a>. In a next post I will show you how we can execute
the test as part of the test deployment on the application server. Then we have direct access to container managed resources such as JMS connection factories and queues. Once again, stay tuned!</p>

  </div>
</article>


  <article>
  <h2>
    Arquillian &amp; Citrus in combination - Part 1
    <a href="/news/2015/06/29/arquillian-extension-part-1/" class="permalink" title="Permalink">∞</a>
  </h2>
  <span class="post-category">
    <span class="label">
      blog
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      29 Jun 2015
    </span>
    <a href="https://github.com/christophd" class="post-author">
      
      Christoph Deppisch
    </a>
  </div>
  <div class="post-content">
    <p><a href="http://www.citrusframework.org" title="Citrus framework" target="_blank">Citrus</a> and <a href="http://arquillian.org/" title="Arquillian" target="_blank">Arquillian</a>
both refer to themselves as integration test frameworks. Following from that you might think these frameworks somehow ship the same package but this is not the case. In fact the frameworks work
brilliant together when it comes to automate the integration testing of JEE applications.</p>

<p>Arquillian has a focus on simplifying the archive deployment with the ability to run integration test cases inside the boundaries of an application container.
The tests are literally part of a server deployment. This approach brings great advantages such as accessing deployment and container resources within the test case.
The application is deployed to a real application server (e.g. Tomcat, Wildfly) which is a good idea as we then also test our application server configuration and we load
the application with all container managed resources such as database connections, JNDI resources and so on. Secondly the test case itself is able to directly use the
container managed resources with injection in the Arquillian test case which is a great thing to do! It becomes very easy to invoke your services in a close to production
nature then.</p>

<p>Citrus primarily has the objective to simplify the usage of different messaging transports in a test case. Citrus offers ready to use components for sending and receiving
messages as a client or server and helps to design a message flow across multiple service calls.</p>

<p>In combination the two frameworks manage complex integration test scenarios that perform fully automated. And this is what we want to have at the end of a day - fully automated integration tests.
The magic is possible since Arquillian offers a great extension mechanism and Citrus provides an Arquillian extension module. Once the extension is enabled in your Arquillian project
you can use Citrus features and components within a your Arquillian test case.</p>

<p>Lets have a look at this with a small example:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;extension</span> <span class="na">qualifier=</span><span class="s">"citrus"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"citrusVersion"</span><span class="nt">&gt;</span>2.2<span class="nt">&lt;/property&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"autoPackage"</span><span class="nt">&gt;</span>true<span class="nt">&lt;/property&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"suiteName"</span><span class="nt">&gt;</span>citrus-arquillian-suite<span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/extension&gt;</span></code></pre></figure>

<p>The extension configuration is placed in the basic Arquillian descriptor called <strong>arquillian.xml</strong>. We use the <em>citrus</em> qualifier so the settings are automatically loaded with the Citrus extension.</p>

<p>For now the possible extension settings are:</p>

<ul>
  <li>
<strong>citrusVersion:</strong> The explicit version of Citrus that should be used. Be sure to have the same library version available in your project (e.g. as Maven dependency). This property is optional. By default the extension just uses the latest stable version.</li>
  <li>
<strong>autoPackage:</strong> When true (default setting) the extension will automatically add Citrus libraries and all transitive dependencies to the test deployment. This automatically enables you to use the Citrus API inside the Arquillian test even when the test is executed inside the application container.</li>
  <li>
<strong>suiteName:</strong> This optional setting defines the name of the test suite that is used for the Citrus test run. When using before/after suite functionality in Citrus this setting might be of interest.</li>
  <li>
<strong>configurationClass:</strong> Full qualified Java class name of customized Citrus Spring bean configuration to use when loading the Citrus Spring application context. As a user you can define a custom Citrus configuration with this optional setting.</li>
</ul>

<p>So we also need to add the Citrus Maven dependency to our project:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.consol.citrus<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>citrus-arquillian<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>2.2<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></figure>

<p>The dependency automatically adds the required Citrus core dependencies so you are ready to work with Citrus framework components. In case you want to use special Citrus components like JMS, FTP, Mail or something like that you need to
add these modules each separately to your Maven POM, too. For now we want to use Http clients and the Citrus Java DSL so lets add the dependencies for that.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.consol.citrus<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>citrus-http<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>2.2<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.consol.citrus<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>citrus-java-dsl<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>2.2<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></figure>

<p>Now we are ready to integrate Citrus in a first Arquillian test case:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@RunWith</span><span class="o">(</span><span class="n">Arquillian</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@RunAsClient</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmployeeResourceTest</span> <span class="o">{</span>

    <span class="nd">@CitrusFramework</span>
    <span class="kd">private</span> <span class="n">Citrus</span> <span class="n">citrusFramework</span><span class="o">;</span>

    <span class="nd">@ArquillianResource</span>
    <span class="kd">private</span> <span class="n">URL</span> <span class="n">baseUri</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">serviceUri</span><span class="o">;</span>

    <span class="nd">@Deployment</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">WebArchive</span> <span class="nf">createDeployment</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">ShrinkWrap</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">WebArchive</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">addClasses</span><span class="o">(</span><span class="n">RegistryApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">EmployeeResource</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                <span class="n">Employees</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Employee</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">EmployeeRepository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Before</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">MalformedURLException</span> <span class="o">{</span>
        <span class="n">serviceUri</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="n">baseUri</span><span class="o">,</span> <span class="s">"registry/employee"</span><span class="o">).</span><span class="na">toExternalForm</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
    * Test adding new employees and getting list of all employees.
    */</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCreateEmployeeAndGet</span><span class="o">(</span><span class="nd">@CitrusTest</span> <span class="n">CitrusTestBuilder</span> <span class="n">citrus</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">citrus</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">serviceUri</span><span class="o">)</span>
            <span class="o">.</span><span class="na">message</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpMessage</span><span class="o">(</span><span class="s">"name=Penny&amp;age=20"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="n">HttpMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
            <span class="o">.</span><span class="na">contentType</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_FORM_URLENCODED</span><span class="o">));</span>

        <span class="n">citrus</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="n">serviceUri</span><span class="o">)</span>
            <span class="o">.</span><span class="na">message</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpMessage</span><span class="o">()</span>
            <span class="o">.</span><span class="na">statusCode</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">NO_CONTENT</span><span class="o">));</span>

        <span class="n">citrus</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">serviceUri</span><span class="o">)</span>
            <span class="o">.</span><span class="na">message</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpMessage</span><span class="o">()</span>
            <span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="n">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
            <span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_XML</span><span class="o">));</span>

        <span class="n">citrus</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="n">serviceUri</span><span class="o">)</span>
        <span class="o">.</span><span class="na">message</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpMessage</span><span class="o">(</span><span class="s">"&lt;employees&gt;"</span> <span class="o">+</span>
            <span class="s">"&lt;employee&gt;"</span> <span class="o">+</span>
              <span class="s">"&lt;age&gt;20&lt;/age&gt;"</span> <span class="o">+</span>
              <span class="s">"&lt;name&gt;Penny&lt;/name&gt;"</span> <span class="o">+</span>
              <span class="s">"&lt;/employee&gt;"</span> <span class="o">+</span>
            <span class="s">"&lt;/employees&gt;"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">statusCode</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">));</span>

        <span class="n">citrusFramework</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">citrus</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>As you can see this is a normal Arquillian JUnit test case. We are running the test in client mode with the <strong><a href="https://github.com/RunAsClient" class="user-mention">@RunAsClient</a></strong> annotation. As the
Citrus extension is active in background we are able to inject the framework instance with the <strong><a href="https://github.com/CitrusFramework" class="user-mention">@CitrusFramework</a></strong> annotation. The Citrus
framework instance is automatically loaded and configured with all necessary settings in background when the Arquillian test starts. As usual
we can build the deployment archive with our server resources that we need to test and we have access to <strong><a href="https://github.com/ArquillianResource" class="user-mention">@ArquillianResource</a></strong> annotated
resources such as the REST service endpoint URI of our application.</p>

<p>The test method itself is provided with a <strong><a href="https://github.com/CitrusTest" class="user-mention">@CitrusTest</a></strong> annotated method parameter that represents the Citrus execution test builder. This is a Java DSL representation
of what Citrus has to offer when it comes to sending and receiving messages over various message transports. The Citrus Arquillian extension will automatically inject
this method parameter so we can use it inside the test method block in order to define the Citrus test logic.</p>

<p>Basically we invoke the deployed REST service with Citrus using the Java DSL <em>send</em> and <em>receive</em> methods. Each receive operation in Citrus also triggers the message validation mechanism. This includes
a syntax check in case of SOAP and XML messages with a WSDL or XSD given and a semantic check on received message body and header values. The tester is able to give an expected message template that is used
as comparison template. Citrus is able to deeply walk through XML or JSON message payloads comparing elements, attributes, namespaces and values. In case the received message response does not match the given message template
the Arquillian test case will fail with respective validation errors. For now lets keep it simple so we just expect some Http response status codes in the receive operations. The last receive operation expects a very simple XML
message payload with the newly added employee data.</p>

<p>With the ability to send and receive messages via Http REST we simply invoke the deployed service endpoint and validate its outcome. With a sequence of send and receive operations in Citrus we can build complex message flows with
multiple service endpoints involved.</p>

<p>That’s it we have successfully combined both frameworks. Arquillian helps us to deploy and run our application inside an application container and we have easy access to managed resources. Citrus is able to invoke the services via Http with
powerful validation of the received response messages. This is just a very simple sample for now as I just wanted to show the basic setup. Based on this knowledge we can continue with a more complex test scenario. We will start
to use Arquillian in container testing mode and we will start to use more complex Citrus server components in one of my next posts. Stay tuned!</p>

  </div>
</article>


  <article>
  <h2>
    Apache Camel Integration Testing - Part 3
    <a href="/news/2015/06/03/camel-testing-part-3/" class="permalink" title="Permalink">∞</a>
  </h2>
  <span class="post-category">
    <span class="label">
      blog
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      03 Jun 2015
    </span>
    <a href="https://github.com/christophd" class="post-author">
      
      Christoph Deppisch
    </a>
  </div>
  <div class="post-content">
    <p>In this post I will continue with the Apache Camel integration testing scenario that we have worked on in <a href="/news/2014/11/21/camel-testing-part-1">part one</a> and
<a href="/news/2015/05/27/camel-testing-part-2">part two</a> of this series.
This time we focus on exception handling in Camel routes. First of all let’s add exception handling to our Camel route.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;camelContext</span> <span class="na">id=</span><span class="s">"camelContext"</span> <span class="na">xmlns=</span><span class="s">"http://camel.apache.org/schema/spring"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;route</span> <span class="na">id=</span><span class="s">"helloRoute"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;from</span> <span class="na">uri=</span><span class="s">"direct:hello"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;to</span> <span class="na">uri=</span><span class="s">"seda:sayHello"</span> <span class="na">pattern=</span><span class="s">"InOut"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;onException&gt;</span>
      <span class="nt">&lt;exception&gt;</span>com.consol.citrus.exceptions.CitrusRuntimeException<span class="nt">&lt;/exception&gt;</span>
      <span class="nt">&lt;to</span> <span class="na">uri=</span><span class="s">"seda:errors"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/onException&gt;</span>
  <span class="nt">&lt;/route&gt;</span>
<span class="nt">&lt;/camelContext&gt;</span></code></pre></figure>

<p>Camel supports exception handling on specific exception types. The <em>onException</em> route logic is executed when the defined exception type was raised
during message processing. In the sample route we call a separate Seda endpoint <em>seda:errors</em> for further exception handling. The challenge for our
test scenario is obvious. We need to force this error handling and we need to make sure that the Seda endpoint <em>seda:errors</em> has been called accordingly.</p>

<p>Let’s add the error handling endpoint to the Citrus Spring bean configuration.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;citrus-camel:sync-endpoint</span> <span class="na">id=</span><span class="s">"sedaErrorHandlingEndpoint"</span>
                       <span class="na">camel-context=</span><span class="s">"camelContext"</span>
                       <span class="na">endpoint-uri=</span><span class="s">"seda:errors"</span><span class="nt">/&gt;</span></code></pre></figure>

<p>The static endpoint definition is not mandatory as Citrus is also able to work with dynamic endpoints. In our case the dynamic endpoint for consuming messages on
the <em>seda:errors</em> endpoint would simply be <em>camel:sync:seda:errors</em>. The decision which kind of endpoint someone should use depends
on how much the endpoint could be reused throughout multiple test scenarios. Of course static endpoints are highly reusable in different test cases. On the downside
we have to manage the additional configuration burden. In this post I will use the static endpoint that is injected to the test case via Spring’s autowiring mechanism.
Let’s write the integration test.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">consol</span><span class="o">.</span><span class="na">citrus</span><span class="o">.</span><span class="na">hello</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.consol.citrus.dsl.TestNGCitrusTestBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.consol.citrus.dsl.annotations.CitrusTest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.consol.citrus.endpoint.Endpoint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.testng.annotations.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Qualifier</span><span class="o">;</span>

<span class="cm">/**
 * @author Christoph Deppisch
 */</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SayHelloTest</span> <span class="kd">extends</span> <span class="n">TestNGCitrusTestBuilder</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"directHelloEndpoint"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Endpoint</span> <span class="n">directHelloEndpoint</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"sedaHelloEndpoint"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Endpoint</span> <span class="n">sedaHelloEndpoint</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"sedaErrorHandlingEndpoint"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Endpoint</span> <span class="n">sedaErrorHandlingEndpoint</span><span class="o">;</span>

    <span class="nd">@CitrusTest</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"SayHello_Error_Test"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sayHello_Error_Test</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">send</span><span class="o">(</span><span class="n">directHelloEndpoint</span><span class="o">)</span>
            <span class="o">.</span><span class="na">fork</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
            <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
            <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">"Hello Citrus!"</span><span class="o">);</span>

        <span class="n">receive</span><span class="o">(</span><span class="n">sedaHelloEndpoint</span><span class="o">)</span>
            <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
            <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">"Hello Citrus!"</span><span class="o">);</span>

        <span class="n">sleep</span><span class="o">(</span><span class="mi">500L</span><span class="o">);</span>

        <span class="n">send</span><span class="o">(</span><span class="n">sedaHelloEndpoint</span><span class="o">)</span>
            <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
            <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">"Something went wrong!"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">"citrus_camel_exchange_exception"</span><span class="o">,</span>
                    <span class="s">"com.consol.citrus.exceptions.CitrusRuntimeException"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">"citrus_camel_exchange_exception_message"</span><span class="o">,</span>
                    <span class="s">"Something went wrong!"</span><span class="o">);</span>

        <span class="n">receive</span><span class="o">(</span><span class="n">sedaErrorHandlingEndpoint</span><span class="o">)</span>
            <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
            <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">"Something went wrong!"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">"CamelExceptionCaught"</span><span class="o">,</span>
                <span class="s">"com.consol.citrus.exceptions.CitrusRuntimeException: Something went wrong!"</span><span class="o">);</span>

        <span class="n">send</span><span class="o">(</span><span class="n">sedaErrorHandlingEndpoint</span><span class="o">)</span>
            <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
            <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">"Hello after error!"</span><span class="o">);</span>

        <span class="n">receive</span><span class="o">(</span><span class="n">directHelloEndpoint</span><span class="o">)</span>
            <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
            <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">"Hello after error!"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>The magic happens when Citrus sends back a synchronous response on the <em>seda:sayHello</em> endpoint which is done right after the sleep action in our sample test.
Instead of responding with a usual plain text message we add special header values <strong>citrus_camel_exchange_exception</strong> and <strong>citrus_camel_exchange_exception_message</strong>.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">send</span><span class="o">(</span><span class="n">sedaHelloEndpoint</span><span class="o">)</span>
    <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
    <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">"Something went wrong!"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">"citrus_camel_exchange_exception"</span><span class="o">,</span>
            <span class="s">"com.consol.citrus.exceptions.CitrusRuntimeException"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">"citrus_camel_exchange_exception_message"</span><span class="o">,</span>
            <span class="s">"Something went wrong!"</span><span class="o">);</span></code></pre></figure>

<p>These special Citrus headers instruct the Citrus Camel endpoint to raise an exception. We are able to specify the exception type as well as the exception message. As a result
the Citrus endpoint raises the exception on the Camel exchange which should force the exception handling in our Camel route.</p>

<p>The route <em>onException</em> block in our example should send the error to the <em>seda:errors</em> endpoint. So let’s consume this message in a next test step.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">receive</span><span class="o">(</span><span class="n">sedaErrorHandlingEndpoint</span><span class="o">)</span>
    <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
    <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">"Something went wrong!"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">"CamelExceptionCaught"</span><span class="o">,</span>
        <span class="s">"com.consol.citrus.exceptions.CitrusRuntimeException: Something went wrong!"</span><span class="o">);</span></code></pre></figure>

<p>With this receive action on the error endpoint we intend to validate that the exception handling was done as expected. We are able to check the error message payload and in addition
to that we have access to the Camel internal message headers that indicate the exception handling. Both message payload and message headers are compared to expected values in Citrus.</p>

<p>As a next test step we should provide a proper response message that is used as fallback response. The response is sent back as synchronous response on the <em>seda:errors</em> endpoint saying <em>Hello after error!</em>.
The Camel <em>onException</em> block and in detail the default Camel error handler will use this message as final result of the route logic. So finally in our test we can receive the fallback response message as result
of our initial direct <em>direct:hello</em> request.</p>

<p>This completes this simple test scenario. We raised an exception and forced the Camel route to perform proper exception handling. With the Citrus endpoints in duty we received the error message and provided a fallback
response message which is used as final result of the Camel route.</p>

<p>Error handling in message based enterprise integration scenarios is complex. We need to deal with delivery timeouts, retry strategies and proper transaction handling. This post only showed the top of the iceberg but I hope
you got the idea of how to set up automated integration tests with Apache Camel routes. The <a href="http://www.citrusframework.org" title="Citrus framework" target="_blank">Citrus framework</a> is focused on providing real message endpoints no matter of what kind or nature (Http, JMS, REST, SOAP, Ftp, XML, JSON,
Seda and so on). What we get is automated integration testing with real messages being exchanged on different transports and endpoints.</p>

  </div>
</article>


  <article>
  <h2>
    Apache Camel Integration Testing - Part 2
    <a href="/news/2015/05/27/camel-testing-part-2/" class="permalink" title="Permalink">∞</a>
  </h2>
  <span class="post-category">
    <span class="label">
      blog
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      27 May 2015
    </span>
    <a href="https://github.com/christophd" class="post-author">
      
      Christoph Deppisch
    </a>
  </div>
  <div class="post-content">
    <p>In <a href="/news/2014/11/21/camel-testing-part-1">part one</a> of this blog series we have used Citrus in combination with Apache Camel for setting up
a complete integration test scenario. Remember we have interacted with our Camel route via JMS as client and via SOAP Http WebService as a server.</p>

<p>Now in the second part we want to interact with a Camel route using direct and Seda in memory message transports. First of all we need a Camel route to test.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;camelContext</span> <span class="na">id=</span><span class="s">"camelContext"</span> <span class="na">xmlns=</span><span class="s">"http://camel.apache.org/schema/spring"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;route</span> <span class="na">id=</span><span class="s">"helloRoute"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;from</span> <span class="na">uri=</span><span class="s">"direct:hello"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;to</span> <span class="na">uri=</span><span class="s">"seda:sayHello"</span> <span class="na">pattern=</span><span class="s">"InOut"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/route&gt;</span>
<span class="nt">&lt;/camelContext&gt;</span></code></pre></figure>

<p>The Camel route is obviously very simple. The route reads messages from a direct inbound endpoint and forwards all messages to a Seda in memory channel. The Seda communication is synchronous
so the route waits for a synchronous response to arrive. Now when we would like to test this simple route we would have to provide the inbound messages to trigger the route and we would have to
provide proper synchronous response messages on the Seda endpoint.</p>

<p>Lets set up a Citrus test case for this test scenario. We need a direct Camel route message endpoint that is able to call the Camel route. The Camel endpoints are available with a separate Citrus module.
We need to add this library to our project as test scoped dependency if not already done so.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.consol.citrus<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>citrus-camel<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>3.3.0<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></figure>

<p>Now we can use the Citrus Camel endpoint components in the Spring bean application context that is part of the Citrus project.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
     <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
     <span class="na">xmlns:citrus-camel=</span><span class="s">"http://www.citrusframework.org/schema/camel/config"</span>
     <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
                     http://www.citrusframework.org/schema/camel/config http://www.citrusframework.org/schema/camel/config/citrus-camel-config.xsd"</span><span class="nt">&gt;</span>

  <span class="nt">&lt;camelContext</span> <span class="na">id=</span><span class="s">"camelContext"</span> <span class="na">xmlns=</span><span class="s">"http://camel.apache.org/schema/spring"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;route</span> <span class="na">id=</span><span class="s">"helloRoute"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;from</span> <span class="na">uri=</span><span class="s">"direct:hello"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;to</span> <span class="na">uri=</span><span class="s">"seda:sayHello"</span> <span class="na">pattern=</span><span class="s">"InOut"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/route&gt;</span>
  <span class="nt">&lt;/camelContext&gt;</span>

  <span class="nt">&lt;citrus-camel:sync-endpoint</span> <span class="na">id=</span><span class="s">"directHelloEndpoint"</span>
                           <span class="na">camel-context=</span><span class="s">"camelContext"</span>
                           <span class="na">endpoint-uri=</span><span class="s">"direct:hello"</span><span class="nt">/&gt;</span>

  <span class="nt">&lt;citrus-camel:sync-endpoint</span> <span class="na">id=</span><span class="s">"sedaHelloEndpoint"</span>
                           <span class="na">camel-context=</span><span class="s">"camelContext"</span>
                           <span class="na">endpoint-uri=</span><span class="s">"seda:sayHello"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/beans&gt;</span></code></pre></figure>

<p>As you can see we have added two Citrus endpoint components both coming from the Citrus Camel module. The first component is interacting with the direct endpoint <em>direct:hello</em> and the second component is interacting with the
Seda <em>seda:sayHello</em> endpoint. Both Citrus components use synchronous message communication so we are able to send and receive messages synchronously. Let’s move on with writing a test case.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">consol</span><span class="o">.</span><span class="na">citrus</span><span class="o">.</span><span class="na">hello</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.consol.citrus.dsl.TestNGCitrusTestBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.consol.citrus.dsl.annotations.CitrusTest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.consol.citrus.endpoint.Endpoint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.testng.annotations.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Qualifier</span><span class="o">;</span>

<span class="cm">/**
 * @author Christoph Deppisch
 */</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SayHelloTest</span> <span class="kd">extends</span> <span class="n">TestNGCitrusTestBuilder</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"directHelloEndpoint"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Endpoint</span> <span class="n">directHelloEndpoint</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"sedaHelloEndpoint"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Endpoint</span> <span class="n">sedaHelloEndpoint</span><span class="o">;</span>

    <span class="nd">@CitrusTest</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"SayHello_Ok_Test"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sayHello_Ok_Test</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">send</span><span class="o">(</span><span class="n">directHelloEndpoint</span><span class="o">)</span>
            <span class="o">.</span><span class="na">fork</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
            <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
            <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">"Hello Citrus!"</span><span class="o">);</span>

        <span class="n">receive</span><span class="o">(</span><span class="n">sedaHelloEndpoint</span><span class="o">)</span>
            <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
            <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">"Hello Citrus!"</span><span class="o">);</span>

        <span class="n">sleep</span><span class="o">(</span><span class="mi">500L</span><span class="o">);</span>

        <span class="n">send</span><span class="o">(</span><span class="n">sedaHelloEndpoint</span><span class="o">)</span>
            <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
            <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">"Hello Camel!"</span><span class="o">);</span>

        <span class="n">receive</span><span class="o">(</span><span class="n">directHelloEndpoint</span><span class="o">)</span>
            <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
            <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">"Hello Camel!"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>The test is using Spring’s autowiring mechanism in order to inject the Citrus message endpoint components. We have four message interactions in our test. First of all we send a plain text message to the direct Camel route endpoint.
The Camel route is triggered and according to the route logic the message is forwarded to the Seda endpoint. The second test action is a message receive action on this same Seda endpoint. So if the Camel route logic is working as
expected we should be able to receive a message here. The receive test action also performs a validation on the message content received. As a tester we specify the expected message payload. Citrus as test framework compares this
expectation to the message content actually arriving. When everything is matching as expected we continue with the test.</p>

<p>As the Seda endpoint is synchronous we can send back a response to the calling client. In our test this is done with a respective send message action that references the same Seda endpoint. Before we send back a plain text response message
we add a sleep test action in order to simulate some hard work on the backend. As a next step the Camel route receives our simulated response message and immediately responds to the calling direct endpoint client to complete the route.
This is our last step in the test case where we receive the very same response message on the direct endpoint as final message response.</p>

<p>Please do not get confused with this test setup. This scenario is purely constructed for demonstrating how Citrus interacts with Camel routes in terms of synchronous communication on both ends (consuming and producing). As the test performs
all actions four messages are exchanged in between Citrus and our Camel route to test. If everything is working as expected all messages are completed and the test case is successful.</p>

<p>Someone might feel uncomfortable in defining the Citrus endpoint components for each Camel route endpoint in the Spring application context just to reference them inside the test case. This is where dynamic endpoints come in handy. Citrus
is also able to create the endpoint at runtime. See how this looks like.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">consol</span><span class="o">.</span><span class="na">citrus</span><span class="o">.</span><span class="na">hello</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.consol.citrus.dsl.TestNGCitrusTestBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.consol.citrus.dsl.annotations.CitrusTest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.consol.citrus.endpoint.Endpoint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.testng.annotations.Test</span><span class="o">;</span>

<span class="cm">/**
 * @author Christoph Deppisch
 */</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SayHelloTest</span> <span class="kd">extends</span> <span class="n">TestNGCitrusTestBuilder</span> <span class="o">{</span>

    <span class="nd">@CitrusTest</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"SayHello_Ok_Test"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sayHello_Ok_Test</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">send</span><span class="o">(</span><span class="s">"camel:sync:direct:hello"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">fork</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
            <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
            <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">"Hello Camel!"</span><span class="o">);</span>

        <span class="n">receive</span><span class="o">(</span><span class="s">"camel:sync:seda:sayHello"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
            <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">"Hello Camel!"</span><span class="o">);</span>

        <span class="n">sleep</span><span class="o">(</span><span class="mi">500L</span><span class="o">);</span>

        <span class="n">send</span><span class="o">(</span><span class="s">"camel:sync:seda:sayHello"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
            <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">"Hello Citrus!"</span><span class="o">);</span>

        <span class="n">receive</span><span class="o">(</span><span class="nl">camel:sync:direct:</span><span class="n">hello</span><span class="o">)</span>
            <span class="o">.</span><span class="na">messageType</span><span class="o">(</span><span class="n">MessageType</span><span class="o">.</span><span class="na">PLAINTEXT</span><span class="o">)</span>
            <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">"Hello Citrus!"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>With the dynamic endpoints we do not have to use any of the predefined endpoint components in the Citrus Spring application context. The test just creates the endpoints automatically at runtime. The result is exactly the same as before.</p>

<p>We have seen that Citrus is able to both send and receive message from an to route message endpoints in Apache Camel. This is a good way of testing Camel routes with simulation of route interface partners. In the next part I will
add some error scenarios where the Seda endpoint component is forcing an exception that should be handled within our Camel route.</p>


  </div>
</article>


  <article>
  <h2>
    Apache Camel Integration Testing - Part 1
    <a href="/news/2014/11/21/camel-testing-part-1/" class="permalink" title="Permalink">∞</a>
  </h2>
  <span class="post-category">
    <span class="label">
      blog
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      21 Nov 2014
    </span>
    <a href="https://github.com/christophd" class="post-author">
      
      Christoph Deppisch
    </a>
  </div>
  <div class="post-content">
    <p>Apache Camel is a great mediation and routing framework that integrates with almost every enterprise messaging transport. In the past I have experienced Camel projects struggling with integration testing where the actual message interfaces to boundary applications are not tested properly in an automated way.</p>

<p>So in a series of posts I would like to talk about integration testing strategies for Apache Camel projects using the Citrus integration test framework.</p>

<ul>
  <li>
<a href="https://citrusframework.org/news/2014/11/21/camel-testing-part-1/" title="Part 1" target="_blank">Part 1</a>: Setup the Citrus test project and interact with a sample Apache Camel project with JMS and SOAP WebService components</li>
  <li>
<a href="https://citrusframework.org/news/2015/05/27/camel-testing-part-2/" title="Part 2" target="_blank">Part 2</a>: Invoke Camel routes from Citrus test cases and validate outbound messages</li>
  <li>
<a href="https://citrusframework.org/news/2015/06/03/camel-testing-part-3/" title="Part 3" target="_blank">Part 3</a>: Test error situations with Camel exception handling</li>
</ul>

<p>So lets have a sample Camel project that we would like to test. We need a simple Camel route like this:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;camelContext</span> <span class="na">id=</span><span class="s">"camelContext"</span> <span class="na">xmlns=</span><span class="s">"http://camel.apache.org/schema/spring"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;route</span> <span class="na">id=</span><span class="s">"newsRoute"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;from</span> <span class="na">uri=</span><span class="s">"jms:queue:JMS.Queue.News"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;to</span> <span class="na">uri=</span><span class="s">"log:com.consol.citrus.camel?level=INFO"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;to</span> <span class="na">uri=</span><span class="s">"spring-ws:http://localhost:8080?soapAction=newsFeed"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/route&gt;</span>
<span class="nt">&lt;/camelContext&gt;</span></code></pre></figure>

<p>The route consumes messages from a JMS destination called <em>JMS.Queue.News</em>, logs the message content and forwards the message content to a Http SOAP WebService using the Spring WS library. So we have two different messaging interfaces (JMS and SOAP WebService) to boundary systems in our sample.</p>

<p>Camel does provide very good test strategies for mocking these message transports. In a unit test you can mock the boundary JMS and SOAP interfaces with special mock components. This is great, but sometimes error prone for the following reasons. The JMS protocol provides several settings that are essential for the whole application behavior. For instance the JMS consumer may operate with concurrent consumers, connection pooling and transactional behavior. These settings are done on the Camel JMS component and on the JMS connection factory. In a mocked unit test these settings are not included as the test mock just does not process the real JMS message transports. No doubt these settings make a significant difference in production and have to be tested. In addition to that the SOAP WebService interface uses a WSDL and other SOAP specific settings like the soap action header. We could also add WS-Security and WS-Addressing headers here. In a mocked unit test these quite important interface characteristics are not tested over the wire. The actual SOAP message is not created and you are not able to verify the complete message contents as they are sent over the wire.</p>

<p>So the crucial weapon to avoid bugs related to untested transport settings is integration testing where the actual JMS message broker and a real SOAP WebService endpoint are involved in the test. And this is where Citrus comes in. In a Citrus test case the actual JMS consumer and producer settings do apply as well as a fully qualified WebService endpoint that receives the messages via Http message protocol. We use a real JMS message broker and Http server as it is done in production.</p>

<p>Lets setup a Citrus project that is able to interact with the sample Camel application route.</p>

<p>Citrus as integration test framework works best with Maven. You can setup a Citrus Maven project in minutes with this <a href="http://www.citrusframework.org/tutorials-maven.html" title="Maven Quickstart" target="_blank">quick start tutorial</a>. Once you have done this we have a Maven project with some sample Citrus test cases already in it. No we need to add the JMS and SOAP WebService configuration to the Citrus project. First of all let us add ActiveMQ as JMS message broker.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.apache.activemq<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>activemq-broker<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>${activemq.version}<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.apache.activemq<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>activemq-spring<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>${activemq.version}<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.apache.xbean<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>xbean-spring<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>${xbean.version}<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></figure>

<p>We need to add the ActiveMQ Maven dependencies to our Citrus project. This is done in the Maven POM <em>pom.xml</em> file. Once we have this we can add the message broker to the Citrus configuration. We add a new Spring application context file <em>citrus-activemq-context.xml</em> in <em>src/citrus/resources</em> folder.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
     <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
     <span class="na">xmlns:amq=</span><span class="s">"http://activemq.apache.org/schema/core"</span>
     <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
                     http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd"</span><span class="nt">&gt;</span>

  <span class="c">&lt;!-- Embedded ActiveMQ JMS broker --&gt;</span>
  <span class="nt">&lt;amq:broker</span> <span class="na">useJmx=</span><span class="s">"false"</span> <span class="na">persistent=</span><span class="s">"false"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;amq:transportConnectors&gt;</span>
      <span class="nt">&lt;amq:transportConnector</span> <span class="na">uri=</span><span class="s">"tcp://localhost:61616"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/amq:transportConnectors&gt;</span>
  <span class="nt">&lt;/amq:broker&gt;</span>

  <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"connectionFactory"</span> <span class="na">class=</span><span class="s">"org.apache.activemq.ActiveMQConnectionFactory"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"brokerURL"</span> <span class="na">value=</span><span class="s">"tcp://localhost:61616"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span></code></pre></figure>

<p>As next step we include this new Spring context file in the <em>citrus-context.xml</em> so both the ActiveMQ message broker and the JMS connection factory get loaded during startup. Just add a import statement to the <em>citrus-context.xml</em> file like this:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;import</span> <span class="na">resource=</span><span class="s">"classpath:citrus-activemq-context.xml"</span><span class="nt">/&gt;</span></code></pre></figure>

<p>Good! Now we are ready to connect with the JMS message transport. Let us add the Citrus JMS endpoints. You can do this also in the <em>citrus-context.xml</em> file:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;citrus-jms:endpoint</span> <span class="na">id=</span><span class="s">"newsJmsEndpoint"</span>
                   <span class="na">destination-name=</span><span class="s">"JMS.Queue.News"</span>
                   <span class="na">timeout=</span><span class="s">"5000"</span><span class="nt">/&gt;</span></code></pre></figure>

<p>That’s it! Now we can send and receive JMS messages on the JMS destination <em>JMS.Queue.News</em>. Ok so let’s write a new integration test! We create a new Java class in <em>src/citrus/java</em></p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">consol</span><span class="o">.</span><span class="na">citrus</span><span class="o">.</span><span class="na">news</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.consol.citrus.dsl.TestNGCitrusTestBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.consol.citrus.dsl.annotations.CitrusTest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.consol.citrus.ws.message.SoapMessageHeaders</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.testng.annotations.Test</span><span class="o">;</span>

<span class="cm">/**
 * @author Christoph Deppisch
 */</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NewsFeedTest</span> <span class="kd">extends</span> <span class="n">TestNGCitrusTestBuilder</span> <span class="o">{</span>
    
    <span class="nd">@CitrusTest</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"NewsFeed_Ok_Test"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">newsFeed_Ok_Test</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">send</span><span class="o">(</span><span class="s">"newsJmsEndpoint"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">"&lt;News&gt;"</span> <span class="o">+</span>
                         <span class="s">"&lt;Message&gt;Citrus rocks!&lt;/Message&gt;"</span> <span class="o">+</span>
                     <span class="s">"&lt;/News&gt;"</span><span class="o">);</span>
        
        <span class="n">receive</span><span class="o">(</span><span class="s">"newsSoapServer"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">payload</span><span class="o">(</span><span class="s">"&lt;News&gt;"</span> <span class="o">+</span>
                         <span class="s">"&lt;Message&gt;Citrus rocks!&lt;/Message&gt;"</span> <span class="o">+</span>
                     <span class="s">"&lt;/News&gt;"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="n">SoapMessageHeaders</span><span class="o">.</span><span class="na">SOAP_ACTION</span><span class="o">,</span> <span class="s">"newsFeed"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>This represents a Citrus Java test case. Notice that this is nothing but a normal Java unit test. I use TestNG as unit test framework. Others might prefer JUnit which is also possible. I think TestNG is much more powerful but this is another story. Also notice that we referenced the <em>newsJmsEndpoint</em> Citrus component in the first send operation. We could have used Spring autowire injection of the JmsEndpoint here, but we want to keep it simple for now. What we have right now is an integration test which actually sends the JMS message with some news content to the JMS queue destination and on the other side we receive the real SOAP message as a web server. But wait! We have not yet added the SOAP server configuration yet! Let’s do this in the <em>citrus-context.xml</em> configuration file.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;citrus-ws:server</span> <span class="na">id=</span><span class="s">"newsSoapServer"</span>
               <span class="na">port=</span><span class="s">"8080"</span>
               <span class="na">auto-start=</span><span class="s">"true"</span>
               <span class="na">timeout=</span><span class="s">"10000"</span><span class="nt">/&gt;</span></code></pre></figure>

<p>The server starts a fully qualified Http web server with the SOAP endpoint for receiving the news request. In the test case we can reference the server in a receive operation. That’s it! We are able to run the test. Of course we also need to start our Camel application. You can do this in another process with Maven or you deploy your Camel application to some application server. Citrus is interacting with the Camel route as a normal interface client just using the JMS endpoint. Once you run the integration test you will see how the messages are actualy sent over the wire and you will see Citrus receiving the actual SOAP request message:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml">Received SOAP request:
<span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="nt">&lt;SOAP-ENV:Envelope</span> <span class="na">xmlns:SOAP-ENV=</span><span class="s">"http://schemas.xmlsoap.org/soap/envelope/"</span><span class="nt">&gt;</span>
<span class="nt">&lt;SOAP-ENV:Header</span> <span class="na">jmsmessageid=</span><span class="s">"ID:localhost-50188-1416562129343-3:4:1:1:1"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;SOAP-ENV:Body&gt;</span>
<span class="nt">&lt;News&gt;</span>
<span class="nt">&lt;Message&gt;</span>Citrus rocks!<span class="nt">&lt;/Message&gt;</span>
<span class="nt">&lt;/News&gt;</span>
<span class="nt">&lt;/SOAP-ENV:Body&gt;</span>
<span class="nt">&lt;/SOAP-ENV:Envelope&gt;</span></code></pre></figure>

<p>Also Citrus will put this received message content to validation with comparing the message body and header to the expected content given in the test case. Let’s recap. What we have done is a complete integration test where the Camel route interfaces are called with real message transport interaction. The ActiveMQ JMS message broker is real the SOAP WebService server is real. The message transport configuration is tested properly with message conversion and expected message content validation. The Camel application is loaded and deployed with the complete configuration and settings.</p>

<p>Citrus invokes the Camel route by sending a proper JMS message to the route endpoint. The Camel route processes the message and sends out the SOAP request message. In case the message content is not as expected in the Citrus receive operation or in case the SOAP message is not arriving at all the integration test fails. In this integration test we can simulate both client and server side interaction with our Camel application.</p>

<p>As the Citrus test case is nothing but a normal TestNG/JUnit test we can integrate the test in our Maven build lifecycle and continuous integration process. This completes our first part of how to do extended integration testing with Apache Camel projects. In my next part I will concentrate on how to interact with Apache Camel routes using direct and Seda in memory message transports.</p>

  </div>
</article>


  <article>
  <h2>
    Testing webMethods with Citrus Part II
    <a href="/news/2014/05/30/testing-webmethods-with-citrus-part-ii/" class="permalink" title="Permalink">∞</a>
  </h2>
  <span class="post-category">
    <span class="label">
      blog
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      30 May 2014
    </span>
    <a href="https://github.com/jaza089" class="post-author">
      
      Jan Zahalka
    </a>
  </div>
  <div class="post-content">
    <p>In <a href="/news/2014/03/06/testing-webmethods-with-citrus-part-i">part I</a> of this tutorial I introduced the basic concepts and benefits of Citrus as a test driver for ESB projects in general and webMethods in particular. 
In this second part I want to discuss some Citrus project setup options and provide a quickstart template project for Ant users.</p>

<h3 id="maven-or-ant">Maven or Ant?</h3>

<p>Basically, Citrus support both options – you are free in your choice of the build system to use to drive your Citrus tests. Typically a Maven setup is preferred since Maven reduces the necessary project setup 
clutter one has to face when using Ant. Check this <a href="/docs/setup-maven.html">quickstart</a> if you want to let Maven create your project structure for you.</p>

<p>However, everything in the webMethods world is ant-based (like tooling, deployment etc.), at least this was the case during my experience with the 8.2 version of webMethods, let me know if things have changed meanwhile. 
So it might make pretty good sense to setup the Citrus project with Ant as well to reuse existing project knowledge. That’s what the rest of this blog entry is basically about.</p>

<h3 id="ant-setup">Ant Setup</h3>

<p>The Citrus homepage provides an awesome Ant <a href="/docs/setup-ant">quickstart</a>. Everything you need is described there in detail, however, it is quite a tough job to collect all the necessary dependency jar’s manually. 
Since version 1.4, Citrus provides a maven assembly goal which creates a directory with all dependency jar’s which can be thrown into the lib folder of your newly created Citrus project. You can trigger this assembly 
by grabbing the Citrus sources and execute</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">mvn assembly:assembly <span class="nt">-Passembly-antlibs</span></code></pre></figure>

<p>from the project root. Unfortunately I faced some issues on my Macbook with Maven version 3.0.5 so this way was blocked for me. Additionally, not everyone might have interest or possibilities to check out the sources 
or have maven installed and setup on his machine. That’s basically why I want to provide a template project to speed up Ant project setup.</p>

<h3 id="citrus-ant-template-project">Citrus Ant Template Project</h3>

<p>For those who prefer the easiest way (like me), I have set up up a little Eclipse template project, where everything needed to run Citrus with Ant is already in place. It contains</p>

<ul>
  <li>The correct folder structure</li>
  <li>All necessary Citrus (1.4) core libs and dependencies</li>
  <li>A prepared citrus citrus-context.xml and log4j.xml</li>
  <li>A template build.xml file</li>
</ul>

<p>You can grab the template project on Github <a href="https://github.com/jaza089/citrus-wm-samples/tree/master/CitrusTemplateProject">here</a> , import it (Select Import –&gt; General/Archive File in Eclipse/SAG Designer) 
and kick start developing integration tests for your webMethods project. Typically, you will work in Software AG Designer to develop your webMethods solution, luckily it is based on Eclipse and you can perfectly 
work with your Citrus test projects in the Java perspective of SAG Designer. In fact, the template project is created and exported from SAG Designer 9.5.</p>

<p>In the next part, I will enhance our empty project with a first test: a SOAP request/reply scenario with Citrus against a webMethods package.</p>

  </div>
</article>


  <article>
  <h2>
    Testing webMethods with Citrus Part I
    <a href="/news/2014/03/06/testing-webmethods-with-citrus-part-i/" class="permalink" title="Permalink">∞</a>
  </h2>
  <span class="post-category">
    <span class="label">
      blog
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      06 Mar 2014
    </span>
    <a href="https://github.com/jaza089" class="post-author">
      
      Jan Zahalka
    </a>
  </div>
  <div class="post-content">
    <p>Continuous integration is almost mainstream nowadays. Probably no one wants to argue against the value of having an all-embracing integration test suite in place, 
which is lightweight enough to be executed on each code change. In this blog series I want to show the interplay between <a href="http://www.citrusframework.org">Citrus</a>, 
the integration test framework written and maintained by <a href="http://www.consol.com">ConSol</a> and a commonly used Enterprise Service Bus, the <a href="http://www.softwareag.com/corporate/products/wm/integration/overview/default.asp">webMethods Integration Server</a>.</p>

<h3 id="meet-the-participants">Meet the participants</h3>

<p>Citrus is a lightweight integration test framework specially suited for enterprise integration challenges. It supports a broad set of communication protocols and is able to 
simulate partner applications of any type to provide proper end-to-end testing in a sandbox environment.</p>

<p>Our system-under-test is Software AG’s webMethods Integration Server, which is an industry-proof ESB solving complex integration and B2B challenges in large-scale deployments around the globe.</p>

<h3 id="why-citrus">Why Citrus?</h3>

<p>On a closer look at the built-in support for automated testing, webMethods provides integrated tooling (namely the wMTestSuite), directly incorporated into the Software AG Designer to support 
developers with tests operating on the basic building blocks inside webMethods – the Flow service.</p>

<p>Comparing this tooling to traditional software development, this means there is a good framework for Unit/white box testing in place, but: wmTestSuite is not suited for automated tests from an 
integration/black box perspective. For such tasks, several commercial tools are available, but this is where Citrus with its support for automated tests on interface level comes into play as a 
smart and fully open source alternative.</p>

<h2 id="whats-coming-up">What’s coming up?</h2>

<p>Over the next parts of this series I want to share the basic steps in order to setup a Citrus project and develop automated tests for several webMethods integration scenarios, including SOAP 
request/reply, SOAP and JMS mocking as well as flat file integration. In the end I might also cover the topic BPMN processes on top of webMethods which can be tested with Citrus as well.</p>

<p>Stay tuned for the next upcoming part II: basic project setup</p>

  </div>
</article>


  <article>
  <h2>
    Validate Excel files in Citrus
    <a href="/news/2011/06/22/excel-validation/" class="permalink" title="Permalink">∞</a>
  </h2>
  <span class="post-category">
    <span class="label">
      blog
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      22 Jun 2011
    </span>
    <a href="https://github.com/christophd" class="post-author">
      
      Christoph Deppisch
    </a>
  </div>
  <div class="post-content">
    <p>Lately I had to deal with Excel files as REST Http service response. I came up with a pretty clever validation mechanism in Citrus that I would like to share with you. You can apply the Excel validator to your Citrus project, too. It is not very complicated as you will see in this post.</p>

<p>First of all lets have a closer look at the response message we get from REST Http service.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml">HTTP/1.1 200 OK
Content-Language: de-DE
Content-Type: application/vnd.ms-excel;charset=windows-1252
Pragma: private
Cache-Control: private, must-revalidate
Content-Disposition: attachment; filename="ReportData.xls"
Transfer-Encoding: chunked
Server: Jetty(7.2.2.v20101205)

-- binary content --</code></pre></figure>

<p>The response message states a Content-Type header set to <em>application/vnd.ms-excel</em> which indicates the Excel content to the browser. Furthermore the Content-Disposition header informs the browser that he should open the save as dialog to the user rather than displaying the content. Finally the Excel file is added as binary content with charset <em>windows-1252</em>.</p>

<p>So now we would like to receive this message in our Citrus test also being able to validate the Excel file content as well as the important header entries. This is how we can do it:</p>

<p>First of all we introduce a custom message validator which handles the binary Excel message content. We intend to create an Excel workbook object that we can pass into the Citrus test. The tester is then able to write Groovy validation code accessing the Excel workbook object. Heres the code for the custom Excel message validator:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExcelMessageValidator</span> <span class="kd">extends</span> <span class="n">GroovyScriptMessageValidator</span> <span class="o">{</span>

    <span class="cm">/**
     * Default constructor using a customized groovy script template 
     * with POI workbook support.
     */</span>
    <span class="kd">public</span> <span class="nf">ExcelMessageValidator</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="k">new</span> <span class="n">ClassPathResource</span><span class="o">(</span><span class="s">"de/buk/aso/test/validation/excel-script-validation.groovy"</span><span class="o">));</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supportsMessageType</span><span class="o">(</span><span class="n">String</span> <span class="n">messageType</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">messageType</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">"ms-excel"</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre></figure>

<p>The message validator is quite simple isn’t it. We extend GroovyScriptMessageValidator as we would like to write groovy validation code inside the test. The validator uses a custom script template (<em>excel-script-validation.groovy</em>) and supports message type <em>ms-excel</em>. Keep that in mind as we will use this later in our test case. For now we add this message validator to the Citrus Spring application context (<em>citrus-context.xml</em>).</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"excelMessageValidator"</span> <span class="na">class=</span><span class="s">"com.consol.citrus.validation.ExcelMessageValidator"</span><span class="nt">/&gt;</span></code></pre></figure>

<p>Not much has happened though in this validator’s Java code. The magic is done inside the Groovy script template <em>excel-script-validation.groovy</em> that we have added to the classpath in our project. Lets have a look at this file:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">java.io.ByteArrayInputStream</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span>
<span class="kn">import</span> <span class="nn">com.consol.citrus.*</span>
<span class="kn">import</span> <span class="nn">com.consol.citrus.message.*</span>
<span class="kn">import</span> <span class="nn">com.consol.citrus.variable.*</span>
<span class="kn">import</span> <span class="nn">com.consol.citrus.context.TestContext</span>
<span class="kn">import</span> <span class="nn">com.consol.citrus.exceptions.CitrusRuntimeException</span>
<span class="kn">import</span> <span class="nn">com.consol.citrus.validation.script.GroovyScriptMessageValidator.ValidationScriptExecutor</span>
<span class="kn">import</span> <span class="nn">org.apache.poi.hssf.usermodel.HSSFWorkbook</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExcelValidationScript</span> <span class="kd">implements</span> <span class="n">ValidationScriptExecutor</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">validate</span><span class="o">(</span><span class="n">Message</span> <span class="n">receivedMessage</span><span class="o">,</span> <span class="n">TestContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">receivedMessage</span><span class="o">.</span><span class="na">copyHeaders</span><span class="o">()</span>
        <span class="n">String</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">receivedMessage</span><span class="o">.</span><span class="na">getPayload</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        
        <span class="n">HSSFWorkbook</span> <span class="n">workbook</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">workbook</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HSSFWorkbook</span><span class="o">(</span><span class="k">new</span> <span class="n">ByteArrayInputStream</span><span class="o">(</span><span class="n">payload</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()))</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">CitrusRuntimeException</span><span class="o">(</span><span class="s">"Failed to create excel workbook"</span><span class="o">,</span> <span class="n">e</span><span class="o">)</span>
        <span class="o">}</span>
        
        <span class="nd">@SCRIPTBODY</span><span class="err">@</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Ah, now we are getting more precisely! We introduce a new HSSFWorkbook (see also <a href="http://poi.apache.org/">http://poi.apache.org/</a>) with the message payload that we have just received. Please do not mind the Java-like Groovy programming style - I want to keep things easy for Java programmers in this post. However we now have the workbook object ready for validation code in our test which automatically comes in where <em><a href="https://github.com/SCRIPTBODY" class="user-mention">@SCRIPTBODY</a>@</em> placeholder is located. So before we continue to look at the test example we shortly add apache poi jar dependency to our project Maven pom.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.apache.poi<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>poi<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>3.7<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></figure>

<p>Finally let’s write the Citrus test with custom Excel file validation code in Groovy:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;testcase</span> <span class="na">name=</span><span class="s">"ExcelValidationITest"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;actions&gt;</span>
     <span class="nt">&lt;send</span> <span class="na">endpoint=</span><span class="s">"httpRestEndpoint"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;message&gt;&lt;data&gt;&lt;/data&gt;&lt;/message&gt;</span>
           <span class="nt">&lt;header&gt;</span>
              <span class="nt">&lt;element</span> <span class="na">name=</span><span class="s">"citrus_endpoint_uri"</span> 
                  <span class="na">value=</span><span class="s">"http://localhost:8080/rest-api/report/excel"</span><span class="nt">/&gt;</span>
              <span class="nt">&lt;element</span> <span class="na">name=</span><span class="s">"citrus_http_method"</span> <span class="na">value=</span><span class="s">"GET"</span><span class="nt">/&gt;</span>
              <span class="nt">&lt;element</span> <span class="na">name=</span><span class="s">"Content-Type"</span> <span class="na">value=</span><span class="s">"text/html"</span><span class="nt">/&gt;</span>
              <span class="nt">&lt;element</span> <span class="na">name=</span><span class="s">"Accept"</span> <span class="na">value=</span><span class="s">"application/vnd.ms-excel"</span><span class="nt">/&gt;</span>
          <span class="nt">&lt;/header&gt;</span>
      <span class="nt">&lt;/send&gt;</span>
            
      <span class="nt">&lt;receive</span> <span class="na">endpoint=</span><span class="s">"httpRestEndpoint"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;message</span> <span class="na">type=</span><span class="s">"ms-excel"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;validate&gt;</span>
              <span class="nt">&lt;script</span> <span class="na">type=</span><span class="s">"groovy"</span><span class="nt">&gt;</span>
               // Header validation
               assert headers["citrus_http_status_code"].toString() == '200'
               assert headers["citrus_http_reason_phrase"] == 'OK'
               assert headers["Content-Type"].toString() == 
                    'application/vnd.ms-excel;charset=windows-1252'
               assert headers["Content-Disposition"] == 
                    'attachment; filename="ReportData.xls"'

               // Excel workbook validation
               assert workbook.getSheetAt(0).getSheetName() == "Report Data"
             <span class="nt">&lt;/script&gt;</span>
           <span class="nt">&lt;/validate&gt;</span>
         <span class="nt">&lt;/message&gt;</span>
     <span class="nt">&lt;/receive&gt;</span>
  <span class="nt">&lt;/actions&gt;</span>
<span class="nt">&lt;/testcase&gt;</span></code></pre></figure>

<p>We can access the Excel workbook object like a charm. Also the important message headers are checked for expected values. Do not forget to define the message type <em>ms-excel</em> in the receive action. This ensures that the validation mechanism in Citrus uses our custom Excel message validator for preparing the apache poi workbook object in advance.</p>

<p>That’s it! We are now able to validate Excel files in Citrus! The same thing can easily be done with other MS office formats (doc), too. If I have time the next days I will zip that project code and add it as download for you. Have fun with it!</p>

  </div>
</article>


  <article>
  <h2>
    Use TestNG data providers in Citrus
    <a href="/news/2011/06/17/testng-data-provider/" class="permalink" title="Permalink">∞</a>
  </h2>
  <span class="post-category">
    <span class="label">
      blog
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      17 Jun 2011
    </span>
    <a href="https://github.com/christophd" class="post-author">
      
      Christoph Deppisch
    </a>
  </div>
  <div class="post-content">
    <p>TestNG provides brilliant support for test parameters and data providers. With some annotation magic you are able to pass parameter values to your test method and finally to your Citrus test logic. Actually the TestNG parameters are injected to the Citrus test as normal test variables. Lets put this to the test with a simple example:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DataProviderITest</span> <span class="kd">extends</span> <span class="n">AbstractTestNGCitrusTest</span> <span class="o">{</span>
    
    <span class="nd">@Parameters</span><span class="o">(</span> <span class="o">{</span> <span class="s">"message"</span> <span class="o">}</span> <span class="o">)</span>
    <span class="nd">@Test</span><span class="o">(</span><span class="n">dataProvider</span> <span class="o">=</span> <span class="s">"citrusDataProvider"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">dataProviderITest</span><span class="o">(</span><span class="n">ITestContext</span> <span class="n">testContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">executeTest</span><span class="o">(</span><span class="n">testContext</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">Object</span><span class="o">[][]</span> <span class="nf">getParameterValues</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[][]</span> <span class="o">{</span>
            <span class="o">{</span> <span class="s">"Hello World!"</span> <span class="o">},</span>
            <span class="o">{</span> <span class="s">"Hallo Welt!"</span> <span class="o">},</span>
            <span class="o">{</span> <span class="s">"Hallo Citrus!"</span> <span class="o">},</span>
        <span class="o">};</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>We have to use the Citrus data provider (<em>citrusDataProvider</em>) along with a named parameter annotation (<em>message</em>) on the test method. Just add the annotations to the Citrus test method as shown in the example above. Next thing we override the method <em>getParameterValues()</em> in order to provide the actual parameter values. As you can see we provide three static values for the “message” parameter.</p>

<p>Inside the Citrus test you can use the test variable <strong>$</strong> as usual. TestNG and Citrus automatically take care on creating the variable with respective value from data provider. The test case is very simple and looks like follows:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;testcase</span> <span class="na">name=</span><span class="s">"DataProviderITest"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;actions&gt;</span>
        <span class="nt">&lt;echo&gt;</span>
            <span class="nt">&lt;message&gt;</span>${message}<span class="nt">&lt;/message&gt;</span>
        <span class="nt">&lt;/echo&gt;</span>
    <span class="nt">&lt;/actions&gt;</span>
<span class="nt">&lt;/testcase&gt;</span></code></pre></figure>

<p>As we have three static parameter values in our data provider the whole Citrus test is executed three times. Each time the data provider injects the respective test parameter and ${message} variable. The Citrus test report gives us the test results with all parameters.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"> echo Hello World!
 echo Hallo Welt!
 echo Hallo Citrus!

CITRUS TEST RESULTS
 
DataProviderITest('Hello World!') .................................. SUCCESS
DataProviderITest('Hallo Welt!') ................................... SUCCESS
DataProviderITest('Hallo Citrus!') ................................. SUCCESS

Total number of tests: 3
Skipped:   0 (0.0%)
Failed:    0 (0.0%)
Success:   3 (100.0%)</code></pre></figure>

<p>We can also use multiple test parameters at a time with all values coming from data provider. How about reading the parameter values from external property files or database?! I use this feature a lot for preparing my Citrus tests with dynamic parameter values from external resources and I bet you will enjoy this feature as much as I do. For more information on TestNG data providers please also have a look at the official documentation (<a href="http://testng.org/doc/documentation-main.html#parameters">http://testng.org/doc</a>).</p>

  </div>
</article>


  <article>
  <h2>
    Integrate your own validator into your Citrus project
    <a href="/news/2010/12/14/integrate-your-own-validator/" class="permalink" title="Permalink">∞</a>
  </h2>
  <span class="post-category">
    <span class="label">
      blog
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      14 Dec 2010
    </span>
    <a href="https://github.com/" class="post-author">
      
      Yvonne Sunke
    </a>
  </div>
  <div class="post-content">
    <p>Citrus includes a lot of convenient features which are only waiting for you to discover and use them. The other day I needed to validate a SoapAttachment. 
As you probably already know, a SoapAttachment is referenced by a href property in an Include tag like this:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="ni">&amp;lt;</span>Include href="..." xmlns="http://www.w3.org/2004/08/xop/include"/<span class="ni">&amp;gt;</span> </code></pre></figure>

<p>Validation is quite easy when you’re still mock testing your application because you have full control over what your mock response will look like.</p>

<p>So just add the following bean to your citrus-context.xml:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"soapAttachmentValidator"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"ignoreAllWhitespaces"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span></code></pre></figure>

<p>And use it in your test file like so:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;send</span> <span class="na">endpoint=</span><span class="s">"facadeMessageSender"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;message&gt;</span>
    <span class="nt">&lt;data&gt;</span>
      <span class="cp">&lt;![CDATA[...-your request-...]]&gt;</span>
    <span class="nt">&lt;/data&gt;</span>
  <span class="nt">&lt;/message&gt;</span>
<span class="nt">&lt;/send&gt;</span>
<span class="nt">&lt;ws:receive</span> <span class="na">endpoint=</span><span class="s">"facadeResponseHandler"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;message</span> <span class="na">schema-validation=</span><span class="s">"false"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;data&gt;</span>
      <span class="cp">&lt;![CDATA[
        &lt;test:MyTestRes xmlns:mail="http://www.testdomain.com/foo/bar/test"&gt;</span>
          <span class="nt">&lt;test:MyStructure&gt;</span>
            <span class="nt">&lt;Include</span> <span class="na">href=</span><span class="s">"@ignore@"</span> <span class="na">xmlns=</span><span class="s">"http://www.w3.org/2004/08/xop/include"</span><span class="nt">/&gt;</span>
          <span class="nt">&lt;/test:MyStructure&gt;</span>
        <span class="nt">&lt;/test:MyTestRes&gt;</span>
      ]]&gt;
    <span class="nt">&lt;/data&gt;</span>
    <span class="nt">&lt;ignore</span> <span class="na">path=</span><span class="s">"//test:MyTestRes/test:MyStructure/*/@href"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/message&gt;</span>
  <span class="nt">&lt;extract&gt;</span>
    <span class="nt">&lt;message</span> <span class="na">variable=</span><span class="s">"contentId"</span> <span class="na">path=</span><span class="s">"///test:MyTestRes/test:MyStructure/*/@href"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/extract&gt;</span>
  <span class="c">&lt;!-- Extract cid: (unfortunately the @ is masked by %40 and has to be replaced too) --&gt;</span>
  <span class="nt">&lt;ws:attachment</span> <span class="na">content-id=</span><span class="s">"citrus:concat(citrus:substringBefore(citrus:substringAfter('${contentId}', 'cid:'), '%40www.testdomain.com'), '@www.testdomain.com')"</span> 
                 <span class="na">content-type=</span><span class="s">"TEXT/CALENDAR; 
                 charset=us-ascii"</span> 
                 <span class="na">validator=</span><span class="s">"soapAttachmentValidator"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ws:data&gt;</span>
      <span class="cp">&lt;![CDATA[...-the expected response-...]]&gt;</span>
    <span class="nt">&lt;/ws:data&gt;</span>
  <span class="nt">&lt;/ws:attachment&gt;</span>
<span class="nt">&lt;/ws:receive&gt;</span></code></pre></figure>

<p>Things become a little more complicated as soon as you start to connect to real backend systems for integration testing. Especially when timestamps are involved. In my case the SoapAttachment contains a calendar 
invitation in vCal format which is basically a simple text based key/value format. I have to ignore the value for the key <code>LAST-MODIFIED</code> because it would be impossible to predict this timestamp and 
it’s not really relevant either. So what I really need is a way to compare the expected structure with the actual result line by line, a possibility to completely ignore a line and a way to only ignore the value 
but still compare the keys of some lines.</p>

<p>To solve this, the Citrus framework offers the possibility to define your own validators and include them into your test cases. Simply add a Java class which extends AbstractSoapAttachmentValidator to your test project and 
implement the validateAttachmentContent method. This will be your new validator and could look somewhat like the simple example I’ll add to the end of this blog entry.</p>

<p>Go back to your citrus-context.xml and add your newly created validator bean:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"lineByLineSoapAttachmentValidator"</span> <span class="na">class=</span><span class="s">"com.testproject.itest.validation.LineByLineWithIgnoreSoapAttachmentValidator"</span><span class="nt">/&gt;</span></code></pre></figure>

<p>Now you can use the validator in your test files:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;ws:attachment</span> <span class="na">content-id=</span><span class="s">"citrus:concat(citrus:substringBefore(citrus:substringAfter('${contentId}', 'cid:'), '%40www.testdomain.com'),  '@www.testdomain.com')"</span> <span class="na">content-type=</span><span class="s">"TEXT/CALENDAR; charset=us-ascii"</span> <span class="na">validator=</span><span class="s">"lineByLineSoapAttachmentValidator"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;ws:data&gt;</span>
    <span class="cp">&lt;![CDATA[
BEGIN:VCALENDAR
PRODID:-//Company//Test Project//DE
VERSION:2.0
METHOD:REQUEST
BEGIN:VEVENT
ORGANIZER:mailto:${user2.mailaddress}
ATTENDEE:mailto:${user3.mailaddress}
CATEGORIES:Test Category
DESCRIPTION:Event Description
DTEND:20110101T120000Z
DTSTART:20110101T100000Z
LAST-MODIFIED:@ignore@
LOCATION:A cool location
PRIORITY:1
SUMMARY:The summary of my test event @ignore@
@ignore@
UID:${randomNum}
END:VEVENT
END:VCALENDAR
    ]]&gt;</span>
  <span class="nt">&lt;/ws:data&gt;</span>
<span class="nt">&lt;/ws:attachment&gt;</span></code></pre></figure>

<p>So here’s the promised simple example for your lineByLineSoapAttachmentValidator:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LineByLineWithIgnoreSoapAttachmentValidator</span> <span class="kd">extends</span> <span class="n">AbstractSoapAttachmentValidator</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">IGNORE</span> <span class="o">=</span> <span class="s">"@ignore@"</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">LINE_DELIMITERS_R_N</span> <span class="o">=</span> <span class="s">"[\\r\\n]+"</span><span class="o">;</span>
  
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">validateAttachmentContent</span><span class="o">(</span><span class="n">SoapAttachment</span> <span class="n">receivedAttachment</span><span class="o">,</span> <span class="n">SoapAttachment</span> <span class="n">controlAttachment</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">String</span> <span class="n">control</span> <span class="o">=</span> <span class="n">controlAttachment</span><span class="o">.</span><span class="na">getContent</span><span class="o">().</span><span class="na">trim</span><span class="o">();</span>
      <span class="n">String</span> <span class="n">received</span> <span class="o">=</span> <span class="n">receivedAttachment</span><span class="o">.</span><span class="na">getContent</span><span class="o">().</span><span class="na">trim</span><span class="o">();</span>
      <span class="n">String</span><span class="o">[]</span> <span class="n">controlLines</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="n">LINE_DELIMITERS_R_N</span><span class="o">);</span>
      <span class="n">String</span><span class="o">[]</span> <span class="n">receivedLines</span> <span class="o">=</span> <span class="n">received</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="n">LINE_DELIMITERS_R_N</span><span class="o">);</span>
      
      <span class="c1">// Check number of properties</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">controlLines</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="n">receivedLines</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">CitrusRuntimeException</span><span class="o">(</span><span class="s">"Number of lines are not equal. Expected: "</span> <span class="o">+</span> <span class="n">controlLines</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="s">" Received: "</span> <span class="o">+</span> <span class="n">receivedLines</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
      <span class="o">}</span>
      
      <span class="c1">// Now compare the properties</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">controlLines</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">controlLine</span> <span class="o">=</span> <span class="n">controlLines</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">trim</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">receivedLine</span> <span class="o">=</span> <span class="n">receivedLines</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">trim</span><span class="o">();</span>
        
        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">endsWithIgnoreCase</span><span class="o">(</span><span class="n">controlLine</span><span class="o">,</span> <span class="n">IGNORE</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">compareBeginningOfLines</span><span class="o">(</span><span class="n">controlLine</span><span class="o">,</span> <span class="n">receivedLine</span><span class="o">);</span>
          <span class="c1">// value shall be ignored, so just continue;</span>
          <span class="k">continue</span><span class="o">;</span>
        <span class="o">}</span>
        
        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">startsWithIgnoreCase</span><span class="o">(</span><span class="n">controlLine</span><span class="o">,</span> <span class="n">IGNORE</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">compareEndingOfLines</span><span class="o">(</span><span class="n">controlLine</span><span class="o">,</span> <span class="n">receivedLine</span><span class="o">);</span>
          <span class="c1">// value shall be ignored, so just continue;</span>
          <span class="k">continue</span><span class="o">;</span>
        <span class="o">}</span>
        
        <span class="k">if</span> <span class="o">(!</span><span class="n">controlLine</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">receivedLine</span><span class="o">))</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">CitrusRuntimeException</span><span class="o">(</span><span class="s">"Lines are not equal.\n\nExpected: "</span> <span class="o">+</span> <span class="n">controlLine</span> <span class="o">+</span> <span class="s">"\n\nReceived: "</span> <span class="o">+</span> <span class="n">receivedLine</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">CitrusRuntimeException</span><span class="o">(</span><span class="s">"Validation failed!"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
  
  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">compareBeginningOfLines</span><span class="o">(</span><span class="n">String</span> <span class="n">controlLine</span><span class="o">,</span> <span class="n">String</span> <span class="n">receivedLine</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// check the beginning of the line</span>
    <span class="n">String</span> <span class="n">begin</span> <span class="o">=</span> <span class="n">controlLine</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">controlLine</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">8</span><span class="o">);</span>
    
    <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">begin</span><span class="o">)</span> <span class="o">&amp;</span><span class="n">amp</span><span class="o">;&amp;</span><span class="n">amp</span><span class="o">;</span> <span class="o">!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">startsWithIgnoreCase</span><span class="o">(</span><span class="n">receivedLine</span><span class="o">,</span> <span class="n">begin</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">CitrusRuntimeException</span><span class="o">(</span><span class="s">"Beginning of lines not equal.\n\nExpected: "</span> <span class="o">+</span> <span class="n">controlLine</span> <span class="o">+</span> <span class="s">"\n\nReceived: "</span> <span class="o">+</span> <span class="n">receivedLine</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
  
  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">compareEndingOfLines</span><span class="o">(</span><span class="n">String</span> <span class="n">controlLine</span><span class="o">,</span> <span class="n">String</span> <span class="n">receivedLine</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// check the beginning of the line</span>
    <span class="n">String</span> <span class="n">end</span> <span class="o">=</span> <span class="n">controlLine</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">8</span><span class="o">);</span>
    
    <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">end</span><span class="o">)</span> <span class="o">&amp;</span><span class="n">amp</span><span class="o">;&amp;</span><span class="n">amp</span><span class="o">;</span> <span class="o">!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">endsWithIgnoreCase</span><span class="o">(</span><span class="n">receivedLine</span><span class="o">,</span> <span class="n">end</span><span class="o">))</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">CitrusRuntimeException</span><span class="o">(</span><span class="s">"Ending of lines not equal.\n\nExpected: "</span> <span class="o">+</span> <span class="n">controlLine</span> <span class="o">+</span> <span class="s">"\n\nReceived: "</span> <span class="o">+</span> <span class="n">receivedLine</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Have fun using Citrus!</p>

<p>yvonne</p>

  </div>
</article>


  <article>
  <h2>
    Citrus and TestNG groups
    <a href="/news/2010/08/13/testng-groups/" class="permalink" title="Permalink">∞</a>
  </h2>
  <span class="post-category">
    <span class="label">
      blog
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      13 Aug 2010
    </span>
    <a href="https://github.com/christophd" class="post-author">
      
      Christoph Deppisch
    </a>
  </div>
  <div class="post-content">
    <p>TestNG groups add great flexibility to the Citrus test execution. We are able to divide all tests into several groups reaching a sophisticated seperation of concerns in our test setup. As an example I want to classify some of my functional Citrus tests as “long-running”. These tests may not apply to continuous execution every time I package my project. Instead of this I want to set up a scheduled integration build to execute those long-running tests in a time schedule.</p>

<p>We simply declare the TestNG groups in the Java part of the Citrus tests, like this:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Test</span><span class="o">(</span><span class="n">groups</span> <span class="o">=</span> <span class="o">{</span><span class="s">"functional"</span><span class="o">,</span> <span class="s">"long-running"</span><span class="o">})</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">sampleCitrusITest</span><span class="o">(</span><span class="n">ITestContext</span> <span class="n">testContext</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">executeTest</span><span class="o">(</span><span class="n">testContext</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>In Maven I can configure the TestNG groups to be included and excluded during build lifecycle. For better usability I add properties and profiles to my Maven POM, so the configuration looks like follows:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml">[...]
<span class="nt">&lt;properties&gt;</span>
    <span class="c">&lt;!-- TestNG groups (functional, performance, long-running) --&gt;</span>
    <span class="nt">&lt;testGroups&gt;</span>functional, performance<span class="nt">&lt;/testGroups&gt;</span>
    <span class="nt">&lt;testGroupsExcluded&gt;</span>long-running<span class="nt">&lt;/testGroupsExcluded&gt;</span>
<span class="nt">&lt;/properties&gt;</span>
[...]
<span class="nt">&lt;profiles&gt;</span>
    <span class="c">&lt;!-- Several profiles activating single testng groups for execution --&gt;</span>
    <span class="nt">&lt;profile&gt;</span>
      <span class="nt">&lt;id&gt;</span>all-tests<span class="nt">&lt;/id&gt;</span>
      <span class="nt">&lt;properties&gt;</span>
        <span class="nt">&lt;testGroups&gt;</span>functional, performance, long-running<span class="nt">&lt;/testGroups&gt;</span>
        <span class="nt">&lt;testGroupsExcluded&gt;&lt;/testGroupsExcluded&gt;</span>
      <span class="nt">&lt;/properties&gt;</span>
    <span class="nt">&lt;/profile&gt;</span>
    <span class="nt">&lt;profile&gt;</span>
      <span class="nt">&lt;id&gt;</span>performance<span class="nt">&lt;/id&gt;</span>
      <span class="nt">&lt;properties&gt;</span>
        <span class="nt">&lt;testGroups&gt;</span>performance<span class="nt">&lt;/testGroups&gt;</span>
      <span class="nt">&lt;/properties&gt;</span>
    <span class="nt">&lt;/profile&gt;</span>
    <span class="nt">&lt;profile&gt;</span>
      <span class="nt">&lt;id&gt;</span>long-running<span class="nt">&lt;/id&gt;</span>
      <span class="nt">&lt;properties&gt;</span>
        <span class="nt">&lt;testGroups&gt;</span>long-running<span class="nt">&lt;/testGroups&gt;</span>
        <span class="nt">&lt;testGroupsExcluded&gt;&lt;/testGroupsExcluded&gt;</span>
      <span class="nt">&lt;/properties&gt;</span>
    <span class="nt">&lt;/profile&gt;</span>
<span class="nt">&lt;/profiles&gt;</span></code></pre></figure>

<p>With this setup I am not forced to wait for the long-running tests every time I build the project locally as these test group is excluded by default. However with Maven profiles I am able to run all TestNG groups together or explicitly execute a single group:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml">mvn install (runs only short-running tests, long-running tests are excluded)
mvn install -Pfunctional,long-running (runs all tests)
mvn install -Plong-running (runs only long-running test group)</code></pre></figure>

<p>TestNG groups in combination with Maven are extremely useful to break down Citrus tests into logical units. For additional reading and other ways to execute TestNG groups without using Maven please see the official TestNG documentation.</p>

  </div>
</article>


  <article>
  <h2>
    Handle SOAP-ENV:mustUnderstand headers
    <a href="/news/2010/05/19/soap-mustunderstand/" class="permalink" title="Permalink">∞</a>
  </h2>
  <span class="post-category">
    <span class="label">
      blog
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      19 May 2010
    </span>
    <a href="https://github.com/christophd" class="post-author">
      
      Christoph Deppisch
    </a>
  </div>
  <div class="post-content">
    <p>By setting the SOAP mustUnderstand header attribute to <em>“1”</em>, you indicate that the service provider must process the SOAP header entry. In case the service provider is not able to handle this special header a SOAP fault server error is sent back to the calling client. In this post I would like to point out an easy way to support these mustUnderstand headers when simulating SOAP WebServices with Citrus.</p>

<p>This sample SOAP request header contains some mustUnderstand header entries:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;SOAP-ENV:Header</span> <span class="na">xmlns:SOAP-ENV=</span><span class="s">"http://schemas.xmlsoap.org/soap/envelope/"</span> <span class="nt">&gt;</span>
  <span class="nt">&lt;com:UserID</span> 
      <span class="na">xmlns:com=</span><span class="s">"http://www.consol.com/soap-mustunderstand"</span> 
      <span class="na">SOAP-ENV:mustUnderstand=</span><span class="s">"1"</span><span class="nt">&gt;</span>123456789<span class="nt">&lt;/com:UserID&gt;</span>
<span class="nt">&lt;/SOAP-ENV-Header&gt;</span></code></pre></figure>

<p>The service provider respectively the Citrus SOAP server simulation has to handle this UserID. Otherwise the client request can not succeed and is responded with SOAPFault.</p>

<p>Citrus uses the <a href="http://projects.spring.io/spring-ws/">SpringWS</a> project to provide SOAP WebServices endpoints for clients. In SpringWS you are able to add interceptors to the request processing chain in order to support <em>SOAP-ENV:mustUnderstand</em> headers. In this example we add the interceptors directly to the endpoint mapping in the Spring application context.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="c">&lt;!-- Special soap endpoint interceptor that accepts our must-understand headers --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"soapMustUnderstandEndpointInterceptor"</span> <span class="na">class=</span><span class="s">"com.consol.ws.sample.SimpleMustUnderstandEndpointInterceptor"</span><span class="nt">/&gt;</span></code></pre></figure>

<p>We have added a custom SimpleMustUnderstandEndpointInterceptor. Let us have a closer look at the custom endpoint interceptor implementation:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleMustUnderstandEndpointInterceptor</span> <span class="kd">implements</span> <span class="n">SoapEndpointInterceptor</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">SAMPLE_NS</span> <span class="o">=</span> <span class="s">"http://www.consol.com/soap-mustunderstand"</span><span class="o">;</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">understands</span><span class="o">(</span><span class="n">SoapHeaderElement</span> <span class="n">header</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">header</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">getNamespaceURI</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">SAMPLE_NS</span><span class="o">)</span> <span class="o">&amp;&amp;</span> 
            <span class="n">header</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">getLocalPart</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"UserID"</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="o">[...]</span>
<span class="o">}</span></code></pre></figure>

<p>SpringWS automatically raises SOAP server faults in case we do not handle a <em>SOAP-ENV:mustUnderstand</em> header in the interceptor chain. Fortunately we explicitly accept the UserID SOAP header in the interceptor implementation with the understands() method returning <em>“true”</em> in that case. With this SOAP endpoint interceptor we are able to support mustUnderstand headers in Citrus WebService endpoints.</p>

<p>Citrus also offers a default interceptor implementation which handles mustUnderstand headers with a simple configuration. Just add the interceptor to the request processing and you will not have to implement the interceptor on your own.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="c">&lt;!-- Special soap endpoint interceptor that accepts our must-understand headers --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"soapMustUnderstandEndpointInterceptor"</span> <span class="na">class=</span><span class="s">"com.consol.citrus.ws.interceptor.SoapMustUnderstandEndpointInterceptor"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"acceptedHeaders"</span><span class="nt">&gt;</span>
     <span class="nt">&lt;list&gt;</span>
         <span class="nt">&lt;value&gt;</span>{http://www.consol.com/soap-mustunderstand}UserID<span class="nt">&lt;/value&gt;</span>
     <span class="nt">&lt;/list&gt;</span>
  <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span></code></pre></figure>

  </div>
</article>


  <article>
  <h2>
    Customize meta information
    <a href="/news/2010/01/18/custom-meta-info/" class="permalink" title="Permalink">∞</a>
  </h2>
  <span class="post-category">
    <span class="label">
      blog
    </span>
  </span>
  <div class="post-meta">
    <span class="post-date">
      18 Jan 2010
    </span>
    <a href="https://github.com/christophd" class="post-author">
      
      Christoph Deppisch
    </a>
  </div>
  <div class="post-content">
    <p>Test cases in Citrus are usually provided with some meta information like the author’s name or the date of creation. This post shows how to extend on this to include your very specific meta data on your own.</p>

<p>Meta-data that comes shipped with Citrus looks like</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;testcase</span> <span class="na">name=</span><span class="s">"PwdChange_Ok_1_Test"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta-info&gt;</span>
        <span class="nt">&lt;author&gt;</span>Christoph<span class="nt">&lt;/author&gt;</span>
        <span class="nt">&lt;creationdate&gt;</span>2010-01-18<span class="nt">&lt;/creationdate&gt;</span>
        <span class="nt">&lt;status&gt;</span>FINAL<span class="nt">&lt;/status&gt;</span>
        <span class="nt">&lt;last-updated-by&gt;</span>Christoph<span class="nt">&lt;/last-updated-by&gt;</span>
        <span class="nt">&lt;last-updated-on&gt;</span>2010-01-18T15:00:00<span class="nt">&lt;/last-updated-on&gt;</span>
    <span class="nt">&lt;/meta-info&gt;</span>

    [...]
<span class="nt">&lt;/testcase&gt;</span></code></pre></figure>

<p>However there may be some additional data needed to meet your individual testing strategy. Therefore you can extend the meta-info section at the very beginning of a test case very easily. Let me use a simple example to show how it is done.</p>

<p>First of all we define our custom meta information elements in a XML schema:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;schema</span> <span class="na">xmlns=</span><span class="s">"http://www.w3.org/2001/XMLSchema"</span>  
        <span class="na">xmlns:tns=</span><span class="s">"http://www.citrusframework.org/samples/my-testcase-info"</span> 
        <span class="na">targetNamespace=</span><span class="s">"http://www.citrusframework.org/samples/my-testcase-info"</span>
        <span class="na">elementFormDefault=</span><span class="s">"qualified"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;element</span> <span class="na">name=</span><span class="s">"requirement"</span> <span class="na">type=</span><span class="s">"string"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;element</span> <span class="na">name=</span><span class="s">"pre-condition"</span> <span class="na">type=</span><span class="s">"string"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;element</span> <span class="na">name=</span><span class="s">"result"</span> <span class="na">type=</span><span class="s">"string"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;element</span> <span class="na">name=</span><span class="s">"classification"</span> <span class="na">type=</span><span class="s">"string"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/schema&gt;</span></code></pre></figure>

<p>The schema declares four simple elements (requirement, pre-condition, result and classification) all typed as string. Later we want to add those elements as children to the meta-info element in the test case. But before we can do that let us add the new xsd schema to our project. As I use a Maven project layout the schema file goes to “src/main/resources/com/consol/citrus/schemas/my-testcase-info.xsd”.</p>

<p>Next thing we need to do is to announce the new schema to Spring. A Citrus test case is nothing else but a simple Spring configuration file with customized XML schema support. Therefore Spring needs to know our XML schema while parsing the test case configuration file. So we add the spring.schemas file to following location in our project: src/main/resources/META-INF/spring.schemas</p>

<p>The file maps virtual schema locations to the actual xsd locations in our project. The file content for our example will look like follows:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml">http\://www.citrusframework.org/samples/my-testcase-info/my-testcase-info.xsd=com/consol/citrus/schemas/my-testcase-info.xsd</code></pre></figure>

<p>So now we are finally ready to use the new meta-info elements inside the test case. Note: We use a separate namespace declaration with a custom namespace prefix “custom”.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;spring:beans</span> <span class="na">xmlns=</span><span class="s">"http://www.citrusframework.org/schema/testcase"</span>
    <span class="na">xmlns:spring=</span><span class="s">"http://www.springframework.org/schema/beans"</span> 
    <span class="na">xmlns:custom=</span><span class="s">"http://www.citrusframework.org/samples/my-testcase-info"</span>
    <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans 
http://www.springframework.org/schema/beans/spring-beans.xsd
http://www.citrusframework.org/schema/testcase 
http://www.citrusframework.org/schema/testcase/citrus-testcase.xsd 
http://www.citrusframework.org/samples/my-testcase-info 
http://www.citrusframework.org/samples/my-testcase-info/my-testcase-info.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;testcase</span> <span class="na">name=</span><span class="s">"PwdChange_Ok_1_Test"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;meta-info&gt;</span>
            <span class="nt">&lt;author&gt;</span>Christoph<span class="nt">&lt;/author&gt;</span>
            <span class="nt">&lt;creationdate&gt;</span>2010-01-18<span class="nt">&lt;/creationdate&gt;</span>
            <span class="nt">&lt;status&gt;</span>FINAL<span class="nt">&lt;/status&gt;</span>
            <span class="nt">&lt;last-updated-by&gt;</span>Christoph<span class="nt">&lt;/last-updated-by&gt;</span>
            <span class="nt">&lt;last-updated-on&gt;</span>2010-01-18T15:00:00<span class="nt">&lt;/last-updated-on&gt;</span>
            <span class="nt">&lt;custom:requirement&gt;</span>REQ10001<span class="nt">&lt;/custom:requirement&gt;</span>
            <span class="nt">&lt;custom:pre-condition&gt;</span>Existing user, sufficient rights<span class="nt">&lt;/custom:pre-condition&gt;</span>
            <span class="nt">&lt;custom:result&gt;</span>Password reset in database<span class="nt">&lt;/custom:result&gt;</span>
            <span class="nt">&lt;custom:classification&gt;</span>PasswordChange<span class="nt">&lt;/custom:classification&gt;</span>
        <span class="nt">&lt;/meta-info&gt;</span>

        [...]
    <span class="nt">&lt;/testcase&gt;</span>
<span class="nt">&lt;/spring:beans&gt;</span></code></pre></figure>

<p>As you see it is quite easy to add custom meta information to your Citrus test case. The customized elements may be precious for automatic reporting. XSL transformations for instance are able to read those meta information elements in order to generate automatic test reports and documentation.</p>

<p>You can also declare our new XML schema in the Eclipse preferences section as user specific XML catalog entry. Then even the schema code completion in your Eclipse XML editor will be available for our customized meta-info elements.</p>

  </div>
</article>


      </div>

      <div class="unit one-fifth hide-on-mobiles">
  <aside>
    <h4>Overview</h4>
    <ul>
      <li class="current">
        <a href="/news/">All News</a>
      </li>
      <li class="">
        <a href="/docs/history/">All Releases</a>
      </li>
      <li>
        <a href="http://citrus.895196.n3.nabble.com/" target="_blank">Forum</a>
      </li>
    </ul>
    <h4>Posts</h4>
    <ul>
        
        <li class="">
          <a href="/news/2021/08/30/introducing-yaks/">» YAKS BDD testing</a>
        </li>
        
        <li class="">
          <a href="/news/2021/08/25/new-camel-support/">» Citrus and Apache Camel</a>
        </li>
        
        <li class="">
          <a href="/news/2021/08/16/citrus-3.0/">» Citrus 3.0</a>
        </li>
        
        <li class="">
          <a href="/news/2018/09/19/upcoming-changes/">» Future of Citrus</a>
        </li>
        
        <li class="">
          <a href="/news/2017/09/21/introducing-citrus-simulator/">» Citrus Simulator</a>
        </li>
        
        <li class="">
          <a href="/news/2017/07/07/introducing-citrus-admin/">» Admin UI</a>
        </li>
        
        <li class="">
          <a href="/news/2016/03/15/jcache-chat-citrus/">» Testing WebSockets</a>
        </li>
        
        <li class="">
          <a href="/news/2015/08/19/arquillian-extension-part-2/">» Arquillian &amp; Citrus II</a>
        </li>
        
        <li class="">
          <a href="/news/2015/06/29/arquillian-extension-part-1/">» Arquillian &amp; Citrus I</a>
        </li>
        
        <li class="">
          <a href="/news/2015/06/03/camel-testing-part-3/">» Apache Camel III</a>
        </li>
        
        <li class="">
          <a href="/news/2015/05/27/camel-testing-part-2/">» Apache Camel II</a>
        </li>
        
        <li class="">
          <a href="/news/2014/11/21/camel-testing-part-1/">» Apache Camel I</a>
        </li>
        
        <li class="">
          <a href="/news/2014/05/30/testing-webmethods-with-citrus-part-ii/">» Testing webMethods II</a>
        </li>
        
        <li class="">
          <a href="/news/2014/03/06/testing-webmethods-with-citrus-part-i/">» Testing webMethods I</a>
        </li>
        
        <li class="">
          <a href="/news/2011/06/22/excel-validation/">» Validate Excel files</a>
        </li>
        
        <li class="">
          <a href="/news/2011/06/17/testng-data-provider/">» TestNG data providers</a>
        </li>
        
        <li class="">
          <a href="/news/2010/12/14/integrate-your-own-validator/">» Integrate your own validator</a>
        </li>
        
        <li class="">
          <a href="/news/2010/08/13/testng-groups/">» TestNG groups</a>
        </li>
        
        <li class="">
          <a href="/news/2010/05/19/soap-mustunderstand/">» SOAP-ENV:mustUnderstand</a>
        </li>
        
        <li class="">
          <a href="/news/2010/01/18/custom-meta-info/">» Custom meta info</a>
        </li>
        
    </ul>
  </aside>
</div>


      <div class="clear"></div>

    </div>
  </section>


  <footer role="contentinfo">
  <div class="grid">
    <div class="unit one-third center-on-mobiles">
      <p>Citrus is open source and licensed under <br><a href="https://www.apache.org/licenses/LICENSE-2.0.html">Apache License 2.0</a>.</p>
      <p>This website is licensed under <br><a href="https://github.com/citrusframework/citrus/blob/master/LICENSE">MIT License</a>.</p>
      <br>
      <p>© 2022 ConSol Software GmbH</p>
    </div>
    <div class="unit one-third align-center center-on-mobiles">
      <p>
        <img src="/img/bmi_logo_eng.png" alt="Federal Ministry for Economic Affairs and Energy">
      </p>
    </div>
    <div class="unit one-third align-right center-on-mobiles">
      <p>
        Hosted by<br>
        <a href="http://www.consol.de">
          <img src="/img/sponsor-logo.png" alt="ConSol">
        </a>
      </p>
      <p> </p>
      <br>
      <br>
      <p>
        <a href="http://www.consol.com/legal-notice/">Legal notice</a> | <a href="https://www.consol.com/data-privacy/">Data privacy</a>
      </p>
    </div>
  </div>
</footer>

  <script>
  var anchorForId = function (id) {
    var anchor = document.createElement("a");
    anchor.className = "header-link";
    anchor.href      = "#" + id;
    anchor.innerHTML = "<span class=\"sr-only\">Permalink</span><i class=\"fa fa-link\"></i>";
    anchor.title = "Permalink";
    return anchor;
  };

  var linkifyAnchors = function (level, containingElement) {
    var headers = containingElement.getElementsByTagName("h" + level);
    for (var h = 0; h < headers.length; h++) {
      var header = headers[h];

      if (typeof header.id !== "undefined" && header.id !== "") {
        header.appendChild(anchorForId(header.id));
      }
    }
  };

  document.onreadystatechange = function () {
    if (this.readyState === "complete") {
      var contentBlock = document.getElementsByClassName("docs")[0] || document.getElementsByClassName("samples")[0] || document.getElementsByClassName("news")[0];
      if (!contentBlock) {
        return;
      }
      for (var level = 1; level <= 6; level++) {
        linkifyAnchors(level, contentBlock);
      }
    }
  };
</script>


</body>
</html>
